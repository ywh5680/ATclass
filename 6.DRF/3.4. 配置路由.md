## 配置路由

路由配置是 Django REST Framework 中连接 URL 和视图的重要环节。DRF 提供了灵活的路由系统，支持传统的 URL 配置和自动路由生成。本章将详细介绍如何配置各种类型的路由。

### 基础路由配置

#### 1. 传统 URL 配置

```python
# blog/urls.py
from django.urls import path
from . import views

app_name = 'blog'

urlpatterns = [
    # APIView 路由
    path('articles/', views.ArticleListAPIView.as_view(), name='article-list'),
    path('articles/<int:pk>/', views.ArticleDetailAPIView.as_view(), name='article-detail'),
    
    # 通用视图路由
    path('articles/list/', views.ArticleListView.as_view(), name='article-list-view'),
    path('articles/create/', views.ArticleCreateView.as_view(), name='article-create'),
    path('articles/<int:pk>/detail/', views.ArticleDetailView.as_view(), name='article-detail-view'),
    path('articles/<int:pk>/update/', views.ArticleUpdateView.as_view(), name='article-update'),
    path('articles/<int:pk>/delete/', views.ArticleDeleteView.as_view(), name='article-delete'),
    
    # 组合视图路由
    path('articles/list-create/', views.ArticleListCreateView.as_view(), name='article-list-create'),
    path('articles/<int:pk>/retrieve-update/', views.ArticleRetrieveUpdateView.as_view(), name='article-retrieve-update'),
    path('articles/<int:pk>/retrieve-update-destroy/', views.ArticleRetrieveUpdateDestroyView.as_view(), name='article-retrieve-update-destroy'),
    
    # 分类路由
    path('categories/', views.CategoryListAPIView.as_view(), name='category-list'),
    path('categories/<int:pk>/', views.CategoryDetailAPIView.as_view(), name='category-detail'),
]

# 主项目 URL 配置
# drf_project/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/blog/', include('blog.urls')),
    path('api/users/', include('users.urls')),
    path('api-auth/', include('rest_framework.urls')),
]
```

#### 2. 使用 DefaultRouter

DefaultRouter 是 DRF 中最常用的路由器，它为 ViewSet 自动生成标准的 REST 路由：

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

# 创建路由器
router = DefaultRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')
router.register(r'categories', views.CategoryViewSet, basename='category')

app_name = 'blog'

urlpatterns = [
    # 包含路由器生成的 URL
    path('', include(router.urls)),
    
    # 额外的自定义路由
    path('articles/<int:pk>/comments/', views.ArticleCommentsView.as_view(), name='article-comments'),
    path('articles/<int:pk>/like/', views.ArticleLikeView.as_view(), name='article-like'),
]
```

#### 3. 使用 SimpleRouter

SimpleRouter 是 DefaultRouter 的简化版本，不包含可浏览的 API 界面：

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import SimpleRouter
from . import views

# 创建路由器
router = SimpleRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')
router.register(r'categories', views.CategoryViewSet, basename='category')

app_name = 'blog'

urlpatterns = [
    path('', include(router.urls)),
]
```

### 高级路由配置

#### 1. 自定义路由器

```python
# routers.py
from rest_framework.routers import DefaultRouter
from rest_framework.routers import Route, DynamicRoute

class CustomRouter(DefaultRouter):
    """自定义路由器"""
    
    routes = [
        # 列表路由
        Route(
            url=r'^{prefix}{trailing_slash}$',
            mapping={
                'get': 'list',
                'post': 'create',
                'put': 'bulk_update',
                'patch': 'bulk_partial_update',
                'delete': 'bulk_destroy',
            },
            name='{basename}-list',
            detail=False,
            initkwargs={'suffix': 'List'}
        ),
        # 详情路由
        Route(
            url=r'^{prefix}/{lookup}{trailing_slash}$',
            mapping={
                'get': 'retrieve',
                'put': 'update',
                'patch': 'partial_update',
                'delete': 'destroy',
            },
            name='{basename}-detail',
            detail=True,
            initkwargs={'suffix': 'Instance'}
        ),
        # 动态路由
        DynamicRoute(
            url=r'^{prefix}/{lookup}/{url_path}{trailing_slash}$',
            name='{basename}-{url_name}',
            detail=True,
            initkwargs={}
        ),
    ]

# 使用自定义路由器
router = CustomRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')
```

#### 2. 嵌套路由

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from rest_framework_nested import routers
from . import views

# 创建主路由器
router = DefaultRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')
router.register(r'categories', views.CategoryViewSet, basename='category')

# 创建嵌套路由器
articles_router = routers.NestedDefaultRouter(router, r'articles', lookup='article')
articles_router.register(r'comments', views.CommentViewSet, basename='article-comments')

categories_router = routers.NestedDefaultRouter(router, r'categories', lookup='category')
categories_router.register(r'articles', views.CategoryArticleViewSet, basename='category-articles')

app_name = 'blog'

urlpatterns = [
    path('', include(router.urls)),
    path('', include(articles_router.urls)),
    path('', include(categories_router.urls)),
]

# 对应的 ViewSet
class CommentViewSet(viewsets.ModelViewSet):
    """评论视图集"""
    serializer_class = CommentSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        """获取查询集"""
        return Comment.objects.filter(article_id=self.kwargs['article_pk'])

class CategoryArticleViewSet(viewsets.ReadOnlyModelViewSet):
    """分类文章视图集"""
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        """获取查询集"""
        return Article.objects.filter(category_id=self.kwargs['category_pk'])
```

#### 3. 版本控制路由

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

# 创建路由器
router = DefaultRouter()

# 注册不同版本的视图集
router.register(r'v1/articles', views.ArticleViewSetV1, basename='article-v1')
router.register(r'v2/articles', views.ArticleViewSetV2, basename='article-v2')

app_name = 'blog'

urlpatterns = [
    path('api/', include(router.urls)),
]

# 主项目 URL 配置
# drf_project/urls.py
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('blog.urls')),
    path('api-auth/', include('rest_framework.urls')),
]
```

### 路由命名和反向解析

#### 1. 基本命名

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')
router.register(r'categories', views.CategoryViewSet, basename='category')

app_name = 'blog'

urlpatterns = [
    path('', include(router.urls)),
]

# 在视图中使用反向解析
from django.urls import reverse
from rest_framework.response import Response

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    
    def create(self, request, *args, **kwargs):
        """创建文章"""
        response = super().create(request, *args, **kwargs)
        
        # 添加相关链接
        article_id = response.data['id']
        response.data['url'] = reverse('blog:article-detail', args=[article_id])
        response.data['comments_url'] = reverse('blog:article-comments', args=[article_id])
        
        return response
```

#### 2. 在序列化器中使用

```python
# serializers.py
from rest_framework import serializers
from django.urls import reverse

class ArticleSerializer(serializers.ModelSerializer):
    """文章序列化器"""
    url = serializers.SerializerMethodField()
    comments_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Article
        fields = ['id', 'title', 'content', 'url', 'comments_url']
    
    def get_url(self, obj):
        """获取文章详情URL"""
        request = self.context.get('request')
        if request:
            return request.build_absolute_uri(
                reverse('blog:article-detail', args=[obj.id])
            )
        return reverse('blog:article-detail', args=[obj.id])
    
    def get_comments_url(self, obj):
        """获取文章评论URL"""
        request = self.context.get('request')
        if request:
            return request.build_absolute_uri(
                reverse('blog:article-comments', args=[obj.id])
            )
        return reverse('blog:article-comments', args=[obj.id])
```

### 路由参数和查询参数

#### 1. 路径参数

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')

app_name = 'blog'

urlpatterns = [
    path('', include(router.urls)),
    # 自定义路径参数
    path('articles/<slug:slug>/', views.ArticleBySlugView.as_view(), name='article-by-slug'),
    path('categories/<slug:slug>/articles/', views.CategoryArticlesView.as_view(), name='category-articles'),
]

# 对应的视图
class ArticleBySlugView(APIView):
    """根据 slug 获取文章"""
    def get(self, request, slug):
        article = get_object_or_404(Article, slug=slug)
        serializer = ArticleSerializer(article)
        return Response(serializer.data)

class CategoryArticlesView(APIView):
    """获取分类下的文章"""
    def get(self, request, slug):
        category = get_object_or_404(Category, slug=slug)
        articles = category.articles.filter(status='published')
        serializer = ArticleSerializer(articles, many=True)
        return Response(serializer.data)
```

#### 2. 查询参数处理

```python
class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    
    def get_queryset(self):
        """处理查询参数"""
        queryset = super().get_queryset()
        
        # 获取查询参数
        category = self.request.query_params.get('category', None)
        author = self.request.query_params.get('author', None)
        status = self.request.query_params.get('status', None)
        search = self.request.query_params.get('search', None)
        
        # 应用过滤
        if category:
            queryset = queryset.filter(category__name=category)
        
        if author:
            queryset = queryset.filter(author__username=author)
        
        if status:
            queryset = queryset.filter(status=status)
        
        if search:
            queryset = queryset.filter(
                Q(title__icontains=search) | 
                Q(content__icontains=search)
            )
        
        return queryset
```

### 路由权限和认证

#### 1. 全局权限配置

```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.TokenAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticatedOrReadOnly',
    ],
}

# urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'articles', views.ArticleViewSet, basename='article')

urlpatterns = [
    path('api/', include(router.urls)),
    path('api-auth/', include('rest_framework.urls')),
]
```

#### 2. 视图级权限

```python
class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    
    def get_permissions(self):
        """根据操作类型设置权限"""
        if self.action == 'create':
            permission_classes = [IsAuthenticated]
        elif self.action in ['update', 'partial_update', 'destroy']:
            permission_classes = [IsAuthenticated, IsAuthorOrReadOnly]
        else:
            permission_classes = [IsAuthenticatedOrReadOnly]
        
        return [permission() for permission in permission_classes]
```

### 路由文档和测试

#### 1. API 文档路由

```python
# urls.py
from drf_yasg.views import get_schema_view
from drf_yasg import openapi
from rest_framework import permissions

schema_view = get_schema_view(
    openapi.Info(
        title="Blog API",
        default_version='v1',
        description="博客系统的 API 文档",
        terms_of_service="https://www.example.com/terms/",
        contact=openapi.Contact(email="contact@example.com"),
        license=openapi.License(name="BSD License"),
    ),
    public=True,
    permission_classes=[permissions.AllowAny],
)

urlpatterns = [
    # API 路由
    path('api/', include(router.urls)),
    
    # 文档路由
    re_path(r'^swagger(?P<format>\.json|\.yaml)$', 
            schema_view.without_ui(cache_timeout=0), name='schema-json'),
    re_path(r'^swagger/$', schema_view.with_ui('swagger', cache_timeout=0), 
            name='schema-swagger-ui'),
    re_path(r'^redoc/$', schema_view.with_ui('redoc', cache_timeout=0), 
            name='schema-redoc'),
]
```

#### 2. 测试路由

```python
# tests.py
from django.test import TestCase
from django.urls import reverse
from rest_framework.test import APITestCase
from rest_framework import status

class ArticleURLTestCase(APITestCase):
    def test_article_list_url(self):
        """测试文章列表URL"""
        url = reverse('blog:article-list')
        response = self.client.get(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
    
    def test_article_detail_url(self):
        """测试文章详情URL"""
        article = Article.objects.create(
            title='测试文章',
            content='测试内容',
            author=self.user
        )
        url = reverse('blog:article-detail', args=[article.id])
        response = self.client.get(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
    
    def test_article_like_url(self):
        """测试文章点赞URL"""
        article = Article.objects.create(
            title='测试文章',
            content='测试内容',
            author=self.user
        )
        url = reverse('blog:article-like', args=[article.id])
        response = self.client.post(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
```

### 路由最佳实践

#### 1. 路由组织

```python
# blog/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

# 创建路由器
router = DefaultRouter()

# 注册视图集
router.register(r'articles', views.ArticleViewSet, basename='article')
router.register(r'categories', views.CategoryViewSet, basename='category')
router.register(r'tags', views.TagViewSet, basename='tag')
router.register(r'comments', views.CommentViewSet, basename='comment')

app_name = 'blog'

urlpatterns = [
    # 包含路由器生成的 URL
    path('', include(router.urls)),
    
    # 自定义路由
    path('articles/<slug:slug>/', views.ArticleBySlugView.as_view(), name='article-by-slug'),
    path('articles/<int:pk>/publish/', views.ArticlePublishView.as_view(), name='article-publish'),
    path('articles/<int:pk>/archive/', views.ArticleArchiveView.as_view(), name='article-archive'),
    
    # 统计路由
    path('stats/articles/', views.ArticleStatsView.as_view(), name='article-stats'),
    path('stats/categories/', views.CategoryStatsView.as_view(), name='category-stats'),
]

# 主项目 URL 配置
# drf_project/urls.py
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/v1/', include('blog.urls')),
    path('api/v1/users/', include('users.urls')),
    path('api-auth/', include('rest_framework.urls')),
]

# 开发环境静态文件
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

#### 2. 路由版本控制

```python
# urls.py
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    
    # API 版本控制
    path('api/v1/', include('blog.urls')),
    path('api/v2/', include('blog.v2.urls')),
    
    # 认证相关
    path('api-auth/', include('rest_framework.urls')),
    path('auth/', include('rest_framework_simplejwt.urls')),
]

# blog/v2/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'articles', views.ArticleViewSetV2, basename='article-v2')

urlpatterns = [
    path('', include(router.urls)),
]
```

### 总结

通过本章的学习，你应该掌握了：

1. **基础路由配置**：传统 URL 配置和路由器使用
2. **高级路由配置**：自定义路由器、嵌套路由、版本控制
3. **路由命名和反向解析**：在视图和序列化器中使用
4. **路由参数处理**：路径参数和查询参数
5. **路由权限和认证**：全局和视图级权限配置
6. **路由文档和测试**：API 文档和路由测试
7. **路由最佳实践**：路由组织和版本控制

路由配置是 DRF 中连接前端和后端的重要环节。在下一章中，我们将学习 DRF 的核心概念，深入理解序列化器、视图和请求响应的机制。 