## 安装与配置

在开始使用 Django REST Framework 之前，需要正确安装和配置相关环境。本章将详细介绍 DRF 的安装过程和基本配置。

### 环境要求

#### 1. Python 版本

DRF 支持以下 Python 版本：
- Python 3.7+
- Python 3.8+（推荐）
- Python 3.9+
- Python 3.10+
- Python 3.11+

```bash
# 检查 Python 版本
python --version
# 或
python3 --version
```

#### 2. Django 版本

DRF 与 Django 版本兼容性：

| DRF 版本 | Django 版本 | Python 版本 |
|----------|-------------|-------------|
| 3.14.x   | 3.2, 4.0, 4.1, 4.2 | 3.7+ |
| 3.13.x   | 3.2, 4.0, 4.1 | 3.7+ |
| 3.12.x   | 3.2, 4.0 | 3.7+ |

### 安装 DRF

#### 1. 使用 pip 安装

```bash
# 安装最新版本
pip install djangorestframework

# 安装特定版本
pip install djangorestframework==3.14.0

# 安装开发版本
pip install djangorestframework --pre
```

#### 2. 使用 requirements.txt

```txt
# requirements.txt
Django>=4.0,<5.0
djangorestframework>=3.14.0
django-cors-headers>=4.0.0
django-filter>=23.0
drf-yasg>=1.21.0
```

```bash
# 安装依赖
pip install -r requirements.txt
```

#### 3. 使用虚拟环境（推荐）

```bash
# 创建虚拟环境
python -m venv drf_env

# 激活虚拟环境
# Windows
drf_env\Scripts\activate

# macOS/Linux
source drf_env/bin/activate

# 安装 DRF
pip install djangorestframework
```

### 项目配置

#### 1. 添加 DRF 到 INSTALLED_APPS

```python
# settings.py
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # 第三方应用
    'rest_framework',
    'corsheaders',
    'django_filters',
    
    # 自定义应用
    'blog',
    'users',
]
```

#### 2. 配置 DRF 设置

```python
# settings.py
REST_FRAMEWORK = {
    # 默认分页类
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10,
    
    # 默认认证类
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.TokenAuthentication',
    ],
    
    # 默认权限类
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticatedOrReadOnly',
    ],
    
    # 默认渲染器
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
        'rest_framework.renderers.BrowsableAPIRenderer',
    ],
    
    # 默认解析器
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.FormParser',
        'rest_framework.parsers.MultiPartParser',
    ],
    
    # 默认过滤器后端
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
    
    # 默认限流
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/day',
        'user': '1000/day',
    },
    
    # 版本控制
    'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.NamespaceVersioning',
    'DEFAULT_VERSION': 'v1',
    'ALLOWED_VERSIONS': ['v1', 'v2'],
    
    # 异常处理
    'EXCEPTION_HANDLER': 'rest_framework.views.exception_handler',
    
    # 测试设置
    'TEST_REQUEST_DEFAULT_FORMAT': 'json',
}
```

#### 3. 配置 CORS（跨域资源共享）

```python
# settings.py
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # 必须在 CommonMiddleware 之前
    'django.middleware.common.CommonMiddleware',
    # ... 其他中间件
]

# CORS 设置
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "https://example.com",
]

CORS_ALLOW_CREDENTIALS = True

CORS_ALLOW_METHODS = [
    'DELETE',
    'GET',
    'OPTIONS',
    'PATCH',
    'POST',
    'PUT',
]

CORS_ALLOW_HEADERS = [
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
]
```

#### 4. 配置数据库

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 生产环境使用 PostgreSQL
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'drf_project',
#         'USER': 'postgres',
#         'PASSWORD': 'password',
#         'HOST': 'localhost',
#         'PORT': '5432',
#     }
# }
```

### 创建项目结构

#### 1. 创建 Django 项目

```bash
# 创建项目
django-admin startproject drf_project
cd drf_project

# 创建应用
python manage.py startapp blog
python manage.py startapp users
```

#### 2. 项目目录结构

```
drf_project/
├── drf_project/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── blog/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── serializers.py
│   ├── views.py
│   ├── urls.py
│   └── tests.py
├── users/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── serializers.py
│   ├── views.py
│   ├── urls.py
│   └── tests.py
├── manage.py
└── requirements.txt
```

#### 3. 配置主 URL

```python
# drf_project/urls.py
from django.contrib import admin
from django.urls import path, include
from rest_framework.documentation import include_docs_urls

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('blog.urls')),
    path('api/users/', include('users.urls')),
    path('api-auth/', include('rest_framework.urls')),
    path('docs/', include_docs_urls(title='DRF API Documentation')),
]
```

### 开发工具配置

#### 1. 安装开发依赖

```bash
# 安装开发工具
pip install ipython
pip install django-debug-toolbar
pip install django-extensions

# 安装测试工具
pip install pytest
pip install pytest-django
pip install factory-boy

# 安装代码质量工具
pip install flake8
pip install black
pip install isort
```

#### 2. 配置开发设置

```python
# settings/dev.py
from .base import *

DEBUG = True

# 开发环境允许所有主机
ALLOWED_HOSTS = ['*']

# 开发环境 CORS 设置
CORS_ALLOW_ALL_ORIGINS = True

# 开发环境数据库
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 开发环境日志
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
}

# 开发环境 DRF 设置
REST_FRAMEWORK = {
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
        'rest_framework.renderers.BrowsableAPIRenderer',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10,
}
```

#### 3. 配置 Django Debug Toolbar

```python
# settings/dev.py
INSTALLED_APPS += [
    'debug_toolbar',
]

MIDDLEWARE += [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
]

INTERNAL_IPS = [
    '127.0.0.1',
]

# Debug Toolbar 配置
DEBUG_TOOLBAR_CONFIG = {
    'SHOW_TOOLBAR_CALLBACK': lambda request: DEBUG,
}
```

### 生产环境配置

#### 1. 生产环境设置

```python
# settings/production.py
from .base import *

DEBUG = False

# 生产环境安全设置
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# 生产环境数据库
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST'),
        'PORT': os.environ.get('DB_PORT', '5432'),
    }
}

# 生产环境 DRF 设置
REST_FRAMEWORK = {
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',
        'user': '1000/hour',
    },
}
```

#### 2. 环境变量配置

```bash
# .env
DEBUG=False
SECRET_KEY=your-secret-key-here
DB_NAME=drf_project
DB_USER=postgres
DB_PASSWORD=your-password
DB_HOST=localhost
DB_PORT=5432
```

```python
# settings/base.py
import os
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.environ.get('SECRET_KEY')
DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'
```

### 验证安装

#### 1. 运行迁移

```bash
# 创建迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate
```

#### 2. 创建超级用户

```bash
python manage.py createsuperuser
```

#### 3. 运行开发服务器

```bash
python manage.py runserver
```

#### 4. 测试 API

访问以下 URL 验证安装：

- http://127.0.0.1:8000/admin/ - Django 管理后台
- http://127.0.0.1:8000/api-auth/ - DRF 登录页面
- http://127.0.0.1:8000/docs/ - API 文档（如果安装了 drf-yasg）

### 常见问题解决

#### 1. 导入错误

```python
# 确保正确导入
from rest_framework import serializers, viewsets
from rest_framework.response import Response
from rest_framework import status
```

#### 2. 权限错误

```python
# 检查权限设置
REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',  # 开发环境
    ],
}
```

#### 3. CORS 错误

```python
# 确保 CORS 中间件顺序正确
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # 必须在 CommonMiddleware 之前
    'django.middleware.common.CommonMiddleware',
    # ...
]
```

### 总结

通过以上步骤，你已经成功安装和配置了 Django REST Framework。配置包括：

1. **环境准备**：Python 和 Django 版本要求
2. **安装 DRF**：使用 pip 安装最新版本
3. **项目配置**：添加 DRF 到 Django 项目
4. **开发工具**：配置开发环境和调试工具
5. **生产环境**：配置生产环境的安全设置
6. **验证安装**：运行服务器并测试功能

接下来，你可以开始创建模型、序列化器和视图，构建你的第一个 DRF API。 