## 视图 (Views)

视图是 Django REST Framework 中处理 HTTP 请求和响应的核心组件。DRF 提供了多种视图类，从基础的 APIView 到高级的 ViewSet，每种都有其特定的用途和优势。本章将深入探讨视图的各种高级特性和用法。

### 视图基础

#### 1. APIView

APIView 是 DRF 中最基础的视图类，它继承自 Django 的 View 类：

```python
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated, IsAuthenticatedOrReadOnly
from django.shortcuts import get_object_or_404
from .models import Article, Category
from .serializers import ArticleSerializer, CategorySerializer

class ArticleListAPIView(APIView):
    """文章列表视图"""
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get(self, request):
        """获取文章列表"""
        articles = Article.objects.filter(status='published')
        serializer = ArticleSerializer(articles, many=True)
        return Response(serializer.data)
    
    def post(self, request):
        """创建新文章"""
        serializer = ArticleSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save(author=request.user)
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class ArticleDetailAPIView(APIView):
    """文章详情视图"""
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_object(self, pk):
        """获取文章对象"""
        return get_object_or_404(Article, pk=pk)
    
    def get(self, request, pk):
        """获取文章详情"""
        article = self.get_object(pk)
        serializer = ArticleSerializer(article)
        return Response(serializer.data)
    
    def put(self, request, pk):
        """更新文章"""
        article = self.get_object(pk)
        serializer = ArticleSerializer(article, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
    def delete(self, request, pk):
        """删除文章"""
        article = self.get_object(pk)
        article.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)
```

#### 2. GenericAPIView

GenericAPIView 是 APIView 的扩展，提供了更多通用功能：

```python
from rest_framework.generics import GenericAPIView
from rest_framework.mixins import ListModelMixin, CreateModelMixin

class ArticleListGenericView(GenericAPIView, ListModelMixin, CreateModelMixin):
    """文章列表通用视图"""
    queryset = Article.objects.filter(status='published')
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get(self, request, *args, **kwargs):
        """获取文章列表"""
        return self.list(request, *args, **kwargs)
    
    def post(self, request, *args, **kwargs):
        """创建新文章"""
        return self.create(request, *args, **kwargs)
    
    def perform_create(self, serializer):
        """执行创建操作"""
        serializer.save(author=self.request.user)
```

### 通用视图

#### 1. 列表和创建视图

```python
from rest_framework.generics import (
    ListAPIView, CreateAPIView, ListCreateAPIView
)

class ArticleListView(ListAPIView):
    """文章列表视图"""
    queryset = Article.objects.filter(status='published')
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        """获取查询集"""
        queryset = super().get_queryset()
        
        # 按分类过滤
        category = self.request.query_params.get('category', None)
        if category:
            queryset = queryset.filter(category__name=category)
        
        # 按作者过滤
        author = self.request.query_params.get('author', None)
        if author:
            queryset = queryset.filter(author__username=author)
        
        return queryset

class ArticleCreateView(CreateAPIView):
    """文章创建视图"""
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticated]
    
    def perform_create(self, serializer):
        """执行创建操作"""
        serializer.save(author=self.request.user)

class ArticleListCreateView(ListCreateAPIView):
    """文章列表创建视图"""
    queryset = Article.objects.filter(status='published')
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def perform_create(self, serializer):
        serializer.save(author=self.request.user)
```

#### 2. 详情视图

```python
from rest_framework.generics import (
    RetrieveAPIView, UpdateAPIView, DestroyAPIView,
    RetrieveUpdateAPIView, RetrieveUpdateDestroyAPIView
)

class ArticleDetailView(RetrieveAPIView):
    """文章详情视图"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_object(self):
        """获取对象并增加浏览次数"""
        obj = super().get_object()
        obj.increase_views()
        return obj

class ArticleUpdateView(UpdateAPIView):
    """文章更新视图"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticated]

class ArticleDeleteView(DestroyAPIView):
    """文章删除视图"""
    queryset = Article.objects.all()
    permission_classes = [IsAuthenticated]

class ArticleRetrieveUpdateView(RetrieveUpdateAPIView):
    """文章详情更新视图"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]

class ArticleRetrieveUpdateDestroyView(RetrieveUpdateDestroyAPIView):
    """文章详情更新删除视图"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
```

### 视图集

#### 1. ModelViewSet

ModelViewSet 是最常用的视图集，它提供了完整的 CRUD 操作：

```python
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        """获取查询集"""
        queryset = Article.objects.all()
        
        # 过滤已发布的文章
        if self.action == 'list':
            queryset = queryset.filter(status='published')
        
        # 按分类过滤
        category = self.request.query_params.get('category', None)
        if category:
            queryset = queryset.filter(category__name=category)
        
        # 按作者过滤
        author = self.request.query_params.get('author', None)
        if author:
            queryset = queryset.filter(author__username=author)
        
        return queryset
    
    def get_serializer_class(self):
        """根据操作类型返回不同的序列化器"""
        if self.action == 'list':
            return ArticleListSerializer
        elif self.action == 'create':
            return ArticleCreateSerializer
        return ArticleDetailSerializer
    
    def perform_create(self, serializer):
        """执行创建操作"""
        serializer.save(author=self.request.user)
    
    def perform_update(self, serializer):
        """执行更新操作"""
        serializer.save()
    
    @action(detail=True, methods=['post'])
    def like(self, request, pk=None):
        """点赞文章"""
        article = self.get_object()
        article.increase_likes()
        return Response({'status': 'liked'})
    
    @action(detail=True, methods=['post'])
    def unlike(self, request, pk=None):
        """取消点赞"""
        article = self.get_object()
        article.likes_count = max(0, article.likes_count - 1)
        article.save()
        return Response({'status': 'unliked'})
    
    @action(detail=False, methods=['get'])
    def featured(self, request):
        """获取推荐文章"""
        articles = self.get_queryset().filter(is_featured=True)
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def my_articles(self, request):
        """获取我的文章"""
        articles = self.get_queryset().filter(author=request.user)
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
```

#### 2. ReadOnlyModelViewSet

ReadOnlyModelViewSet 只提供读取操作：

```python
class CategoryReadOnlyViewSet(viewsets.ReadOnlyModelViewSet):
    """分类只读视图集"""
    queryset = Category.objects.all()
    serializer_class = CategorySerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    @action(detail=True, methods=['get'])
    def articles(self, request, pk=None):
        """获取分类下的文章"""
        category = self.get_object()
        articles = category.articles.filter(status='published')
        serializer = ArticleSerializer(articles, many=True)
        return Response(serializer.data)
```

#### 3. 自定义视图集

```python
from rest_framework import mixins

class ArticleCustomViewSet(
    mixins.ListModelMixin,
    mixins.CreateModelMixin,
    mixins.RetrieveModelMixin,
    mixins.UpdateModelMixin,
    viewsets.GenericViewSet
):
    """自定义文章视图集（不包含删除功能）"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def perform_create(self, serializer):
        serializer.save(author=self.request.user)
    
    @action(detail=True, methods=['post'])
    def publish(self, request, pk=None):
        """发布文章"""
        article = self.get_object()
        article.status = 'published'
        article.save()
        return Response({'status': 'published'})
    
    @action(detail=True, methods=['post'])
    def archive(self, request, pk=None):
        """归档文章"""
        article = self.get_object()
        article.status = 'archived'
        article.save()
        return Response({'status': 'archived'})
```

### 高级视图功能

#### 1. 过滤和搜索

```python
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    # 过滤器后端
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['category', 'author', 'status', 'is_featured']
    search_fields = ['title', 'content', 'excerpt']
    ordering_fields = ['created_at', 'updated_at', 'views_count', 'likes_count']
    ordering = ['-created_at']
    
    def get_queryset(self):
        """获取查询集"""
        queryset = super().get_queryset()
        
        # 自定义过滤
        if self.action == 'list':
            queryset = queryset.filter(status='published')
        
        return queryset
```

#### 2. 分页

```python
from rest_framework.pagination import PageNumberPagination, LimitOffsetPagination

class StandardResultsSetPagination(PageNumberPagination):
    """标准分页"""
    page_size = 10
    page_size_query_param = 'page_size'
    max_page_size = 100

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    pagination_class = StandardResultsSetPagination
    permission_classes = [IsAuthenticatedOrReadOnly]

class LimitOffsetArticleViewSet(viewsets.ModelViewSet):
    """限制偏移分页的文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    pagination_class = LimitOffsetPagination
    permission_classes = [IsAuthenticatedOrReadOnly]
```

#### 3. 权限控制

```python
from rest_framework.permissions import IsAuthenticated, IsAdminUser, IsAuthenticatedOrReadOnly
from rest_framework import permissions

class IsAuthorOrReadOnly(permissions.BasePermission):
    """自定义权限：作者或只读"""
    
    def has_object_permission(self, request, view, obj):
        # 读取权限允许任何请求
        if request.method in permissions.SAFE_METHODS:
            return True
        
        # 写入权限只允许文章作者
        return obj.author == request.user

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly, IsAuthorOrReadOnly]
    
    def get_permissions(self):
        """根据操作类型设置权限"""
        if self.action == 'create':
            permission_classes = [IsAuthenticated]
        elif self.action in ['update', 'partial_update', 'destroy']:
            permission_classes = [IsAuthenticated, IsAuthorOrReadOnly]
        else:
            permission_classes = [IsAuthenticatedOrReadOnly]
        
        return [permission() for permission in permission_classes]
```

#### 4. 认证

```python
from rest_framework.authentication import TokenAuthentication, SessionAuthentication

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    authentication_classes = [TokenAuthentication, SessionAuthentication]
    permission_classes = [IsAuthenticatedOrReadOnly]
```

### 自定义操作

#### 1. 使用 @action 装饰器

```python
from rest_framework.decorators import action

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    @action(detail=True, methods=['post'])
    def like(self, request, pk=None):
        """点赞文章"""
        article = self.get_object()
        article.increase_likes()
        return Response({'status': 'liked'})
    
    @action(detail=True, methods=['post'])
    def unlike(self, request, pk=None):
        """取消点赞"""
        article = self.get_object()
        article.likes_count = max(0, article.likes_count - 1)
        article.save()
        return Response({'status': 'unliked'})
    
    @action(detail=True, methods=['get'])
    def comments(self, request, pk=None):
        """获取文章评论"""
        article = self.get_object()
        comments = article.comments.filter(is_approved=True)
        serializer = CommentSerializer(comments, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['post'])
    def comment(self, request, pk=None):
        """添加评论"""
        article = self.get_object()
        serializer = CommentCreateSerializer(
            data=request.data,
            context={'article': article, 'request': request}
        )
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=False, methods=['get'])
    def featured(self, request):
        """获取推荐文章"""
        articles = self.get_queryset().filter(is_featured=True)
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def popular(self, request):
        """获取热门文章"""
        articles = self.get_queryset().order_by('-views_count')[:10]
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def recent(self, request):
        """获取最新文章"""
        articles = self.get_queryset().order_by('-created_at')[:10]
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
```

#### 2. 自定义操作参数

```python
class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    @action(detail=False, methods=['get'], url_path='search/(?P<keyword>[^/.]+)')
    def search(self, request, keyword=None):
        """搜索文章"""
        articles = self.get_queryset().filter(
            title__icontains=keyword
        ) | self.get_queryset().filter(
            content__icontains=keyword
        )
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['post'], url_path='publish')
    def publish_article(self, request, pk=None):
        """发布文章"""
        article = self.get_object()
        article.status = 'published'
        article.save()
        return Response({'status': 'published'})
    
    @action(detail=True, methods=['post'], url_path='archive')
    def archive_article(self, request, pk=None):
        """归档文章"""
        article = self.get_object()
        article.status = 'archived'
        article.save()
        return Response({'status': 'archived'})
```

### 视图优化

#### 1. 查询优化

```python
class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        """优化查询集"""
        queryset = Article.objects.select_related('author', 'category').prefetch_related('tags')
        
        if self.action == 'list':
            queryset = queryset.filter(status='published')
        
        return queryset
    
    def get_serializer_class(self):
        """根据操作类型返回不同的序列化器"""
        if self.action == 'list':
            return ArticleListSerializer
        return ArticleDetailSerializer
```

#### 2. 缓存

```python
from django.utils.decorators import method_decorator
from django.views.decorators.cache import cache_page

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    @method_decorator(cache_page(60 * 15))  # 缓存15分钟
    def list(self, request, *args, **kwargs):
        return super().list(request, *args, **kwargs)
    
    @method_decorator(cache_page(60 * 30))  # 缓存30分钟
    def retrieve(self, request, *args, **kwargs):
        return super().retrieve(request, *args, **kwargs)
```

#### 3. 异常处理

```python
from rest_framework.exceptions import ValidationError, NotFound
from django.core.exceptions import ObjectDoesNotExist

class ArticleViewSet(viewsets.ModelViewSet):
    """文章视图集"""
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_object(self):
        """获取对象并处理异常"""
        try:
            return super().get_object()
        except ObjectDoesNotExist:
            raise NotFound("文章不存在")
    
    def create(self, request, *args, **kwargs):
        """创建文章并处理异常"""
        try:
            return super().create(request, *args, **kwargs)
        except ValidationError as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )
```

### 视图测试

#### 1. 基本测试

```python
# tests.py
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth.models import User
from .models import Article, Category

class ArticleViewSetTestCase(APITestCase):
    def setUp(self):
        """设置测试数据"""
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.category = Category.objects.create(
            name='测试分类',
            description='测试分类描述'
        )
        self.article = Article.objects.create(
            title='测试文章',
            content='测试文章内容',
            author=self.user,
            category=self.category,
            status='published'
        )
    
    def test_list_articles(self):
        """测试获取文章列表"""
        url = reverse('article-list')
        response = self.client.get(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data), 1)
    
    def test_create_article(self):
        """测试创建文章"""
        self.client.force_authenticate(user=self.user)
        url = reverse('article-list')
        data = {
            'title': '新文章',
            'content': '新文章内容',
            'category_id': self.category.id
        }
        response = self.client.post(url, data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(Article.objects.count(), 2)
    
    def test_retrieve_article(self):
        """测试获取文章详情"""
        url = reverse('article-detail', args=[self.article.id])
        response = self.client.get(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['title'], '测试文章')
    
    def test_update_article(self):
        """测试更新文章"""
        self.client.force_authenticate(user=self.user)
        url = reverse('article-detail', args=[self.article.id])
        data = {
            'title': '更新后的文章',
            'content': '更新后的内容'
        }
        response = self.client.put(url, data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.article.refresh_from_db()
        self.assertEqual(self.article.title, '更新后的文章')
    
    def test_delete_article(self):
        """测试删除文章"""
        self.client.force_authenticate(user=self.user)
        url = reverse('article-detail', args=[self.article.id])
        response = self.client.delete(url)
        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)
        self.assertEqual(Article.objects.count(), 0)
    
    def test_like_article(self):
        """测试点赞文章"""
        self.client.force_authenticate(user=self.user)
        url = reverse('article-like', args=[self.article.id])
        response = self.client.post(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.article.refresh_from_db()
        self.assertEqual(self.article.likes_count, 1)
```

### 总结

通过本章的学习，你应该掌握了：

1. **视图基础**：APIView 和 GenericAPIView 的使用
2. **通用视图**：各种通用视图类的使用
3. **视图集**：ModelViewSet、ReadOnlyModelViewSet 等
4. **高级功能**：过滤、搜索、分页、权限控制
5. **自定义操作**：使用 @action 装饰器添加自定义操作
6. **视图优化**：查询优化、缓存、异常处理
7. **视图测试**：编写完整的视图测试用例

视图是 DRF 中处理业务逻辑的核心组件。在下一章中，我们将学习请求与响应的处理机制。 