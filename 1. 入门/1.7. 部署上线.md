## 部署上线

将Django应用从开发环境部署到生产环境需要一些额外的配置和步骤。本教程介绍基本的部署流程。

### 生产环境设置

在部署到生产环境之前，需要修改一些项目设置：

1. **关闭调试模式**：

```python
# settings.py
DEBUG = False
```

2. **设置允许的主机**：

```python
ALLOWED_HOSTS = ['example.com', 'www.example.com']
```

3. **配置静态文件**：

```python
# settings.py
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
```

然后收集静态文件：

```bash
python manage.py collectstatic
```

4. **设置安全密钥**：

```python
# 使用环境变量存储密钥，而不是硬编码在settings.py中
SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY', 'default-key-for-dev')
```

### 数据库配置

在生产环境中，通常会使用更强大的数据库（如mySQL）：

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydatabase',
        'USER': 'mydatabaseuser',
        'PASSWORD': os.environ.get('DB_PASSWORD', ''),
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

### WSGI/ASGI服务器

Django开发服务器不适合生产环境。你应该使用WSGI服务器如Gunicorn：

```bash
# 安装Gunicorn
pip install gunicorn

# 运行Gunicorn
gunicorn myproject.wsgi:application
```

### 使用Nginx作为反向代理

通常会使用Nginx作为前端Web服务器，处理静态文件并将动态请求转发给WSGI服务器：

```
server {
    listen 80;
    server_name example.com www.example.com;

    location /static/ {
        alias /path/to/your/staticfiles/;
    }

    location /media/ {
        alias /path/to/your/media/;
    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 使用Systemd管理服务

创建一个systemd服务文件来管理Gunicorn进程：

```
[Unit]
Description=Gunicorn daemon for Django project
After=network.target

[Service]
User=username
Group=username
WorkingDirectory=/path/to/your/project
ExecStart=/path/to/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 myproject.wsgi:application

[Install]
WantedBy=multi-user.target
```

保存为`/etc/systemd/system/gunicorn.service`，然后启用和启动服务：

```bash
sudo systemctl enable gunicorn
sudo systemctl start gunicorn
```

### 使用环境变量

使用环境变量来存储敏感信息，而不是硬编码在设置文件中：

```python
# settings.py
import os

SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY')
DEBUG = os.environ.get('DJANGO_DEBUG', '') == 'True'
```

### 部署清单

部署前的检查清单：

1. 关闭DEBUG模式
2. 设置SECRET_KEY为环境变量
3. 配置ALLOWED_HOSTS
4. 收集静态文件
5. 使用适当的数据库
6. 设置HTTPS（推荐使用Let's Encrypt）
7. 备份数据库
8. 运行测试确保一切正常

## 小结

- 部署Django应用需要修改一些安全和性能相关的设置
- 生产环境应使用专业的WSGI服务器而不是开发服务器
- 敏感信息应通过环境变量管理
- 对于初学者，PaaS平台可以简化部署流程