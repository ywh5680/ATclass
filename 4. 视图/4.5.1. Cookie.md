## Cookie

Cookie是存储在客户端浏览器中的小型文本文件，用于在客户端保存状态信息。在Django中，Cookie是状态保持的重要机制之一，可以用于保存用户偏好、会话标识、购物车信息等。

### 什么是Cookie

Cookie是Web服务器发送到用户浏览器并保存在本地的一小块数据。浏览器会在每次向同一服务器发起请求时，自动将Cookie发送给服务器。

#### Cookie的基本概念

```python
from django.http import HttpResponse

def cookie_basic_example(request):
    """Cookie基本示例"""
    
    # 设置Cookie
    response = HttpResponse("Cookie已设置")
    response.set_cookie('user_name', '张三')
    response.set_cookie('visit_count', '1')
    
    # 读取Cookie
    user_name = request.COOKIES.get('user_name', '未知用户')
    visit_count = request.COOKIES.get('visit_count', '0')
    
    return response

def cookie_lifecycle(request):
    """Cookie生命周期示例"""
    
    # 1. 设置Cookie
    response = HttpResponse("Cookie生命周期演示")
    
    # 2. 读取Cookie
    existing_cookie = request.COOKIES.get('test_cookie')
    
    if existing_cookie:
        # 3. 更新Cookie
        response.set_cookie('test_cookie', f"{existing_cookie}_updated")
    else:
        # 4. 创建新Cookie
        response.set_cookie('test_cookie', 'new_value')
    
    # 5. 删除Cookie
    # response.delete_cookie('test_cookie')
    
    return response
```

### Cookie的基本操作

#### 1. 设置Cookie

```python
def set_cookie_examples(request):
    """设置Cookie的各种方式"""
    
    response = HttpResponse("Cookie设置示例")
    
    # 基本设置
    response.set_cookie('basic_cookie', 'basic_value')
    
    # 带过期时间的Cookie
    response.set_cookie('expiring_cookie', 'expiring_value', max_age=3600)  # 1小时
    
    # 带路径的Cookie
    response.set_cookie('path_cookie', 'path_value', path='/admin/')
    
    # 带域名的Cookie
    response.set_cookie('domain_cookie', 'domain_value', domain='.example.com')
    
    # 安全Cookie（仅HTTPS）
    response.set_cookie('secure_cookie', 'secure_value', secure=True)
    
    # HttpOnly Cookie（仅HTTP访问）
    response.set_cookie('httponly_cookie', 'httponly_value', httponly=True)
    
    # SameSite Cookie
    response.set_cookie('samesite_cookie', 'samesite_value', samesite='Lax')
    
    return response

def set_cookie_with_datetime(request):
    """使用datetime设置Cookie过期时间"""
    
    from datetime import datetime, timedelta
    
    response = HttpResponse("Cookie过期时间设置")
    
    # 使用expires参数设置过期时间
    expires = datetime.now() + timedelta(days=7)  # 7天后过期
    response.set_cookie('week_cookie', 'week_value', expires=expires)
    
    # 使用max_age参数设置过期时间（秒）
    response.set_cookie('hour_cookie', 'hour_value', max_age=3600)  # 1小时
    
    # 浏览器关闭时过期
    response.set_cookie('session_cookie', 'session_value', max_age=None)
    
    return response
```

#### 2. 读取Cookie

```python
def read_cookie_examples(request):
    """读取Cookie的各种方式"""
    
    # 基本读取
    user_name = request.COOKIES.get('user_name')
    
    # 带默认值的读取
    theme = request.COOKIES.get('theme', 'light')
    language = request.COOKIES.get('language', 'zh-cn')
    
    # 检查Cookie是否存在
    has_preference = 'user_preference' in request.COOKIES
    
    # 获取所有Cookie
    all_cookies = request.COOKIES
    
    # 获取特定Cookie的值
    try:
        visit_count = int(request.COOKIES.get('visit_count', '0'))
    except ValueError:
        visit_count = 0
    
    # 构建响应
    response_data = {
        'user_name': user_name,
        'theme': theme,
        'language': language,
        'has_preference': has_preference,
        'visit_count': visit_count,
        'all_cookies': all_cookies
    }
    
    return JsonResponse(response_data)

def cookie_validation(request):
    """Cookie验证示例"""
    
    # 验证必需的Cookie
    required_cookies = ['session_id', 'user_id']
    missing_cookies = []
    
    for cookie_name in required_cookies:
        if cookie_name not in request.COOKIES:
            missing_cookies.append(cookie_name)
    
    if missing_cookies:
        return JsonResponse({
            'error': '缺少必需的Cookie',
            'missing': missing_cookies
        }, status=400)
    
    # 验证Cookie值
    session_id = request.COOKIES.get('session_id')
    user_id = request.COOKIES.get('user_id')
    
    # 简单的值验证
    if not session_id or len(session_id) < 10:
        return JsonResponse({
            'error': '无效的session_id'
        }, status=400)
    
    try:
        user_id = int(user_id)
    except (ValueError, TypeError):
        return JsonResponse({
            'error': '无效的user_id'
        }, status=400)
    
    return JsonResponse({
        'message': 'Cookie验证通过',
        'session_id': session_id,
        'user_id': user_id
    })
```

#### 3. 删除Cookie

```python
def delete_cookie_examples(request):
    """删除Cookie的各种方式"""
    
    response = HttpResponse("Cookie删除示例")
    
    # 基本删除
    response.delete_cookie('basic_cookie')
    
    # 删除带路径的Cookie
    response.delete_cookie('path_cookie', path='/admin/')
    
    # 删除带域名的Cookie
    response.delete_cookie('domain_cookie', domain='.example.com')
    
    # 通过设置过期时间为过去来删除Cookie
    response.set_cookie('expired_cookie', '', max_age=0)
    
    # 清空Cookie值
    response.set_cookie('empty_cookie', '')
    
    return response

def clear_user_cookies(request):
    """清除用户相关的Cookie"""
    
    response = HttpResponse("用户Cookie已清除")
    
    # 要清除的Cookie列表
    cookies_to_clear = [
        'user_id',
        'session_id',
        'user_preference',
        'theme',
        'language',
        'last_visit'
    ]
    
    for cookie_name in cookies_to_clear:
        response.delete_cookie(cookie_name)
    
    return response
```

### Cookie的实际应用

#### 1. 用户偏好设置

```python
def user_preferences(request):
    """用户偏好设置"""
    
    if request.method == 'POST':
        # 获取用户设置
        theme = request.POST.get('theme', 'light')
        language = request.POST.get('language', 'zh-cn')
        font_size = request.POST.get('font_size', 'medium')
        
        # 设置Cookie
        response = HttpResponse("偏好设置已保存")
        response.set_cookie('theme', theme, max_age=30*24*60*60)  # 30天
        response.set_cookie('language', language, max_age=30*24*60*60)
        response.set_cookie('font_size', font_size, max_age=30*24*60*60)
        
        return response
    
    # GET请求，显示当前设置
    theme = request.COOKIES.get('theme', 'light')
    language = request.COOKIES.get('language', 'zh-cn')
    font_size = request.COOKIES.get('font_size', 'medium')
    
    context = {
        'theme': theme,
        'language': language,
        'font_size': font_size
    }
    
    return render(request, 'preferences.html', context)

def apply_user_preferences(request):
    """应用用户偏好设置"""
    
    # 从Cookie获取用户偏好
    theme = request.COOKIES.get('theme', 'light')
    language = request.COOKIES.get('language', 'zh-cn')
    font_size = request.COOKIES.get('font_size', 'medium')
    
    # 根据偏好设置页面样式
    css_class = f"theme-{theme} font-{font_size}"
    
    # 根据语言设置内容
    if language == 'en':
        welcome_message = "Welcome to our website!"
    else:
        welcome_message = "欢迎访问我们的网站！"
    
    context = {
        'css_class': css_class,
        'welcome_message': welcome_message,
        'theme': theme,
        'language': language,
        'font_size': font_size
    }
    
    return render(request, 'home.html', context)
```

#### 2. 访问统计

```python
def visit_tracking(request):
    """访问统计"""
    
    # 获取访问次数
    visit_count = int(request.COOKIES.get('visit_count', '0'))
    visit_count += 1
    
    # 获取首次访问时间
    first_visit = request.COOKIES.get('first_visit')
    if not first_visit:
        from datetime import datetime
        first_visit = datetime.now().isoformat()
    
    # 获取最后访问时间
    last_visit = request.COOKIES.get('last_visit')
    from datetime import datetime
    current_time = datetime.now().isoformat()
    
    # 设置Cookie
    response = HttpResponse(f"这是您第{visit_count}次访问")
    response.set_cookie('visit_count', str(visit_count), max_age=365*24*60*60)  # 1年
    response.set_cookie('first_visit', first_visit, max_age=365*24*60*60)
    response.set_cookie('last_visit', current_time, max_age=365*24*60*60)
    
    # 显示访问统计
    if last_visit:
        from datetime import datetime
        last_visit_dt = datetime.fromisoformat(last_visit)
        current_dt = datetime.now()
        days_since_last = (current_dt - last_visit_dt).days
        
        response.write(f"<br>距离上次访问：{days_since_last}天")
    
    return response

def user_analytics(request):
    """用户分析"""
    
    # 获取用户行为数据
    page_views = int(request.COOKIES.get('page_views', '0'))
    session_start = request.COOKIES.get('session_start')
    
    # 更新页面浏览量
    page_views += 1
    
    # 如果没有会话开始时间，设置一个
    if not session_start:
        from datetime import datetime
        session_start = datetime.now().isoformat()
    
    # 设置Cookie
    response = HttpResponse("用户分析数据已更新")
    response.set_cookie('page_views', str(page_views), max_age=24*60*60)  # 24小时
    response.set_cookie('session_start', session_start, max_age=24*60*60)
    
    # 计算会话时长
    if session_start:
        from datetime import datetime
        start_time = datetime.fromisoformat(session_start)
        current_time = datetime.now()
        session_duration = (current_time - start_time).total_seconds()
        
        response.write(f"<br>会话时长：{session_duration:.0f}秒")
        response.write(f"<br>页面浏览量：{page_views}")
    
    return response
```

#### 3. 购物车功能

```python
def shopping_cart_cookies(request):
    """使用Cookie实现购物车"""
    
    if request.method == 'POST':
        action = request.POST.get('action')
        product_id = request.POST.get('product_id')
        
        # 获取当前购物车
        cart_data = request.COOKIES.get('cart', '{}')
        import json
        try:
            cart = json.loads(cart_data)
        except json.JSONDecodeError:
            cart = {}
        
        if action == 'add':
            # 添加商品
            if product_id in cart:
                cart[product_id]['quantity'] += 1
            else:
                cart[product_id] = {
                    'quantity': 1,
                    'added_at': datetime.now().isoformat()
                }
        
        elif action == 'remove':
            # 移除商品
            if product_id in cart:
                del cart[product_id]
        
        elif action == 'update':
            # 更新数量
            quantity = int(request.POST.get('quantity', 0))
            if quantity > 0:
                cart[product_id]['quantity'] = quantity
            else:
                del cart[product_id]
        
        # 保存购物车到Cookie
        response = JsonResponse({'message': '购物车已更新'})
        response.set_cookie('cart', json.dumps(cart), max_age=7*24*60*60)  # 7天
        
        return response
    
    # GET请求，显示购物车
    cart_data = request.COOKIES.get('cart', '{}')
    import json
    try:
        cart = json.loads(cart_data)
    except json.JSONDecodeError:
        cart = {}
    
    # 获取购物车中的商品详情
    cart_items = []
    for product_id, item_data in cart.items():
        try:
            product = Product.objects.get(pk=product_id)
            cart_items.append({
                'product': product,
                'quantity': item_data['quantity'],
                'added_at': item_data['added_at']
            })
        except Product.DoesNotExist:
            # 商品不存在，从购物车中移除
            del cart[product_id]
    
    # 更新购物车Cookie
    response = render(request, 'cart.html', {'cart_items': cart_items})
    response.set_cookie('cart', json.dumps(cart), max_age=7*24*60*60)
    
    return response
```

### Cookie的安全考虑

#### 1. 安全Cookie设置

```python
def secure_cookie_settings(request):
    """安全Cookie设置"""
    
    response = HttpResponse("安全Cookie已设置")
    
    # 敏感数据使用安全Cookie
    response.set_cookie(
        'auth_token',
        'sensitive_data_here',
        max_age=3600,        # 1小时过期
        secure=True,         # 仅HTTPS
        httponly=True,       # 仅HTTP访问
        samesite='Strict'    # 严格的SameSite
    )
    
    # 用户偏好可以使用较宽松的设置
    response.set_cookie(
        'user_theme',
        'dark',
        max_age=30*24*60*60,  # 30天
        secure=False,         # 允许HTTP
        httponly=False,       # 允许JavaScript访问
        samesite='Lax'        # 宽松的SameSite
    )
    
    return response

def cookie_encryption(request):
    """Cookie加密"""
    
    import base64
    import json
    from cryptography.fernet import Fernet
    
    # 生成密钥（实际应用中应该从设置中获取）
    key = Fernet.generate_key()
    cipher = Fernet(key)
    
    # 要加密的数据
    sensitive_data = {
        'user_id': 123,
        'permissions': ['read', 'write'],
        'timestamp': datetime.now().isoformat()
    }
    
    # 加密数据
    json_data = json.dumps(sensitive_data)
    encrypted_data = cipher.encrypt(json_data.encode())
    encoded_data = base64.b64encode(encrypted_data).decode()
    
    # 设置加密的Cookie
    response = HttpResponse("加密Cookie已设置")
    response.set_cookie('encrypted_data', encoded_data, max_age=3600)
    
    # 解密数据
    if 'encrypted_data' in request.COOKIES:
        encoded_data = request.COOKIES['encrypted_data']
        encrypted_data = base64.b64decode(encoded_data.encode())
        decrypted_data = cipher.decrypt(encrypted_data)
        data = json.loads(decrypted_data.decode())
        
        response.write(f"<br>解密数据：{data}")
    
    return response
```

#### 2. Cookie验证

```python
def cookie_validation_security(request):
    """Cookie安全验证"""
    
    # 验证Cookie签名
    def verify_cookie_signature(cookie_value, signature):
        import hmac
        import hashlib
        
        expected_signature = hmac.new(
            b'secret_key',  # 实际应用中应该从设置中获取
            cookie_value.encode(),
            hashlib.sha256
        ).hexdigest()
        
        return hmac.compare_digest(signature, expected_signature)
    
    # 设置带签名的Cookie
    cookie_value = "user_data_123"
    import hmac
    import hashlib
    
    signature = hmac.new(
        b'secret_key',
        cookie_value.encode(),
        hashlib.sha256
    ).hexdigest()
    
    response = HttpResponse("带签名的Cookie已设置")
    response.set_cookie('signed_data', f"{cookie_value}.{signature}", max_age=3600)
    
    # 验证Cookie
    if 'signed_data' in request.COOKIES:
        signed_data = request.COOKIES['signed_data']
        try:
            value, signature = signed_data.split('.', 1)
            if verify_cookie_signature(value, signature):
                response.write(f"<br>Cookie验证成功：{value}")
            else:
                response.write("<br>Cookie验证失败")
        except ValueError:
            response.write("<br>Cookie格式错误")
    
    return response

def prevent_cookie_tampering(request):
    """防止Cookie篡改"""
    
    # 检查Cookie是否被篡改
    def check_cookie_integrity(request):
        user_id = request.COOKIES.get('user_id')
        user_hash = request.COOKIES.get('user_hash')
        
        if user_id and user_hash:
            import hashlib
            expected_hash = hashlib.md5(f"user_{user_id}_secret".encode()).hexdigest()
            
            if user_hash == expected_hash:
                return True, user_id
            else:
                return False, None
        
        return False, None
    
    # 设置带完整性检查的Cookie
    user_id = "123"
    import hashlib
    user_hash = hashlib.md5(f"user_{user_id}_secret".encode()).hexdigest()
    
    response = HttpResponse("完整性检查Cookie已设置")
    response.set_cookie('user_id', user_id, max_age=3600)
    response.set_cookie('user_hash', user_hash, max_age=3600)
    
    # 验证Cookie完整性
    is_valid, user_id = check_cookie_integrity(request)
    if is_valid:
        response.write(f"<br>Cookie完整性验证通过，用户ID：{user_id}")
    else:
        response.write("<br>Cookie完整性验证失败")
    
    return response
```

### Cookie的最佳实践

#### 1. Cookie管理工具

```python
class CookieManager:
    """Cookie管理工具类"""
    
    def __init__(self, response=None):
        self.response = response or HttpResponse()
    
    def set_cookie(self, name, value, **kwargs):
        """设置Cookie"""
        self.response.set_cookie(name, value, **kwargs)
        return self
    
    def delete_cookie(self, name, **kwargs):
        """删除Cookie"""
        self.response.delete_cookie(name, **kwargs)
        return self
    
    def get_cookie(self, request, name, default=None):
        """获取Cookie"""
        return request.COOKIES.get(name, default)
    
    def set_user_preference(self, name, value, max_age=30*24*60*60):
        """设置用户偏好Cookie"""
        self.set_cookie(
            f'pref_{name}',
            value,
            max_age=max_age,
            secure=False,
            httponly=False,
            samesite='Lax'
        )
        return self
    
    def set_session_cookie(self, name, value, max_age=3600):
        """设置会话Cookie"""
        self.set_cookie(
            name,
            value,
            max_age=max_age,
            secure=True,
            httponly=True,
            samesite='Strict'
        )
        return self
    
    def get_response(self):
        """获取响应对象"""
        return self.response

# 使用Cookie管理工具
def cookie_manager_example(request):
    """Cookie管理工具示例"""
    
    cookie_mgr = CookieManager()
    
    # 设置用户偏好
    cookie_mgr.set_user_preference('theme', 'dark')
    cookie_mgr.set_user_preference('language', 'en')
    
    # 设置会话Cookie
    cookie_mgr.set_session_cookie('auth_token', 'abc123')
    
    # 获取Cookie
    theme = cookie_mgr.get_cookie(request, 'pref_theme', 'light')
    
    response = cookie_mgr.get_response()
    response.write(f"主题：{theme}")
    
    return response
```

#### 2. Cookie中间件

```python
class CookieMiddleware:
    """Cookie中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        response = self.get_response(request)
        
        # 自动设置用户偏好Cookie
        if request.user.is_authenticated:
            if not request.COOKIES.get('user_id'):
                response.set_cookie('user_id', str(request.user.id), max_age=30*24*60*60)
        
        # 设置访问统计Cookie
        visit_count = int(request.COOKIES.get('visit_count', '0'))
        visit_count += 1
        response.set_cookie('visit_count', str(visit_count), max_age=365*24*60*60)
        
        # 设置最后访问时间
        from datetime import datetime
        response.set_cookie('last_visit', datetime.now().isoformat(), max_age=365*24*60*60)
        
        return response

class SecureCookieMiddleware:
    """安全Cookie中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        response = self.get_response(request)
        
        # 强制HTTPS Cookie
        if request.is_secure():
            for cookie_name in ['auth_token', 'session_id']:
                if cookie_name in request.COOKIES:
                    response.set_cookie(
                        cookie_name,
                        request.COOKIES[cookie_name],
                        secure=True,
                        httponly=True,
                        samesite='Strict'
                    )
        
        return response
```

## 小结

- **Cookie基础**：理解Cookie的概念、生命周期和基本操作
- **设置和读取**：掌握设置、读取、删除Cookie的各种方法
- **实际应用**：实现用户偏好、访问统计、购物车等功能
- **安全考虑**：使用安全Cookie设置、加密、验证等安全措施
- **最佳实践**：使用工具类和中间件管理Cookie

合理使用Cookie可以构建出功能完整、用户体验良好的Web应用，但需要注意安全性和隐私保护。
