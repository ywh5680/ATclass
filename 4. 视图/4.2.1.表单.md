## 表单

表单是Web应用中用户输入数据的主要方式，Django提供了强大的表单系统来处理用户输入、验证数据和生成HTML表单。本章将详细介绍Django表单的使用方法。

### 表单基础

#### 1. 什么是Django表单

Django表单是一个Python类，用于：

- **数据验证**：验证用户输入的数据
- **HTML生成**：自动生成HTML表单
- **数据处理**：处理表单提交的数据
- **错误处理**：显示验证错误信息

#### 2. 表单的优势

- **自动化**：自动生成HTML和验证
- **安全性**：内置CSRF保护和XSS防护
- **一致性**：统一的表单处理方式
- **可扩展**：易于自定义和扩展

### 创建表单

#### 1. 基本表单类

```python
# forms.py
from django import forms

class ContactForm(forms.Form):
    name = forms.CharField(
        max_length=100,
        label='姓名',
        widget=forms.TextInput(attrs={'class': 'form-control'})
    )
    email = forms.EmailField(
        label='邮箱',
        widget=forms.EmailInput(attrs={'class': 'form-control'})
    )
    message = forms.CharField(
        label='消息',
        widget=forms.Textarea(attrs={'class': 'form-control', 'rows': 4}),
        max_length=1000
    )
    subject = forms.ChoiceField(
        choices=[
            ('general', '一般咨询'),
            ('support', '技术支持'),
            ('feedback', '意见反馈')
        ],
        label='主题'
    )
```

#### 2. 模型表单

```python
# forms.py
from django import forms
from .models import Article

class ArticleForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = ['title', 'content', 'category', 'tags']
        labels = {
            'title': '标题',
            'content': '内容',
            'category': '分类',
            'tags': '标签'
        }
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control'}),
            'content': forms.Textarea(attrs={'class': 'form-control', 'rows': 10}),
            'category': forms.Select(attrs={'class': 'form-control'}),
            'tags': forms.TextInput(attrs={'class': 'form-control'})
        }
```

#### 3. 表单字段类型

```python
# 常用字段类型
class ExampleForm(forms.Form):
    # 文本字段
    text = forms.CharField(max_length=100)
    textarea = forms.CharField(widget=forms.Textarea)
    password = forms.CharField(widget=forms.PasswordInput)
    
    # 数字字段
    integer = forms.IntegerField()
    decimal = forms.DecimalField(max_digits=5, decimal_places=2)
    
    # 日期时间字段
    date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}))
    datetime = forms.DateTimeField()
    time = forms.TimeField()
    
    # 选择字段
    choice = forms.ChoiceField(choices=[('1', '选项1'), ('2', '选项2')])
    multiple_choice = forms.MultipleChoiceField(choices=[('1', '选项1'), ('2', '选项2')])
    
    # 布尔字段
    boolean = forms.BooleanField()
    
    # 文件字段
    file = forms.FileField()
    image = forms.ImageField()
    
    # 邮箱和URL
    email = forms.EmailField()
    url = forms.URLField()
```

### 表单验证

#### 1. 字段验证

```python
# 自定义验证器
from django.core.validators import RegexValidator

class UserForm(forms.Form):
    username = forms.CharField(
        max_length=30,
        validators=[
            RegexValidator(
                regex=r'^[a-zA-Z0-9_]+$',
                message='用户名只能包含字母、数字和下划线'
            )
        ]
    )
    
    # 自定义验证方法
    def clean_username(self):
        username = self.cleaned_data.get('username')
        if username.lower() in ['admin', 'root', 'test']:
            raise forms.ValidationError('该用户名已被保留')
        return username
    
    # 表单级验证
    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get('password')
        confirm_password = cleaned_data.get('confirm_password')
        
        if password and confirm_password and password != confirm_password:
            raise forms.ValidationError('两次输入的密码不一致')
        
        return cleaned_data
```

#### 2. 验证错误处理

```python
# 在视图中处理验证错误
def contact_view(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            # 处理有效数据
            name = form.cleaned_data['name']
            email = form.cleaned_data['email']
            message = form.cleaned_data['message']
            
            # 保存数据或发送邮件
            Contact.objects.create(
                name=name,
                email=email,
                message=message
            )
            
            messages.success(request, '消息发送成功！')
            return redirect('contact_success')
    else:
        form = ContactForm()
    
    return render(request, 'contact.html', {'form': form})
```

### 表单渲染

#### 1. 基本渲染

```html
<!-- 在模板中渲染表单 -->
<form method="post">
    {% csrf_token %}
    
    <!-- 渲染整个表单 -->
    {{ form.as_p }}
    
    <!-- 或者分别渲染字段 -->
    <div class="form-group">
        {{ form.name.label_tag }}
        {{ form.name }}
        {% if form.name.errors %}
            <div class="alert alert-danger">
                {{ form.name.errors }}
            </div>
        {% endif %}
    </div>
    
    <div class="form-group">
        {{ form.email.label_tag }}
        {{ form.email }}
        {% if form.email.errors %}
            <div class="alert alert-danger">
                {{ form.email.errors }}
            </div>
        {% endif %}
    </div>
    
    <button type="submit" class="btn btn-primary">提交</button>
</form>
```

#### 2. 自定义渲染

```html
<!-- 自定义表单样式 -->
<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    
    {% for field in form %}
        <div class="form-group mb-3">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
                <div class="invalid-feedback">
                    {% for error in field.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% endfor %}
    
    <button type="submit" class="btn btn-primary">提交</button>
</form>
```

#### 3. 表单样式

```css
/* 自定义表单样式 */
.form-group {
    margin-bottom: 1rem;
}

.form-control {
    display: block;
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    color: #495057;
    background-color: #fff;
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 80%;
    color: #dc3545;
}
```

### 表单处理

#### 1. 基本处理流程

```python
# views.py
from django.shortcuts import render, redirect
from django.contrib import messages
from .forms import ContactForm
from .models import Contact

def contact_view(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            # 获取验证后的数据
            name = form.cleaned_data['name']
            email = form.cleaned_data['email']
            message = form.cleaned_data['message']
            subject = form.cleaned_data['subject']
            
            # 保存到数据库
            contact = Contact.objects.create(
                name=name,
                email=email,
                message=message,
                subject=subject
            )
            
            # 发送邮件通知
            send_contact_notification(contact)
            
            messages.success(request, '消息发送成功！我们会尽快回复您。')
            return redirect('contact_success')
    else:
        form = ContactForm()
    
    return render(request, 'contact.html', {'form': form})
```

#### 2. 文件上传处理

```python
# 处理文件上传
def upload_view(request):
    if request.method == 'POST':
        form = DocumentForm(request.POST, request.FILES)
        if form.is_valid():
            # 处理文件上传
            document = form.save(commit=False)
            document.user = request.user
            document.save()
            
            messages.success(request, '文件上传成功！')
            return redirect('document_list')
    else:
        form = DocumentForm()
    
    return render(request, 'upload.html', {'form': form})

# 文件上传表单
class DocumentForm(forms.ModelForm):
    class Meta:
        model = Document
        fields = ['title', 'file', 'description']
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control'}),
            'file': forms.FileInput(attrs={'class': 'form-control-file'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3})
        }
```

#### 3. AJAX表单处理

```python
# AJAX表单处理视图
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

@csrf_exempt
def ajax_contact_view(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        form = ContactForm(data)
        
        if form.is_valid():
            # 处理有效数据
            contact = form.save()
            
            return JsonResponse({
                'success': True,
                'message': '消息发送成功！',
                'id': contact.id
            })
        else:
            return JsonResponse({
                'success': False,
                'errors': form.errors
            })
    
    return JsonResponse({'error': '只支持POST请求'})
```

```javascript
// 前端AJAX处理
document.getElementById('contact-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/contact/ajax/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('contact-form').reset();
        } else {
            // 显示错误信息
            displayErrors(data.errors);
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
```

### 高级表单功能

#### 1. 表单集

```python
# 使用表单集处理多个表单
from django.forms import formset_factory

ContactFormSet = formset_factory(ContactForm, extra=3, max_num=5)

def contact_formset_view(request):
    if request.method == 'POST':
        formset = ContactFormSet(request.POST)
        if formset.is_valid():
            for form in formset:
                if form.cleaned_data:  # 只处理有数据的表单
                    Contact.objects.create(**form.cleaned_data)
            
            messages.success(request, '所有消息发送成功！')
            return redirect('contact_success')
    else:
        formset = ContactFormSet()
    
    return render(request, 'contact_formset.html', {'formset': formset})
```

#### 2. 内联表单集

```python
# 模型内联表单集
from django.forms import inlineformset_factory

ArticleFormSet = inlineformset_factory(
    Author, 
    Article, 
    fields=['title', 'content'],
    extra=2,
    can_delete=True
)

def author_articles_view(request, author_id):
    author = Author.objects.get(id=author_id)
    
    if request.method == 'POST':
        formset = ArticleFormSet(request.POST, instance=author)
        if formset.is_valid():
            formset.save()
            messages.success(request, '文章保存成功！')
            return redirect('author_detail', author_id=author_id)
    else:
        formset = ArticleFormSet(instance=author)
    
    return render(request, 'author_articles.html', {
        'author': author,
        'formset': formset
    })
```

#### 3. 自定义表单小部件

```python
# 自定义表单小部件
class RichTextWidget(forms.Textarea):
    class Media:
        css = {
            'all': ('https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css',)
        }
        js = (
            'https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js',
        )
    
    def __init__(self, attrs=None):
        default_attrs = {'class': 'summernote'}
        if attrs:
            default_attrs.update(attrs)
        super().__init__(default_attrs)

# 使用自定义小部件
class ArticleForm(forms.ModelForm):
    content = forms.CharField(widget=RichTextWidget())
    
    class Meta:
        model = Article
        fields = ['title', 'content', 'category']
```

### 表单安全

#### 1. CSRF保护

```python
# 确保CSRF保护
# 在模板中自动包含CSRF令牌
{% csrf_token %}

# 在AJAX请求中包含CSRF令牌
headers: {
    'X-CSRFToken': getCookie('csrftoken')
}

# 在视图中验证CSRF
from django.views.decorators.csrf import ensure_csrf_cookie

@ensure_csrf_cookie
def contact_view(request):
    # 视图逻辑
    pass
```

#### 2. 输入验证

```python
# 严格的输入验证
class SecureForm(forms.Form):
    username = forms.CharField(
        max_length=30,
        validators=[
            RegexValidator(
                regex=r'^[a-zA-Z0-9_]+$',
                message='用户名只能包含字母、数字和下划线'
            )
        ]
    )
    
    # 防止XSS攻击
    content = forms.CharField(
        widget=forms.Textarea,
        strip=True  # 去除首尾空白
    )
    
    # 文件类型验证
    file = forms.FileField(
        validators=[
            FileExtensionValidator(allowed_extensions=['pdf', 'doc', 'docx'])
        ]
    )
```

#### 3. 权限控制

```python
# 基于用户权限的表单
class UserProfileForm(forms.ModelForm):
    class Meta:
        model = UserProfile
        fields = ['bio', 'avatar', 'website']
    
    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)
        
        # 根据用户权限显示字段
        if not self.user.has_perm('auth.change_user'):
            del self.fields['website']

# 在视图中使用
def profile_edit_view(request):
    if request.method == 'POST':
        form = UserProfileForm(request.POST, request.FILES, user=request.user)
        if form.is_valid():
            form.save()
            messages.success(request, '个人资料更新成功！')
            return redirect('profile')
    else:
        form = UserProfileForm(user=request.user)
    
    return render(request, 'profile_edit.html', {'form': form})
```

### 最佳实践

#### 1. 表单设计原则

```python
# 1. 保持表单简洁
class SimpleForm(forms.Form):
    # 只包含必要的字段
    name = forms.CharField(max_length=100)
    email = forms.EmailField()
    message = forms.CharField(widget=forms.Textarea)

# 2. 提供清晰的标签和帮助文本
class UserForm(forms.Form):
    username = forms.CharField(
        label='用户名',
        help_text='用户名长度为3-30个字符，只能包含字母、数字和下划线',
        max_length=30
    )

# 3. 使用适当的字段类型
class ProfileForm(forms.Form):
    birth_date = forms.DateField(
        widget=forms.DateInput(attrs={'type': 'date'}),
        help_text='请选择您的出生日期'
    )
```

#### 2. 错误处理

```python
# 友好的错误处理
def contact_view(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            # 处理表单
            pass
        else:
            # 记录错误日志
            logger.error(f"Form validation failed: {form.errors}")
            
            # 显示用户友好的错误信息
            for field, errors in form.errors.items():
                for error in errors:
                    messages.error(request, f"{form.fields[field].label}: {error}")
    else:
        form = ContactForm()
    
    return render(request, 'contact.html', {'form': form})
```

#### 3. 性能优化

```python
# 表单性能优化
class OptimizedForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = ['title', 'content', 'category']
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # 使用select_related优化查询
        self.fields['category'].queryset = Category.objects.select_related()
        
        # 缓存选项
        if not hasattr(self, '_category_choices'):
            self._category_choices = list(Category.objects.values_list('id', 'name'))
            self.fields['category'].choices = [('', '请选择分类')] + self._category_choices
```

### 总结

通过本章的学习，你应该掌握了：

1. **表单基础**：理解Django表单的概念和优势
2. **表单创建**：创建基本表单和模型表单
3. **表单验证**：实现字段级和表单级验证
4. **表单渲染**：在模板中渲染和自定义表单
5. **表单处理**：处理表单提交和数据保存
6. **高级功能**：使用表单集和内联表单集
7. **安全考虑**：实现CSRF保护和输入验证
8. **最佳实践**：表单设计和性能优化

Django表单系统提供了强大而灵活的表单处理能力，掌握这些知识将大大提高你的Web开发效率。
