## 列表页选项

Django Admin的列表页是管理后台的核心界面，它显示模型实例的列表，并提供搜索、过滤、排序等功能。通过合理配置列表页选项，可以大大提高管理效率。

### 列表页基础配置

#### 1. 基本显示字段

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    # 列表页显示的字段
    list_display = ['title', 'author', 'category', 'status', 'created_at']
```

#### 2. 字段显示顺序

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    # 字段显示顺序很重要，影响用户体验
    list_display = [
        'id',           # 通常ID放在最前面
        'title',        # 主要信息
        'author',       # 关联信息
        'category',     # 分类信息
        'status',       # 状态信息
        'created_at',   # 时间信息
        'updated_at'    # 更新时间
    ]
```

### 列表页显示选项

#### 1. 字段格式化显示

```python
# admin.py
from django.contrib import admin
from django.utils.html import format_html
from django.utils.safestring import mark_safe
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at', 'content_preview']
    
    def content_preview(self, obj):
        """内容预览"""
        if obj.content:
            return obj.content[:50] + '...' if len(obj.content) > 50 else obj.content
        return '-'
    content_preview.short_description = '内容预览'
    
    def title_with_link(self, obj):
        """带链接的标题"""
        return format_html(
            '<a href="{}">{}</a>',
            obj.get_absolute_url(),
            obj.title
        )
    title_with_link.short_description = '标题'
    
    def status_colored(self, obj):
        """带颜色的状态"""
        colors = {
            'draft': 'orange',
            'published': 'green',
            'archived': 'gray'
        }
        color = colors.get(obj.status, 'black')
        return format_html(
            '<span style="color: {};">{}</span>',
            color,
            obj.get_status_display()
        )
    status_colored.short_description = '状态'
```

#### 2. 自定义显示方法

```python
# admin.py
from django.contrib import admin
from django.utils import timezone
from datetime import timedelta
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at', 'age']
    
    def age(self, obj):
        """显示文章年龄"""
        now = timezone.now()
        age = now - obj.created_at
        
        if age.days == 0:
            if age.seconds < 3600:
                return f"{age.seconds // 60}分钟前"
            else:
                return f"{age.seconds // 3600}小时前"
        elif age.days == 1:
            return "昨天"
        elif age.days < 7:
            return f"{age.days}天前"
        else:
            return f"{age.days // 7}周前"
    age.short_description = '发布时间'
    
    def author_email(self, obj):
        """显示作者邮箱"""
        return obj.author.email if obj.author else '-'
    author_email.short_description = '作者邮箱'
    
    def category_count(self, obj):
        """显示分类下的文章数量"""
        return obj.category.articles.count() if obj.category else 0
    category_count.short_description = '分类文章数'
```

### 列表页过滤选项

#### 1. 基本过滤器

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    # 列表页过滤器
    list_filter = [
        'status',           # 状态过滤
        'category',         # 分类过滤
        'author',           # 作者过滤
        'created_at',       # 创建时间过滤
        'tags',             # 标签过滤
    ]
```

#### 2. 自定义过滤器

```python
# admin.py
from django.contrib import admin
from django.utils.translation import gettext_lazy as _
from .models import Article

class StatusFilter(admin.SimpleListFilter):
    """自定义状态过滤器"""
    title = _('文章状态')
    parameter_name = 'status_filter'
    
    def lookups(self, request, model_admin):
        return (
            ('published', _('已发布')),
            ('draft', _('草稿')),
            ('archived', _('已归档')),
        )
    
    def queryset(self, request, queryset):
        if self.value() == 'published':
            return queryset.filter(status='published')
        if self.value() == 'draft':
            return queryset.filter(status='draft')
        if self.value() == 'archived':
            return queryset.filter(status='archived')

class DateRangeFilter(admin.SimpleListFilter):
    """自定义日期范围过滤器"""
    title = _('创建时间')
    parameter_name = 'date_range'
    
    def lookups(self, request, model_admin):
        return (
            ('today', _('今天')),
            ('week', _('本周')),
            ('month', _('本月')),
            ('year', _('今年')),
        )
    
    def queryset(self, request, queryset):
        from django.utils import timezone
        from datetime import timedelta
        
        now = timezone.now()
        
        if self.value() == 'today':
            return queryset.filter(created_at__date=now.date())
        if self.value() == 'week':
            week_start = now - timedelta(days=now.weekday())
            return queryset.filter(created_at__gte=week_start)
        if self.value() == 'month':
            return queryset.filter(created_at__month=now.month)
        if self.value() == 'year':
            return queryset.filter(created_at__year=now.year)

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    list_filter = [StatusFilter, DateRangeFilter, 'category', 'author']
```

#### 3. 高级过滤器

```python
# admin.py
from django.contrib import admin
from django.db.models import Q
from .models import Article

class AdvancedFilter(admin.SimpleListFilter):
    """高级过滤器"""
    title = '高级过滤'
    parameter_name = 'advanced'
    
    def lookups(self, request, model_admin):
        return (
            ('popular', '热门文章'),
            ('recent', '最近更新'),
            ('no_comments', '无评论'),
            ('long_content', '长文章'),
        )
    
    def queryset(self, request, queryset):
        if self.value() == 'popular':
            return queryset.filter(views__gte=100)
        if self.value() == 'recent':
            from django.utils import timezone
            from datetime import timedelta
            week_ago = timezone.now() - timedelta(days=7)
            return queryset.filter(updated_at__gte=week_ago)
        if self.value() == 'no_comments':
            return queryset.filter(comments__isnull=True)
        if self.value() == 'long_content':
            return queryset.filter(content__length__gte=1000)
```

### 列表页搜索选项

#### 1. 基本搜索

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    # 搜索字段
    search_fields = [
        'title',        # 标题搜索
        'content',      # 内容搜索
        'author__username',  # 作者用户名搜索
        'category__name',    # 分类名称搜索
        'tags__name',        # 标签名称搜索
    ]
```

#### 2. 高级搜索

```python
# admin.py
from django.contrib import admin
from django.db.models import Q
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    search_fields = ['title', 'content', 'author__username']
    
    def get_search_results(self, request, queryset, search_term):
        """自定义搜索逻辑"""
        queryset, use_distinct = super().get_search_results(request, queryset, search_term)
        
        if search_term:
            # 添加额外的搜索条件
            queryset |= self.model.objects.filter(
                Q(author__email__icontains=search_term) |
                Q(category__description__icontains=search_term) |
                Q(tags__description__icontains=search_term)
            )
        
        return queryset, use_distinct
```

### 列表页排序选项

#### 1. 基本排序

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    # 默认排序
    ordering = ['-created_at']  # 按创建时间倒序
    
    # 可排序字段
    list_display_links = ['title']  # 可点击的字段
```

#### 2. 自定义排序

```python
# admin.py
from django.contrib import admin
from django.db.models import Count, Avg
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at', 'comment_count', 'avg_rating']
    
    def get_queryset(self, request):
        """自定义查询集，添加计算字段"""
        queryset = super().get_queryset(request)
        queryset = queryset.annotate(
            comment_count=Count('comments'),
            avg_rating=Avg('ratings__score')
        )
        return queryset
    
    def comment_count(self, obj):
        """评论数量"""
        return getattr(obj, 'comment_count', 0)
    comment_count.short_description = '评论数'
    comment_count.admin_order_field = 'comment_count'
    
    def avg_rating(self, obj):
        """平均评分"""
        avg = getattr(obj, 'avg_rating', 0)
        return f"{avg:.1f}" if avg else '-'
    avg_rating.short_description = '平均评分'
    avg_rating.admin_order_field = 'avg_rating'
```

### 列表页分页选项

#### 1. 基本分页

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    # 分页设置
    list_per_page = 20        # 每页显示数量
    list_max_show_all = 200   # 显示全部的最大数量
    show_full_result_count = True  # 显示完整的结果数量
```

#### 2. 动态分页

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    def get_list_per_page(self, request):
        """根据用户权限动态设置分页"""
        if request.user.is_superuser:
            return 50
        return 20
```

### 列表页操作选项

#### 1. 批量操作

```python
# admin.py
from django.contrib import admin
from django.contrib import messages
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    # 批量操作
    actions = ['make_published', 'make_draft', 'delete_selected']
    
    def make_published(self, request, queryset):
        """批量发布"""
        updated = queryset.update(status='published')
        self.message_user(
            request,
            f'成功发布 {updated} 篇文章。',
            messages.SUCCESS
        )
    make_published.short_description = "发布选中的文章"
    
    def make_draft(self, request, queryset):
        """批量设为草稿"""
        updated = queryset.update(status='draft')
        self.message_user(
            request,
            f'成功将 {updated} 篇文章设为草稿。',
            messages.SUCCESS
        )
    make_draft.short_description = "将选中的文章设为草稿"
```

#### 2. 自定义操作

```python
# admin.py
from django.contrib import admin
from django.http import HttpResponse
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    actions = ['export_as_csv', 'export_as_json']
    
    def export_as_csv(self, request, queryset):
        """导出为CSV"""
        import csv
        
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="articles.csv"'
        
        writer = csv.writer(response)
        writer.writerow(['ID', '标题', '作者', '分类', '状态', '创建时间'])
        
        for article in queryset:
            writer.writerow([
                article.id,
                article.title,
                article.author.username,
                article.category.name if article.category else '',
                article.get_status_display(),
                article.created_at.strftime('%Y-%m-%d %H:%M:%S')
            ])
        
        return response
    export_as_csv.short_description = "导出为CSV"
    
    def export_as_json(self, request, queryset):
        """导出为JSON"""
        import json
        
        data = []
        for article in queryset:
            data.append({
                'id': article.id,
                'title': article.title,
                'author': article.author.username,
                'category': article.category.name if article.category else '',
                'status': article.get_status_display(),
                'created_at': article.created_at.isoformat()
            })
        
        response = HttpResponse(json.dumps(data, ensure_ascii=False), content_type='application/json')
        response['Content-Disposition'] = 'attachment; filename="articles.json"'
        return response
    export_as_json.short_description = "导出为JSON"
```

### 列表页性能优化

#### 1. 查询优化

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    def get_queryset(self, request):
        """优化查询"""
        queryset = super().get_queryset(request)
        # 使用select_related减少数据库查询
        queryset = queryset.select_related('author', 'category')
        # 使用prefetch_related优化多对多关系
        queryset = queryset.prefetch_related('tags')
        return queryset
```

#### 2. 缓存优化

```python
# admin.py
from django.contrib import admin
from django.core.cache import cache
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    def get_queryset(self, request):
        """使用缓存的查询集"""
        cache_key = f"admin_articles_{request.user.id}_{request.GET.get('page', 1)}"
        queryset = cache.get(cache_key)
        
        if queryset is None:
            queryset = super().get_queryset(request)
            cache.set(cache_key, queryset, 300)  # 缓存5分钟
        
        return queryset
```

### 列表页样式定制

#### 1. 自定义CSS

```python
# admin.py
from django.contrib import admin
from .models import Article

@admin.register(Article)
class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'author', 'category', 'status', 'created_at']
    
    class Media:
        css = {
            'all': ('admin/css/custom_admin.css',)
        }
        js = ('admin/js/custom_admin.js',)
```

#### 2. 自定义模板

```html
<!-- templates/admin/myapp/article/change_list.html -->
{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    .field-status_colored span {
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
    }
    .field-status_colored .published {
        background-color: #d4edda;
        color: #155724;
    }
    .field-status_colored .draft {
        background-color: #fff3cd;
        color: #856404;
    }
</style>
{% endblock %}
```

## 小结

- **基础配置**：掌握列表页的基本配置方法
- **显示选项**：学会自定义字段显示格式
- **过滤选项**：了解各种过滤器的使用方法
- **搜索选项**：掌握搜索功能的配置
- **排序选项**：学会设置排序规则
- **分页选项**：了解分页配置
- **操作选项**：掌握批量操作和自定义操作
- **性能优化**：学会优化列表页性能
- **样式定制**：了解如何定制列表页样式

合理配置列表页选项可以大大提高Admin站点的使用效率和用户体验。