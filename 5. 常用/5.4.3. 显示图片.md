## 显示图片

Django中图片的显示是Web应用中的重要功能，包括图片的渲染、优化、缓存、响应式显示等。通过合理配置图片显示，可以提供更好的用户体验和性能优化。

### 基本图片显示

#### 1. 模板中显示图片

```html
<!-- templates/article_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="article-detail">
    <h1>{{ article.title }}</h1>
    
    {% if article.cover_image %}
        <div class="article-cover">
            <img src="{{ article.cover_image.url }}" 
                 alt="{{ article.title }}" 
                 class="cover-image"
                 loading="lazy">
        </div>
    {% endif %}
    
    <div class="article-content">
        {{ article.content|linebreaks }}
    </div>
</div>

<style>
    .article-detail {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .article-cover {
        margin: 20px 0;
        text-align: center;
    }
    
    .cover-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}
```

#### 2. 图片显示工具函数

```python
# utils.py
from django.utils.html import format_html
from django.conf import settings

def display_image(image_field, alt_text='', css_class='', width=None, height=None, lazy=True):
    """显示图片的工具函数"""
    if not image_field:
        return format_html('<span class="no-image">暂无图片</span>')
    
    attrs = []
    if css_class:
        attrs.append(f'class="{css_class}"')
    if alt_text:
        attrs.append(f'alt="{alt_text}"')
    if width:
        attrs.append(f'width="{width}"')
    if height:
        attrs.append(f'height="{height}"')
    if lazy:
        attrs.append('loading="lazy"')
    
    attrs_str = ' '.join(attrs)
    
    return format_html(
        '<img src="{}" {} />',
        image_field.url,
        format_html(attrs_str)
    )

def responsive_image(image_field, alt_text='', sizes='100vw', srcset=None):
    """响应式图片显示"""
    if not image_field:
        return format_html('<span class="no-image">暂无图片</span>')
    
    # 生成不同尺寸的图片URL
    if not srcset:
        srcset = [
            f"{image_field.url} 1x",
            f"{image_field.url.replace('.jpg', '@2x.jpg')} 2x",
            f"{image_field.url.replace('.jpg', '@3x.jpg')} 3x"
        ]
    
    srcset_str = ', '.join(srcset)
    
    return format_html(
        '<img src="{}" alt="{}" sizes="{}" srcset="{}" loading="lazy" />',
        image_field.url,
        alt_text,
        sizes,
        srcset_str
    )
```

### 图片优化显示

#### 1. 图片压缩和优化

```python
# image_utils.py
from PIL import Image
from django.core.files.storage import default_storage
from django.core.files.base import ContentFile
import io

class ImageOptimizer:
    """图片优化器"""
    
    @staticmethod
    def optimize_image(image_field, quality=85, max_width=None, max_height=None):
        """优化图片"""
        if not image_field:
            return None
        
        try:
            with Image.open(image_field.path) as img:
                # 转换为RGB模式
                if img.mode in ('RGBA', 'LA', 'P'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    if img.mode == 'RGBA':
                        background.paste(img, mask=img.split()[-1])
                    else:
                        background.paste(img)
                    img = background
                
                # 调整尺寸
                if max_width or max_height:
                    img.thumbnail((max_width or img.width, max_height or img.height), Image.Resampling.LANCZOS)
                
                # 保存优化后的图片
                output = io.BytesIO()
                img.save(output, format='JPEG', quality=quality, optimize=True)
                output.seek(0)
                
                return output.getvalue()
                
        except Exception as e:
            print(f"优化图片失败: {e}")
            return None
    
    @staticmethod
    def create_thumbnail(image_field, size=(200, 200), quality=85):
        """创建缩略图"""
        if not image_field:
            return None
        
        try:
            with Image.open(image_field.path) as img:
                # 保持宽高比
                img.thumbnail(size, Image.Resampling.LANCZOS)
                
                # 保存缩略图
                output = io.BytesIO()
                img.save(output, format='JPEG', quality=quality, optimize=True)
                output.seek(0)
                
                return output.getvalue()
                
        except Exception as e:
            print(f"创建缩略图失败: {e}")
            return None
```

#### 2. 图片格式转换

```python
# image_utils.py
from PIL import Image
import io

class ImageConverter:
    """图片格式转换器"""
    
    @staticmethod
    def convert_to_webp(image_field, quality=85):
        """转换为WebP格式"""
        if not image_field:
            return None
        
        try:
            with Image.open(image_field.path) as img:
                # 转换为RGB模式
                if img.mode in ('RGBA', 'LA', 'P'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    if img.mode == 'RGBA':
                        background.paste(img, mask=img.split()[-1])
                    else:
                        background.paste(img)
                    img = background
                
                # 保存为WebP格式
                output = io.BytesIO()
                img.save(output, format='WebP', quality=quality, optimize=True)
                output.seek(0)
                
                return output.getvalue()
                
        except Exception as e:
            print(f"转换为WebP失败: {e}")
            return None
    
    @staticmethod
    def convert_to_avif(image_field, quality=85):
        """转换为AVIF格式（如果支持）"""
        if not image_field:
            return None
        
        try:
            with Image.open(image_field.path) as img:
                # 转换为RGB模式
                if img.mode in ('RGBA', 'LA', 'P'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    if img.mode == 'RGBA':
                        background.paste(img, mask=img.split()[-1])
                    else:
                        background.paste(img)
                    img = background
                
                # 保存为AVIF格式
                output = io.BytesIO()
                img.save(output, format='AVIF', quality=quality)
                output.seek(0)
                
                return output.getvalue()
                
        except Exception as e:
            print(f"转换为AVIF失败: {e}")
            return None
```

### 响应式图片显示

#### 1. 响应式图片模板标签

```python
# templatetags/image_tags.py
from django import template
from django.utils.html import format_html
from django.conf import settings

register = template.Library()

@register.simple_tag
def responsive_image(image_field, alt_text='', class_name=''):
    """响应式图片模板标签"""
    if not image_field:
        return format_html('<span class="no-image">暂无图片</span>')
    
    # 生成不同尺寸的图片URL
    base_url = image_field.url
    srcset = [
        f"{base_url} 1x",
        f"{base_url.replace('.jpg', '@2x.jpg')} 2x",
        f"{base_url.replace('.jpg', '@3x.jpg')} 3x"
    ]
    
    return format_html(
        '<img src="{}" alt="{}" class="{}" sizes="100vw" srcset="{}" loading="lazy" />',
        base_url,
        alt_text,
        class_name,
        ', '.join(srcset)
    )

@register.simple_tag
def picture_element(image_field, alt_text='', class_name=''):
    """Picture元素模板标签"""
    if not image_field:
        return format_html('<span class="no-image">暂无图片</span>')
    
    base_url = image_field.url
    
    return format_html(
        '<picture class="{}">'
        '<source srcset="{}" type="image/webp">'
        '<source srcset="{}" type="image/avif">'
        '<img src="{}" alt="{}" loading="lazy">'
        '</picture>',
        class_name,
        base_url.replace('.jpg', '.webp'),
        base_url.replace('.jpg', '.avif'),
        base_url,
        alt_text
    )
```

#### 2. 响应式图片CSS

```css
/* static/css/responsive-images.css */

/* 基础响应式图片样式 */
.responsive-image {
    max-width: 100%;
    height: auto;
    display: block;
}

/* 不同屏幕尺寸的图片显示 */
@media (max-width: 768px) {
    .mobile-optimized {
        width: 100%;
        height: auto;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .tablet-optimized {
        width: 80%;
        height: auto;
    }
}

@media (min-width: 1025px) {
    .desktop-optimized {
        width: 60%;
        height: auto;
    }
}

/* 图片容器样式 */
.image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.image-container img {
    transition: transform 0.3s ease;
}

.image-container:hover img {
    transform: scale(1.05);
}

/* 懒加载占位符 */
.lazy-placeholder {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
```

### 图片懒加载

#### 1. 懒加载实现

```html
<!-- templates/lazy_loading.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<style>
    .lazy-image {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .lazy-image.loaded {
        opacity: 1;
    }
    
    .lazy-placeholder {
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="image-gallery">
    {% for image in images %}
        <div class="image-item">
            <img class="lazy-image" 
                 data-src="{{ image.url }}" 
                 alt="{{ image.alt_text }}"
                 loading="lazy"
                 width="300" 
                 height="200">
            <div class="lazy-placeholder">加载中...</div>
        </div>
    {% endfor %}
</div>

<script>
class LazyLoader {
    constructor() {
        this.images = document.querySelectorAll('.lazy-image');
        this.observer = null;
        this.init();
    }
    
    init() {
        if ('IntersectionObserver' in window) {
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadImage(entry.target);
                        this.observer.unobserve(entry.target);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });
            
            this.images.forEach(img => {
                this.observer.observe(img);
            });
        } else {
            // 降级处理
            this.loadAllImages();
        }
    }
    
    loadImage(img) {
        const src = img.dataset.src;
        if (!src) return;
        
        // 创建新图片对象
        const newImg = new Image();
        newImg.onload = () => {
            img.src = src;
            img.classList.add('loaded');
            
            // 隐藏占位符
            const placeholder = img.nextElementSibling;
            if (placeholder && placeholder.classList.contains('lazy-placeholder')) {
                placeholder.style.display = 'none';
            }
        };
        
        newImg.onerror = () => {
            img.src = '/static/images/placeholder.jpg';
            img.classList.add('loaded');
        };
        
        newImg.src = src;
    }
    
    loadAllImages() {
        this.images.forEach(img => {
            this.loadImage(img);
        });
    }
}

// 初始化懒加载
document.addEventListener('DOMContentLoaded', () => {
    new LazyLoader();
});
</script>
{% endblock %}
```

#### 2. 高级懒加载组件

```python
# views.py
from django.core.paginator import Paginator
from django.shortcuts import render

def lazy_loading_gallery(request):
    """懒加载图片画廊"""
    page = request.GET.get('page', 1)
    images_per_page = 12
    
    # 获取所有图片
    all_images = Image.objects.filter(is_active=True).order_by('-created_at')
    
    # 分页
    paginator = Paginator(all_images, images_per_page)
    images = paginator.get_page(page)
    
    # 检查是否有更多图片
    has_next = images.has_next()
    
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        # AJAX请求，返回JSON
        return JsonResponse({
            'images': [
                {
                    'url': image.image.url,
                    'alt': image.alt_text,
                    'title': image.title
                } for image in images
            ],
            'has_next': has_next,
            'next_page': images.next_page_number() if has_next else None
        })
    
    return render(request, 'lazy_loading_gallery.html', {
        'images': images,
        'has_next': has_next
    })
```

### 图片缓存和CDN

#### 1. 图片缓存配置

```python
# settings.py

# 图片缓存配置
IMAGE_CACHE_TIMEOUT = 60 * 60 * 24 * 30  # 30天

# CDN配置
CDN_URL = 'https://cdn.example.com/'
USE_CDN = True

# 图片处理配置
IMAGE_PROCESSING = {
    'THUMBNAIL_SIZE': (200, 200),
    'MEDIUM_SIZE': (800, 600),
    'LARGE_SIZE': (1200, 800),
    'QUALITY': 85,
    'FORMATS': ['JPEG', 'WebP', 'AVIF']
}
```

#### 2. 图片缓存中间件

```python
# middleware.py
from django.core.cache import cache
from django.http import HttpResponse
from django.utils.cache import get_cache_key, learn_cache_key
import hashlib

class ImageCacheMiddleware:
    """图片缓存中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # 检查是否是图片请求
        if self.is_image_request(request):
            # 尝试从缓存获取
            cached_response = self.get_cached_response(request)
            if cached_response:
                return cached_response
        
        response = self.get_response(request)
        
        # 缓存图片响应
        if self.is_image_request(request) and response.status_code == 200:
            self.cache_response(request, response)
        
        return response
    
    def is_image_request(self, request):
        """检查是否是图片请求"""
        path = request.path.lower()
        return any(ext in path for ext in ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.avif'])
    
    def get_cached_response(self, request):
        """从缓存获取响应"""
        cache_key = self.generate_cache_key(request)
        return cache.get(cache_key)
    
    def cache_response(self, request, response):
        """缓存响应"""
        cache_key = self.generate_cache_key(request)
        cache.set(cache_key, response, 60 * 60 * 24 * 30)  # 30天
    
    def generate_cache_key(self, request):
        """生成缓存键"""
        path = request.path
        user_agent = request.META.get('HTTP_USER_AGENT', '')
        
        # 生成哈希键
        key_data = f"{path}:{user_agent}"
        return hashlib.md5(key_data.encode()).hexdigest()
```

#### 3. CDN图片URL生成

```python
# utils.py
from django.conf import settings
from django.utils.html import format_html

def get_cdn_url(image_field):
    """获取CDN URL"""
    if not image_field:
        return None
    
    if getattr(settings, 'USE_CDN', False):
        cdn_url = getattr(settings, 'CDN_URL', '')
        if cdn_url:
            return f"{cdn_url.rstrip('/')}/{image_field.name}"
    
    return image_field.url

def cdn_image(image_field, alt_text='', class_name=''):
    """CDN图片显示"""
    if not image_field:
        return format_html('<span class="no-image">暂无图片</span>')
    
    url = get_cdn_url(image_field)
    
    return format_html(
        '<img src="{}" alt="{}" class="{}" loading="lazy" />',
        url,
        alt_text,
        class_name
    )
```

### 图片错误处理

#### 1. 图片错误处理模板标签

```python
# templatetags/image_tags.py
from django import template
from django.utils.html import format_html

register = template.Library()

@register.simple_tag
def safe_image(image_field, alt_text='', fallback_url='/static/images/placeholder.jpg'):
    """安全图片显示，包含错误处理"""
    if not image_field:
        return format_html(
            '<img src="{}" alt="{}" class="placeholder-image" />',
            fallback_url,
            alt_text
        )
    
    return format_html(
        '<img src="{}" alt="{}" onerror="this.src=\'{}\'; this.onerror=null;" />',
        image_field.url,
        alt_text,
        fallback_url
    )

@register.simple_tag
def image_with_fallback(image_field, alt_text='', fallback_text='图片加载失败'):
    """带回退的图片显示"""
    if not image_field:
        return format_html(
            '<div class="image-fallback">{}</div>',
            fallback_text
        )
    
    return format_html(
        '<img src="{}" alt="{}" onerror="this.style.display=\'none\'; '
        'this.nextElementSibling.style.display=\'block\';" />'
        '<div class="image-fallback" style="display: none;">{}</div>',
        image_field.url,
        alt_text,
        fallback_text
    )
```

#### 2. 图片错误处理CSS

```css
/* static/css/image-error.css */

.placeholder-image {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 14px;
    min-height: 200px;
}

.image-fallback {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-size: 14px;
}

.image-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 10px;
    color: #721c24;
    font-size: 12px;
    margin-top: 5px;
}

/* 图片加载动画 */
.image-loading {
    position: relative;
    background: #f8f9fa;
    overflow: hidden;
}

.image-loading::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: loading-shimmer 1.5s infinite;
}

@keyframes loading-shimmer {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}
```

### 图片性能优化

#### 1. 图片预加载

```html
<!-- templates/image_preload.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- 预加载关键图片 -->
<link rel="preload" as="image" href="{{ hero_image.url }}">
<link rel="preload" as="image" href="{{ logo.url }}">

<!-- 预连接到CDN -->
<link rel="preconnect" href="https://cdn.example.com">
<link rel="dns-prefetch" href="https://cdn.example.com">
{% endblock %}

{% block content %}
<div class="hero-section">
    <img src="{{ hero_image.url }}" alt="Hero Image" class="hero-image">
</div>

<div class="content-section">
    {% for image in images %}
        <img src="{{ image.url }}" 
             alt="{{ image.alt_text }}" 
             loading="lazy"
             decoding="async">
    {% endfor %}
</div>
{% endblock %}
```

#### 2. 图片性能监控

```python
# utils.py
import time
from django.core.cache import cache

class ImagePerformanceMonitor:
    """图片性能监控"""
    
    @staticmethod
    def track_image_load(image_url, load_time):
        """跟踪图片加载时间"""
        cache_key = f"image_performance:{image_url}"
        
        # 获取历史数据
        history = cache.get(cache_key, [])
        history.append({
            'load_time': load_time,
            'timestamp': time.time()
        })
        
        # 只保留最近100次记录
        if len(history) > 100:
            history = history[-100:]
        
        cache.set(cache_key, history, 60 * 60 * 24)  # 1天
    
    @staticmethod
    def get_average_load_time(image_url):
        """获取平均加载时间"""
        cache_key = f"image_performance:{image_url}"
        history = cache.get(cache_key, [])
        
        if not history:
            return 0
        
        total_time = sum(item['load_time'] for item in history)
        return total_time / len(history)
    
    @staticmethod
    def get_slow_images(threshold=2.0):
        """获取加载缓慢的图片"""
        slow_images = []
        
        # 这里需要根据实际缓存键模式来获取所有图片性能数据
        # 简化示例
        return slow_images
```

## 小结

- **基本显示**：掌握图片的基本显示方法
- **图片优化**：了解图片压缩和格式转换
- **响应式显示**：学会实现响应式图片显示
- **懒加载**：掌握图片懒加载的实现
- **缓存和CDN**：了解图片缓存和CDN配置
- **错误处理**：学会处理图片显示错误
- **性能优化**：掌握图片性能优化方法

通过合理配置图片显示，可以提供更好的用户体验和性能优化。