## 上传图片

Django提供了强大的文件上传功能，特别是图片上传。通过合理配置和使用，可以轻松实现图片上传、处理、存储和显示功能。图片上传是Web应用中常见的功能，如用户头像、文章配图、产品图片等。

### 图片上传基础

#### 1. 基本配置

```python
# settings.py

# 媒体文件配置
MEDIA_URL = '/media/'  # 媒体文件的URL前缀
MEDIA_ROOT = BASE_DIR / 'media'  # 媒体文件的存储目录

# 文件上传配置
FILE_UPLOAD_HANDLERS = [
    'django.core.files.uploadhandler.MemoryFileUploadHandler',
    'django.core.files.uploadhandler.TemporaryFileUploadHandler',
]

# 最大上传文件大小（2.5MB）
DATA_UPLOAD_MAX_MEMORY_SIZE = 2621440

# 允许的文件类型
ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
```

#### 2. URL配置

```python
# urls.py
from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('myapp.urls')),
]

# 开发环境媒体文件服务
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

### 模型配置

#### 1. 基本图片字段

```python
# models.py
from django.db import models
from django.contrib.auth.models import User

class Article(models.Model):
    title = models.CharField(max_length=200, verbose_name='标题')
    content = models.TextField(verbose_name='内容')
    cover_image = models.ImageField(
        upload_to='articles/covers/',
        verbose_name='封面图片',
        blank=True,
        null=True
    )
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    
    class Meta:
        verbose_name = '文章'
        verbose_name_plural = '文章'
    
    def __str__(self):
        return self.title

class UserProfile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, verbose_name='用户')
    avatar = models.ImageField(
        upload_to='avatars/',
        verbose_name='头像',
        blank=True,
        null=True
    )
    bio = models.TextField(max_length=500, blank=True, verbose_name='个人简介')
    
    class Meta:
        verbose_name = '用户资料'
        verbose_name_plural = '用户资料'
    
    def __str__(self):
        return f"{self.user.username}的资料"
```

#### 2. 高级图片字段

```python
# models.py
import os
from django.db import models
from django.core.files.storage import default_storage
from PIL import Image

def article_image_path(instance, filename):
    """生成文章图片路径"""
    # 获取文件扩展名
    ext = filename.split('.')[-1]
    # 生成新文件名
    new_filename = f"{instance.id}_{instance.title[:20]}.{ext}"
    return os.path.join('articles', 'images', new_filename)

class Article(models.Model):
    title = models.CharField(max_length=200, verbose_name='标题')
    content = models.TextField(verbose_name='内容')
    
    # 封面图片
    cover_image = models.ImageField(
        upload_to=article_image_path,
        verbose_name='封面图片',
        blank=True,
        null=True,
        help_text='建议尺寸：800x600像素'
    )
    
    # 缩略图（自动生成）
    thumbnail = models.ImageField(
        upload_to='articles/thumbnails/',
        verbose_name='缩略图',
        blank=True,
        null=True
    )
    
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    
    def save(self, *args, **kwargs):
        # 先保存以获取ID
        super().save(*args, **kwargs)
        
        # 如果有封面图片，生成缩略图
        if self.cover_image:
            self.generate_thumbnail()
    
    def generate_thumbnail(self):
        """生成缩略图"""
        if self.cover_image:
            try:
                # 打开原图
                img = Image.open(self.cover_image.path)
                
                # 调整尺寸为200x150
                img.thumbnail((200, 150), Image.Resampling.LANCZOS)
                
                # 保存缩略图
                thumbnail_path = f'articles/thumbnails/{self.id}_thumb.jpg'
                img.save(default_storage.path(thumbnail_path), 'JPEG', quality=85)
                
                # 更新模型字段
                self.thumbnail.name = thumbnail_path
                super().save(update_fields=['thumbnail'])
                
            except Exception as e:
                print(f"生成缩略图失败: {e}")
    
    def delete(self, *args, **kwargs):
        # 删除文件
        if self.cover_image:
            if os.path.exists(self.cover_image.path):
                os.remove(self.cover_image.path)
        
        if self.thumbnail:
            if os.path.exists(self.thumbnail.path):
                os.remove(self.thumbnail.path)
        
        super().delete(*args, **kwargs)
```

### 表单配置

#### 1. 基本图片上传表单

```python
# forms.py
from django import forms
from .models import Article, UserProfile

class ArticleForm(forms.ModelForm):
    """文章表单"""
    
    class Meta:
        model = Article
        fields = ['title', 'content', 'cover_image']
        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': '请输入文章标题'
            }),
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 10,
                'placeholder': '请输入文章内容'
            }),
            'cover_image': forms.FileInput(attrs={
                'class': 'form-control-file',
                'accept': 'image/*'
            })
        }
    
    def clean_cover_image(self):
        """验证封面图片"""
        image = self.cleaned_data.get('cover_image')
        
        if image:
            # 检查文件大小（5MB）
            if image.size > 5 * 1024 * 1024:
                raise forms.ValidationError('图片大小不能超过5MB')
            
            # 检查文件类型
            allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
            if image.content_type not in allowed_types:
                raise forms.ValidationError('只支持JPEG、PNG、GIF、WebP格式的图片')
            
            # 检查图片尺寸
            from PIL import Image
            try:
                img = Image.open(image)
                width, height = img.size
                if width > 4000 or height > 4000:
                    raise forms.ValidationError('图片尺寸不能超过4000x4000像素')
            except Exception:
                raise forms.ValidationError('无法读取图片文件')
        
        return image

class UserProfileForm(forms.ModelForm):
    """用户资料表单"""
    
    class Meta:
        model = UserProfile
        fields = ['avatar', 'bio']
        widgets = {
            'avatar': forms.FileInput(attrs={
                'class': 'form-control-file',
                'accept': 'image/*'
            }),
            'bio': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': '请输入个人简介'
            })
        }
```

#### 2. 高级图片上传表单

```python
# forms.py
from django import forms
from django.core.files.uploadedfile import UploadedFile
from PIL import Image
import io

class AdvancedImageUploadForm(forms.Form):
    """高级图片上传表单"""
    
    image = forms.ImageField(
        label='选择图片',
        help_text='支持JPEG、PNG、GIF、WebP格式，最大5MB'
    )
    
    crop_x = forms.IntegerField(required=False, widget=forms.HiddenInput())
    crop_y = forms.IntegerField(required=False, widget=forms.HiddenInput())
    crop_width = forms.IntegerField(required=False, widget=forms.HiddenInput())
    crop_height = forms.IntegerField(required=False, widget=forms.HiddenInput())
    
    def clean_image(self):
        """验证和预处理图片"""
        image = self.cleaned_data.get('image')
        
        if image:
            # 基本验证
            if image.size > 5 * 1024 * 1024:
                raise forms.ValidationError('图片大小不能超过5MB')
            
            # 处理图片
            try:
                img = Image.open(image)
                
                # 转换为RGB模式（如果是RGBA）
                if img.mode in ('RGBA', 'LA'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
                    img = background
                
                # 调整图片大小（如果太大）
                max_size = (1920, 1080)
                if img.size[0] > max_size[0] or img.size[1] > max_size[1]:
                    img.thumbnail(max_size, Image.Resampling.LANCZOS)
                
                # 保存处理后的图片
                output = io.BytesIO()
                img.save(output, format='JPEG', quality=85, optimize=True)
                output.seek(0)
                
                # 创建新的UploadedFile
                processed_image = UploadedFile(
                    file=output,
                    name=image.name,
                    content_type='image/jpeg',
                    size=len(output.getvalue())
                )
                
                return processed_image
                
            except Exception as e:
                raise forms.ValidationError(f'图片处理失败: {str(e)}')
        
        return image
    
    def save_image(self, upload_to='uploads/'):
        """保存图片"""
        from django.core.files.storage import default_storage
        from django.core.files.base import ContentFile
        
        image = self.cleaned_data.get('image')
        if not image:
            return None
        
        # 生成文件名
        import uuid
        filename = f"{uuid.uuid4().hex}.jpg"
        filepath = f"{upload_to}{filename}"
        
        # 保存文件
        default_storage.save(filepath, ContentFile(image.read()))
        
        return filepath
```

### 视图处理

#### 1. 基本图片上传视图

```python
# views.py
from django.shortcuts import render, redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from .forms import ArticleForm, UserProfileForm
from .models import Article, UserProfile

@login_required
def upload_article(request):
    """上传文章（包含图片）"""
    if request.method == 'POST':
        form = ArticleForm(request.POST, request.FILES)
        if form.is_valid():
            article = form.save(commit=False)
            article.author = request.user
            article.save()
            
            messages.success(request, '文章发布成功！')
            return redirect('article_detail', article.id)
    else:
        form = ArticleForm()
    
    return render(request, 'upload_article.html', {'form': form})

@login_required
def upload_avatar(request):
    """上传头像"""
    try:
        profile = request.user.userprofile
    except UserProfile.DoesNotExist:
        profile = UserProfile.objects.create(user=request.user)
    
    if request.method == 'POST':
        form = UserProfileForm(request.POST, request.FILES, instance=profile)
        if form.is_valid():
            form.save()
            messages.success(request, '头像更新成功！')
            return redirect('profile')
    else:
        form = UserProfileForm(instance=profile)
    
    return render(request, 'upload_avatar.html', {'form': form})
```

#### 2. AJAX图片上传视图

```python
# views.py
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
import json

@csrf_exempt
@require_http_methods(["POST"])
def ajax_upload_image(request):
    """AJAX图片上传"""
    try:
        if 'image' not in request.FILES:
            return JsonResponse({
                'success': False,
                'error': '没有选择图片'
            })
        
        image_file = request.FILES['image']
        
        # 验证文件
        if image_file.size > 5 * 1024 * 1024:
            return JsonResponse({
                'success': False,
                'error': '图片大小不能超过5MB'
            })
        
        # 保存图片
        from django.core.files.storage import default_storage
        import uuid
        
        filename = f"{uuid.uuid4().hex}.jpg"
        filepath = f"uploads/{filename}"
        
        default_storage.save(filepath, image_file)
        
        return JsonResponse({
            'success': True,
            'url': default_storage.url(filepath),
            'filename': filename
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        })

@require_http_methods(["POST"])
def crop_image(request):
    """裁剪图片"""
    try:
        data = json.loads(request.body)
        image_url = data.get('image_url')
        crop_data = data.get('crop_data')
        
        if not image_url or not crop_data:
            return JsonResponse({
                'success': False,
                'error': '参数不完整'
            })
        
        # 处理图片裁剪
        from PIL import Image
        from django.core.files.storage import default_storage
        
        # 获取图片路径
        image_path = default_storage.path(image_url.replace('/media/', ''))
        
        # 打开图片
        img = Image.open(image_path)
        
        # 裁剪图片
        cropped_img = img.crop((
            crop_data['x'],
            crop_data['y'],
            crop_data['x'] + crop_data['width'],
            crop_data['y'] + crop_data['height']
        ))
        
        # 保存裁剪后的图片
        import uuid
        filename = f"{uuid.uuid4().hex}_cropped.jpg"
        filepath = f"uploads/{filename}"
        
        cropped_img.save(default_storage.path(filepath), 'JPEG', quality=85)
        
        return JsonResponse({
            'success': True,
            'url': default_storage.url(filepath)
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        })
```

### 模板显示

#### 1. 基本图片显示模板

```html
<!-- templates/article_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="article-detail">
    <h1>{{ article.title }}</h1>
    
    {% if article.cover_image %}
        <div class="article-cover">
            <img src="{{ article.cover_image.url }}" 
                 alt="{{ article.title }}" 
                 class="cover-image">
        </div>
    {% endif %}
    
    <div class="article-content">
        {{ article.content|linebreaks }}
    </div>
    
    <div class="article-meta">
        <p>作者: {{ article.author.username }}</p>
        <p>发布时间: {{ article.created_at|date:"Y-m-d H:i" }}</p>
    </div>
</div>

<style>
    .article-detail {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .article-cover {
        margin: 20px 0;
        text-align: center;
    }
    
    .cover-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .article-content {
        line-height: 1.8;
        font-size: 16px;
        margin: 30px 0;
    }
    
    .article-meta {
        color: #666;
        font-size: 14px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
</style>
{% endblock %}
```

#### 2. 图片上传表单模板

```html
<!-- templates/upload_article.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<style>
    .upload-form {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .form-control:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .image-preview {
        margin-top: 10px;
        text-align: center;
    }
    
    .image-preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .btn:hover {
        background: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-form">
    <h2>发布文章</h2>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">标题</label>
            {{ form.title }}
            {% if form.title.errors %}
                <div class="error">{{ form.title.errors.0 }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.cover_image.id_for_label }}">封面图片</label>
            {{ form.cover_image }}
            {% if form.cover_image.errors %}
                <div class="error">{{ form.cover_image.errors.0 }}</div>
            {% endif %}
            <div class="image-preview" id="image-preview"></div>
        </div>
        
        <div class="form-group">
            <label for="{{ form.content.id_for_label }}">内容</label>
            {{ form.content }}
            {% if form.content.errors %}
                <div class="error">{{ form.content.errors.0 }}</div>
            {% endif %}
        </div>
        
        <button type="submit" class="btn">发布文章</button>
    </form>
</div>

<script>
    // 图片预览功能
    document.getElementById('{{ form.cover_image.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('image-preview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="预览">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '';
        }
    });
</script>
{% endblock %}
```

### 图片处理工具

#### 1. 图片处理工具类

```python
# utils.py
from PIL import Image
import os
from django.core.files.storage import default_storage
from django.core.files.base import ContentFile
import io

class ImageProcessor:
    """图片处理工具类"""
    
    @staticmethod
    def resize_image(image_path, size, quality=85):
        """调整图片尺寸"""
        try:
            with Image.open(image_path) as img:
                # 保持宽高比
                img.thumbnail(size, Image.Resampling.LANCZOS)
                
                # 保存调整后的图片
                output = io.BytesIO()
                img.save(output, format='JPEG', quality=quality, optimize=True)
                output.seek(0)
                
                return output
        except Exception as e:
            print(f"调整图片尺寸失败: {e}")
            return None
    
    @staticmethod
    def crop_image(image_path, crop_box, quality=85):
        """裁剪图片"""
        try:
            with Image.open(image_path) as img:
                # 裁剪图片
                cropped_img = img.crop(crop_box)
                
                # 保存裁剪后的图片
                output = io.BytesIO()
                cropped_img.save(output, format='JPEG', quality=quality, optimize=True)
                output.seek(0)
                
                return output
        except Exception as e:
            print(f"裁剪图片失败: {e}")
            return None
    
    @staticmethod
    def add_watermark(image_path, watermark_path, position='bottom-right', opacity=0.5):
        """添加水印"""
        try:
            with Image.open(image_path) as img:
                with Image.open(watermark_path) as watermark:
                    # 调整水印大小
                    watermark_size = (img.width // 4, img.height // 4)
                    watermark.thumbnail(watermark_size, Image.Resampling.LANCZOS)
                    
                    # 设置水印透明度
                    watermark.putalpha(int(255 * opacity))
                    
                    # 计算水印位置
                    if position == 'bottom-right':
                        position = (img.width - watermark.width, img.height - watermark.height)
                    elif position == 'top-left':
                        position = (0, 0)
                    elif position == 'center':
                        position = ((img.width - watermark.width) // 2, (img.height - watermark.height) // 2)
                    
                    # 粘贴水印
                    img.paste(watermark, position, watermark)
                    
                    # 保存图片
                    output = io.BytesIO()
                    img.save(output, format='JPEG', quality=85, optimize=True)
                    output.seek(0)
                    
                    return output
        except Exception as e:
            print(f"添加水印失败: {e}")
            return None
    
    @staticmethod
    def optimize_image(image_path, quality=85):
        """优化图片"""
        try:
            with Image.open(image_path) as img:
                # 转换为RGB模式
                if img.mode in ('RGBA', 'LA'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
                    img = background
                
                # 保存优化后的图片
                output = io.BytesIO()
                img.save(output, format='JPEG', quality=quality, optimize=True)
                output.seek(0)
                
                return output
        except Exception as e:
            print(f"优化图片失败: {e}")
            return None
```

#### 2. 图片处理中间件

```python
# middleware.py
from django.core.files.storage import default_storage
from .utils import ImageProcessor
import os

class ImageProcessingMiddleware:
    """图片处理中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        response = self.get_response(request)
        return response
    
    def process_view(self, request, view_func, view_args, view_kwargs):
        """处理视图"""
        if request.method == 'POST' and 'image' in request.FILES:
            # 处理上传的图片
            image_file = request.FILES['image']
            
            # 优化图片
            optimized_image = ImageProcessor.optimize_image(image_file.temporary_file_path())
            
            if optimized_image:
                # 替换原始文件
                image_file.file = optimized_image
                image_file.size = len(optimized_image.getvalue())
        
        return None
```

### 安全考虑

#### 1. 文件类型验证

```python
# security.py
import magic
from django.core.exceptions import ValidationError

def validate_image_file(file):
    """验证图片文件"""
    # 检查文件头
    file_content = file.read(1024)
    file.seek(0)  # 重置文件指针
    
    mime_type = magic.from_buffer(file_content, mime=True)
    
    allowed_types = [
        'image/jpeg',
        'image/png',
        'image/gif',
        'image/webp'
    ]
    
    if mime_type not in allowed_types:
        raise ValidationError('不支持的文件类型')
    
    # 检查文件扩展名
    allowed_extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
    file_extension = os.path.splitext(file.name)[1].lower()
    
    if file_extension not in allowed_extensions:
        raise ValidationError('不支持的文件扩展名')
    
    return True
```

#### 2. 文件大小限制

```python
# security.py
def validate_file_size(file, max_size_mb=5):
    """验证文件大小"""
    max_size_bytes = max_size_mb * 1024 * 1024
    
    if file.size > max_size_bytes:
        raise ValidationError(f'文件大小不能超过{max_size_mb}MB')
    
    return True
```

## 小结

- **基础配置**：掌握图片上传的基本配置方法
- **模型设计**：学会在模型中配置图片字段
- **表单处理**：了解图片上传表单的创建和验证
- **视图处理**：掌握图片上传的视图逻辑
- **模板显示**：学会在模板中显示上传的图片
- **图片处理**：了解图片处理工具的使用
- **安全考虑**：掌握图片上传的安全验证

合理使用Django的图片上传功能可以构建功能完整、安全可靠的图片管理系统。
