## 示例：省市区选择

省市区选择是Web应用中常见的功能，通常用于用户注册、地址管理、数据筛选等场景。本示例将展示如何使用Django实现一个完整的省市区三级联动选择功能。

### 模型设计

#### 1. 省市区模型

```python
# models.py
from django.db import models

class Province(models.Model):
    """省份模型"""
    name = models.CharField(max_length=50, verbose_name='省份名称')
    code = models.CharField(max_length=10, unique=True, verbose_name='省份代码')
    is_active = models.BooleanField(default=True, verbose_name='是否启用')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    
    class Meta:
        verbose_name = '省份'
        verbose_name_plural = '省份'
        ordering = ['code']
    
    def __str__(self):
        return self.name

class City(models.Model):
    """城市模型"""
    province = models.ForeignKey(Province, on_delete=models.CASCADE, related_name='cities', verbose_name='所属省份')
    name = models.CharField(max_length=50, verbose_name='城市名称')
    code = models.CharField(max_length=10, verbose_name='城市代码')
    is_active = models.BooleanField(default=True, verbose_name='是否启用')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    
    class Meta:
        verbose_name = '城市'
        verbose_name_plural = '城市'
        ordering = ['code']
        unique_together = ['province', 'code']
    
    def __str__(self):
        return f"{self.province.name} - {self.name}"

class District(models.Model):
    """区县模型"""
    city = models.ForeignKey(City, on_delete=models.CASCADE, related_name='districts', verbose_name='所属城市')
    name = models.CharField(max_length=50, verbose_name='区县名称')
    code = models.CharField(max_length=10, verbose_name='区县代码')
    is_active = models.BooleanField(default=True, verbose_name='是否启用')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    
    class Meta:
        verbose_name = '区县'
        verbose_name_plural = '区县'
        ordering = ['code']
        unique_together = ['city', 'code']
    
    def __str__(self):
        return f"{self.city.province.name} - {self.city.name} - {self.name}"

class Address(models.Model):
    """地址模型"""
    user = models.ForeignKey('auth.User', on_delete=models.CASCADE, verbose_name='用户')
    province = models.ForeignKey(Province, on_delete=models.CASCADE, verbose_name='省份')
    city = models.ForeignKey(City, on_delete=models.CASCADE, verbose_name='城市')
    district = models.ForeignKey(District, on_delete=models.CASCADE, verbose_name='区县')
    detail_address = models.CharField(max_length=200, verbose_name='详细地址')
    is_default = models.BooleanField(default=False, verbose_name='是否默认地址')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新时间')
    
    class Meta:
        verbose_name = '地址'
        verbose_name_plural = '地址'
        ordering = ['-is_default', '-created_at']
    
    def __str__(self):
        return f"{self.province.name} {self.city.name} {self.district.name} {self.detail_address}"
    
    @property
    def full_address(self):
        """完整地址"""
        return f"{self.province.name} {self.city.name} {self.district.name} {self.detail_address}"
```

#### 2. 数据迁移

```bash
python manage.py makemigrations
python manage.py migrate
```

### 视图实现

#### 1. API视图

```python
# views.py
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.views.decorators.csrf import csrf_exempt
from .models import Province, City, District

@require_http_methods(["GET"])
def get_provinces(request):
    """获取所有省份"""
    provinces = Province.objects.filter(is_active=True).values('id', 'name', 'code')
    return JsonResponse({
        'success': True,
        'data': list(provinces)
    })

@require_http_methods(["GET"])
def get_cities(request):
    """根据省份获取城市"""
    province_id = request.GET.get('province_id')
    
    if not province_id:
        return JsonResponse({
            'success': False,
            'message': '省份ID不能为空'
        })
    
    try:
        cities = City.objects.filter(
            province_id=province_id,
            is_active=True
        ).values('id', 'name', 'code')
        
        return JsonResponse({
            'success': True,
            'data': list(cities)
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': str(e)
        })

@require_http_methods(["GET"])
def get_districts(request):
    """根据城市获取区县"""
    city_id = request.GET.get('city_id')
    
    if not city_id:
        return JsonResponse({
            'success': False,
            'message': '城市ID不能为空'
        })
    
    try:
        districts = District.objects.filter(
            city_id=city_id,
            is_active=True
        ).values('id', 'name', 'code')
        
        return JsonResponse({
            'success': True,
            'data': list(districts)
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': str(e)
        })

@require_http_methods(["GET"])
def get_full_address(request):
    """根据省市区ID获取完整地址信息"""
    province_id = request.GET.get('province_id')
    city_id = request.GET.get('city_id')
    district_id = request.GET.get('district_id')
    
    try:
        address_info = {}
        
        if province_id:
            province = Province.objects.get(id=province_id)
            address_info['province'] = {
                'id': province.id,
                'name': province.name,
                'code': province.code
            }
        
        if city_id:
            city = City.objects.select_related('province').get(id=city_id)
            address_info['city'] = {
                'id': city.id,
                'name': city.name,
                'code': city.code
            }
            # 如果没有省份信息，从城市获取
            if 'province' not in address_info:
                address_info['province'] = {
                    'id': city.province.id,
                    'name': city.province.name,
                    'code': city.province.code
                }
        
        if district_id:
            district = District.objects.select_related('city', 'city__province').get(id=district_id)
            address_info['district'] = {
                'id': district.id,
                'name': district.name,
                'code': district.code
            }
            # 如果没有省市信息，从区县获取
            if 'city' not in address_info:
                address_info['city'] = {
                    'id': district.city.id,
                    'name': district.city.name,
                    'code': district.city.code
                }
            if 'province' not in address_info:
                address_info['province'] = {
                    'id': district.city.province.id,
                    'name': district.city.province.name,
                    'code': district.city.province.code
                }
        
        return JsonResponse({
            'success': True,
            'data': address_info
        })
    except (Province.DoesNotExist, City.DoesNotExist, District.DoesNotExist):
        return JsonResponse({
            'success': False,
            'message': '地址信息不存在'
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': str(e)
        })
```

#### 2. 地址管理视图

```python
# views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .models import Address
from .forms import AddressForm

@login_required
def address_list(request):
    """地址列表"""
    addresses = Address.objects.filter(user=request.user)
    
    context = {
        'addresses': addresses,
    }
    
    return render(request, 'address/address_list.html', context)

@login_required
def address_create(request):
    """创建地址"""
    if request.method == 'POST':
        form = AddressForm(request.POST)
        if form.is_valid():
            address = form.save(commit=False)
            address.user = request.user
            
            # 如果设置为默认地址，取消其他默认地址
            if address.is_default:
                Address.objects.filter(user=request.user, is_default=True).update(is_default=False)
            
            address.save()
            messages.success(request, '地址创建成功！')
            return redirect('address_list')
    else:
        form = AddressForm()
    
    context = {
        'form': form,
        'title': '创建地址',
    }
    
    return render(request, 'address/address_form.html', context)

@login_required
def address_update(request, pk):
    """更新地址"""
    address = get_object_or_404(Address, pk=pk, user=request.user)
    
    if request.method == 'POST':
        form = AddressForm(request.POST, instance=address)
        if form.is_valid():
            # 如果设置为默认地址，取消其他默认地址
            if form.cleaned_data['is_default']:
                Address.objects.filter(user=request.user, is_default=True).exclude(pk=pk).update(is_default=False)
            
            form.save()
            messages.success(request, '地址更新成功！')
            return redirect('address_list')
    else:
        form = AddressForm(instance=address)
    
    context = {
        'form': form,
        'address': address,
        'title': '编辑地址',
    }
    
    return render(request, 'address/address_form.html', context)

@login_required
def address_delete(request, pk):
    """删除地址"""
    address = get_object_or_404(Address, pk=pk, user=request.user)
    
    if request.method == 'POST':
        address.delete()
        messages.success(request, '地址删除成功！')
        return redirect('address_list')
    
    context = {
        'address': address,
    }
    
    return render(request, 'address/address_confirm_delete.html', context)

@login_required
def address_set_default(request, pk):
    """设置默认地址"""
    address = get_object_or_404(Address, pk=pk, user=request.user)
    
    # 取消其他默认地址
    Address.objects.filter(user=request.user, is_default=True).update(is_default=False)
    
    # 设置当前地址为默认
    address.is_default = True
    address.save()
    
    messages.success(request, '默认地址设置成功！')
    return redirect('address_list')
```

### 表单设计

#### 1. 地址表单

```python
# forms.py
from django import forms
from .models import Address, Province, City, District

class AddressForm(forms.ModelForm):
    """地址表单"""
    
    class Meta:
        model = Address
        fields = ['province', 'city', 'district', 'detail_address', 'is_default']
        widgets = {
            'province': forms.Select(attrs={
                'class': 'form-control',
                'id': 'province-select'
            }),
            'city': forms.Select(attrs={
                'class': 'form-control',
                'id': 'city-select'
            }),
            'district': forms.Select(attrs={
                'class': 'form-control',
                'id': 'district-select'
            }),
            'detail_address': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': '请输入详细地址'
            }),
            'is_default': forms.CheckboxInput(attrs={
                'class': 'form-check-input'
            }),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # 设置省份选项
        self.fields['province'].queryset = Province.objects.filter(is_active=True)
        
        # 如果有实例，设置城市和区县选项
        if self.instance and self.instance.pk:
            if self.instance.province:
                self.fields['city'].queryset = City.objects.filter(
                    province=self.instance.province,
                    is_active=True
                )
            if self.instance.city:
                self.fields['district'].queryset = District.objects.filter(
                    city=self.instance.city,
                    is_active=True
                )
        else:
            # 新实例，设置空的选项
            self.fields['city'].queryset = City.objects.none()
            self.fields['district'].queryset = District.objects.none()
    
    def clean(self):
        cleaned_data = super().clean()
        province = cleaned_data.get('province')
        city = cleaned_data.get('city')
        district = cleaned_data.get('district')
        
        # 验证城市是否属于选择的省份
        if province and city and city.province != province:
            raise forms.ValidationError('选择的城市不属于该省份')
        
        # 验证区县是否属于选择的城市
        if city and district and district.city != city:
            raise forms.ValidationError('选择的区县不属于该城市')
        
        return cleaned_data
```

### 前端实现

#### 1. 省市区选择组件

```html
<!-- templates/address/address_form.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>{{ title }}</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="address-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.province.id_for_label }}">省份</label>
                                    {{ form.province }}
                                    {% if form.province.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.province.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.city.id_for_label }}">城市</label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.city.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.district.id_for_label }}">区县</label>
                                    {{ form.district }}
                                    {% if form.district.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.district.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.detail_address.id_for_label }}">详细地址</label>
                            {{ form.detail_address }}
                            {% if form.detail_address.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.detail_address.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                {{ form.is_default }}
                                <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                    设为默认地址
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <a href="{% url 'address_list' %}" class="btn btn-secondary">取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-check-input {
        margin-right: 0.5rem;
    }
    
    .btn {
        margin-right: 0.5rem;
    }
</style>

<script>
class RegionSelector {
    constructor() {
        this.provinceSelect = document.getElementById('province-select');
        this.citySelect = document.getElementById('city-select');
        this.districtSelect = document.getElementById('district-select');
        
        this.init();
    }
    
    init() {
        // 绑定事件
        this.provinceSelect.addEventListener('change', () => this.loadCities());
        this.citySelect.addEventListener('change', () => this.loadDistricts());
        
        // 如果有初始值，加载对应的数据
        if (this.provinceSelect.value) {
            this.loadCities();
        }
        if (this.citySelect.value) {
            this.loadDistricts();
        }
    }
    
    async loadCities() {
        const provinceId = this.provinceSelect.value;
        
        if (!provinceId) {
            this.resetSelect(this.citySelect);
            this.resetSelect(this.districtSelect);
            return;
        }
        
        try {
            const response = await fetch(`/api/cities/?province_id=${provinceId}`);
            const data = await response.json();
            
            if (data.success) {
                this.populateSelect(this.citySelect, data.data);
                this.resetSelect(this.districtSelect);
            } else {
                console.error('加载城市失败:', data.message);
            }
        } catch (error) {
            console.error('请求失败:', error);
        }
    }
    
    async loadDistricts() {
        const cityId = this.citySelect.value;
        
        if (!cityId) {
            this.resetSelect(this.districtSelect);
            return;
        }
        
        try {
            const response = await fetch(`/api/districts/?city_id=${cityId}`);
            const data = await response.json();
            
            if (data.success) {
                this.populateSelect(this.districtSelect, data.data);
            } else {
                console.error('加载区县失败:', data.message);
            }
        } catch (error) {
            console.error('请求失败:', error);
        }
    }
    
    populateSelect(select, data) {
        // 清空现有选项
        select.innerHTML = '<option value="">请选择</option>';
        
        // 添加新选项
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            select.appendChild(option);
        });
    }
    
    resetSelect(select) {
        select.innerHTML = '<option value="">请选择</option>';
    }
}

// 初始化省市区选择器
document.addEventListener('DOMContentLoaded', () => {
    new RegionSelector();
});
</script>
{% endblock %}
```

#### 2. 地址列表页面

```html
<!-- templates/address/address_list.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>我的地址</h2>
                <a href="{% url 'address_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加地址
                </a>
            </div>
            
            {% if addresses %}
                <div class="row">
                    {% for address in addresses %}
                        <div class="col-md-6 mb-3">
                            <div class="card {% if address.is_default %}border-primary{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title">
                                                {{ address.full_address }}
                                                {% if address.is_default %}
                                                    <span class="badge badge-primary">默认</span>
                                                {% endif %}
                                            </h5>
                                            <p class="card-text text-muted">
                                                {{ address.province.name }} {{ address.city.name }} {{ address.district.name }}
                                            </p>
                                            <p class="card-text">{{ address.detail_address }}</p>
                                        </div>
                                        <div class="btn-group-vertical">
                                            {% if not address.is_default %}
                                                <form method="post" action="{% url 'address_set_default' address.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                                        设为默认
                                                    </button>
                                                </form>
                                            {% endif %}
                                            <a href="{% url 'address_update' address.pk %}" class="btn btn-sm btn-outline-secondary">
                                                编辑
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="confirmDelete({{ address.pk }})">
                                                删除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">暂无地址</h4>
                    <p class="text-muted">添加您的第一个地址吧！</p>
                    <a href="{% url 'address_create' %}" class="btn btn-primary">
                        添加地址
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>确定要删除这个地址吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .border-primary {
        border-color: #007bff !important;
    }
    
    .btn-group-vertical .btn {
        margin-bottom: 0.25rem;
    }
    
    .btn-group-vertical .btn:last-child {
        margin-bottom: 0;
    }
</style>

<script>
function confirmDelete(addressId) {
    const modal = $('#deleteModal');
    const form = document.getElementById('deleteForm');
    
    // 设置删除表单的action
    form.action = `/address/${addressId}/delete/`;
    
    // 显示模态框
    modal.modal('show');
}
</script>
{% endblock %}
```

### 数据管理

#### 1. 管理后台配置

```python
# admin.py
from django.contrib import admin
from .models import Province, City, District, Address

@admin.register(Province)
class ProvinceAdmin(admin.ModelAdmin):
    list_display = ['name', 'code', 'is_active', 'created_at']
    list_filter = ['is_active', 'created_at']
    search_fields = ['name', 'code']
    ordering = ['code']

@admin.register(City)
class CityAdmin(admin.ModelAdmin):
    list_display = ['name', 'province', 'code', 'is_active', 'created_at']
    list_filter = ['province', 'is_active', 'created_at']
    search_fields = ['name', 'code', 'province__name']
    ordering = ['province__code', 'code']

@admin.register(District)
class DistrictAdmin(admin.ModelAdmin):
    list_display = ['name', 'city', 'province', 'code', 'is_active', 'created_at']
    list_filter = ['city__province', 'city', 'is_active', 'created_at']
    search_fields = ['name', 'code', 'city__name', 'city__province__name']
    ordering = ['city__province__code', 'city__code', 'code']
    
    def province(self, obj):
        return obj.city.province.name
    province.short_description = '省份'

@admin.register(Address)
class AddressAdmin(admin.ModelAdmin):
    list_display = ['user', 'province', 'city', 'district', 'detail_address', 'is_default', 'created_at']
    list_filter = ['province', 'city', 'is_default', 'created_at']
    search_fields = ['user__username', 'detail_address', 'province__name', 'city__name', 'district__name']
    ordering = ['-created_at']
```

#### 2. 数据导入脚本

```python
# management/commands/import_regions.py
from django.core.management.base import BaseCommand
from django.db import transaction
from address.models import Province, City, District
import json

class Command(BaseCommand):
    help = '导入省市区数据'
    
    def add_arguments(self, parser):
        parser.add_argument('json_file', type=str, help='JSON数据文件路径')
    
    def handle(self, *args, **options):
        json_file = options['json_file']
        
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            with transaction.atomic():
                # 清空现有数据
                District.objects.all().delete()
                City.objects.all().delete()
                Province.objects.all().delete()
                
                # 导入数据
                for province_data in data:
                    province = Province.objects.create(
                        name=province_data['name'],
                        code=province_data['code']
                    )
                    
                    for city_data in province_data['cities']:
                        city = City.objects.create(
                            province=province,
                            name=city_data['name'],
                            code=city_data['code']
                        )
                        
                        for district_data in city_data['districts']:
                            District.objects.create(
                                city=city,
                                name=district_data['name'],
                                code=district_data['code']
                            )
                
                self.stdout.write(
                    self.style.SUCCESS(f'成功导入 {len(data)} 个省份的数据')
                )
                
        except FileNotFoundError:
            self.stdout.write(
                self.style.ERROR(f'文件 {json_file} 不存在')
            )
        except json.JSONDecodeError:
            self.stdout.write(
                self.style.ERROR('JSON文件格式错误')
            )
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'导入失败: {str(e)}')
            )
```

### URL配置

```python
# urls.py
from django.urls import path
from . import views

app_name = 'address'

urlpatterns = [
    # API接口
    path('api/provinces/', views.get_provinces, name='api_provinces'),
    path('api/cities/', views.get_cities, name='api_cities'),
    path('api/districts/', views.get_districts, name='api_districts'),
    path('api/full-address/', views.get_full_address, name='api_full_address'),
    
    # 地址管理
    path('', views.address_list, name='address_list'),
    path('create/', views.address_create, name='address_create'),
    path('<int:pk>/update/', views.address_update, name='address_update'),
    path('<int:pk>/delete/', views.address_delete, name='address_delete'),
    path('<int:pk>/set-default/', views.address_set_default, name='address_set_default'),
]
```

### 测试

#### 1. 单元测试

```python
# tests.py
from django.test import TestCase, Client
from django.contrib.auth.models import User
from .models import Province, City, District, Address
import json

class AddressTestCase(TestCase):
    def setUp(self):
        # 创建测试用户
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        
        # 创建测试数据
        self.province = Province.objects.create(
            name='北京市',
            code='110000'
        )
        
        self.city = City.objects.create(
            province=self.province,
            name='北京市',
            code='110100'
        )
        
        self.district = District.objects.create(
            city=self.city,
            name='朝阳区',
            code='110105'
        )
        
        self.client = Client()
    
    def test_get_provinces(self):
        """测试获取省份列表"""
        response = self.client.get('/address/api/provinces/')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.content)
        self.assertTrue(data['success'])
        self.assertEqual(len(data['data']), 1)
        self.assertEqual(data['data'][0]['name'], '北京市')
    
    def test_get_cities(self):
        """测试获取城市列表"""
        response = self.client.get(f'/address/api/cities/?province_id={self.province.id}')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.content)
        self.assertTrue(data['success'])
        self.assertEqual(len(data['data']), 1)
        self.assertEqual(data['data'][0]['name'], '北京市')
    
    def test_get_districts(self):
        """测试获取区县列表"""
        response = self.client.get(f'/address/api/districts/?city_id={self.city.id}')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.content)
        self.assertTrue(data['success'])
        self.assertEqual(len(data['data']), 1)
        self.assertEqual(data['data'][0]['name'], '朝阳区')
    
    def test_address_crud(self):
        """测试地址的增删改查"""
        # 登录
        self.client.force_login(self.user)
        
        # 创建地址
        address_data = {
            'province': self.province.id,
            'city': self.city.id,
            'district': self.district.id,
            'detail_address': '测试地址123号',
            'is_default': True
        }
        
        response = self.client.post('/address/create/', address_data)
        self.assertEqual(response.status_code, 302)  # 重定向到列表页
        
        # 验证地址创建成功
        address = Address.objects.first()
        self.assertEqual(address.user, self.user)
        self.assertEqual(address.detail_address, '测试地址123号')
        self.assertTrue(address.is_default)
        
        # 更新地址
        update_data = address_data.copy()
        update_data['detail_address'] = '更新后的地址456号'
        
        response = self.client.post(f'/address/{address.id}/update/', update_data)
        self.assertEqual(response.status_code, 302)
        
        # 验证地址更新成功
        address.refresh_from_db()
        self.assertEqual(address.detail_address, '更新后的地址456号')
        
        # 删除地址
        response = self.client.post(f'/address/{address.id}/delete/')
        self.assertEqual(response.status_code, 302)
        
        # 验证地址删除成功
        self.assertEqual(Address.objects.count(), 0)
```

## 小结

- **模型设计**：掌握省市区三级关联模型的设计方法
- **API接口**：学会创建RESTful API接口处理省市区数据
- **前端交互**：掌握JavaScript实现三级联动选择
- **表单处理**：了解动态表单字段的处理方法
- **数据管理**：学会配置管理后台和数据导入脚本
- **测试方法**：掌握地址功能的单元测试编写
- **用户体验**：注重用户界面的友好性和交互体验

通过这个完整的省市区选择示例，可以学习到Django中复杂表单处理、AJAX交互、数据关联等核心技术的应用。 