## 静态文件处理

Django的静态文件处理是Web应用开发中的重要组成部分，包括CSS、JavaScript、图片、字体等静态资源的管理和部署。Django提供了完整的静态文件处理机制，从开发环境的自动服务到生产环境的优化部署。

### 什么是静态文件

静态文件是指不需要服务器端处理的文件，直接发送给客户端浏览器。主要包括：

- **CSS文件**：样式表文件
- **JavaScript文件**：客户端脚本文件
- **图片文件**：PNG、JPG、GIF、SVG等
- **字体文件**：TTF、WOFF、WOFF2等
- **文档文件**：PDF、DOC等
- **其他资源**：图标、音频、视频等

#### 静态文件的特点

```python
# 静态文件的特点
STATIC_FILES_CHARACTERISTICS = {
    'no_server_processing': '不需要服务器端处理',
    'direct_delivery': '直接发送给客户端',
    'caching_friendly': '适合浏览器缓存',
    'cdn_support': '支持CDN分发',
    'version_control': '支持版本控制'
}
```

### Django静态文件配置

#### 1. 基本配置

```python
# settings.py

# 静态文件配置
STATIC_URL = '/static/'  # 静态文件的URL前缀
STATIC_ROOT = BASE_DIR / 'staticfiles'  # 收集静态文件的目录

# 静态文件查找目录
STATICFILES_DIRS = [
    BASE_DIR / 'static',  # 项目级静态文件目录
    BASE_DIR / 'assets',  # 自定义静态文件目录
]

# 静态文件查找器
STATICFILES_FINDERS = [
    'django.contrib.staticfiles.finders.FileSystemFinder',  # 文件系统查找器
    'django.contrib.staticfiles.finders.AppDirectoriesFinder',  # 应用目录查找器
]
```

#### 2. 开发环境配置

```python
# settings.py (开发环境)

# 开发环境静态文件配置
if DEBUG:
    STATIC_URL = '/static/'
    STATICFILES_DIRS = [
        BASE_DIR / 'static',
    ]
    # 开发环境不需要STATIC_ROOT
```

#### 3. 生产环境配置

```python
# settings.py (生产环境)

# 生产环境静态文件配置
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

# 静态文件目录
STATICFILES_DIRS = [
    BASE_DIR / 'static',
]

# 静态文件存储后端
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.StaticFilesStorage'
```

### 静态文件目录结构

#### 1. 推荐的目录结构

```
myproject/
├── manage.py
├── myproject/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── static/                    # 项目级静态文件
│   ├── css/
│   │   ├── main.css
│   │   └── bootstrap.css
│   ├── js/
│   │   ├── main.js
│   │   └── jquery.js
│   ├── images/
│   │   ├── logo.png
│   │   └── icons/
│   └── fonts/
│       └── custom-font.woff
├── myapp/
│   ├── __init__.py
│   ├── models.py
│   ├── views.py
│   └── static/               # 应用级静态文件
│       └── myapp/
│           ├── css/
│           ├── js/
│           └── images/
└── staticfiles/              # 收集的静态文件（生产环境）
```

#### 2. 应用级静态文件

```python
# myapp/static/myapp/css/style.css
body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

# myapp/static/myapp/js/script.js
document.addEventListener('DOMContentLoaded', function() {
    console.log('应用脚本已加载');
    
    // 添加交互功能
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            alert('按钮被点击了！');
        });
    });
});
```

### 在模板中使用静态文件

#### 1. 加载静态文件标签

```html
<!-- 在模板顶部加载静态文件标签 -->
{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>我的网站</title>
    <!-- 使用static标签引用CSS文件 -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'myapp/css/style.css' %}">
</head>
<body>
    <div class="container">
        <h1>欢迎访问</h1>
        
        <!-- 使用static标签引用图片 -->
        <img src="{% static 'images/logo.png' %}" alt="Logo">
        
        <!-- 使用static标签引用JavaScript文件 -->
        <script src="{% static 'js/jquery.js' %}"></script>
        <script src="{% static 'myapp/js/script.js' %}"></script>
    </div>
</body>
</html>
```

#### 2. 条件加载静态文件

```html
{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}默认标题{% endblock %}</title>
    
    <!-- 基础CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    
    <!-- 页面特定CSS -->
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% block content %}{% endblock %}
    
    <!-- 基础JavaScript -->
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    
    <!-- 页面特定JavaScript -->
    {% block extra_js %}{% endblock %}
</body>
</html>
```

#### 3. 动态静态文件路径

```html
{% load static %}

<!-- 使用变量构建静态文件路径 -->
{% with 'images/'|add:user.avatar as avatar_path %}
    <img src="{% static avatar_path %}" alt="用户头像">
{% endwith %}

<!-- 使用条件判断加载不同的静态文件 -->
{% if debug %}
    <script src="{% static 'js/debug.js' %}"></script>
{% else %}
    <script src="{% static 'js/production.js' %}"></script>
{% endif %}
```

### 静态文件收集

#### 1. 收集静态文件命令

```bash
# 收集所有静态文件到STATIC_ROOT目录
python manage.py collectstatic

# 收集静态文件时不询问确认
python manage.py collectstatic --noinput

# 收集静态文件并清除旧文件
python manage.py collectstatic --clear

# 收集静态文件并显示详细信息
python manage.py collectstatic --verbosity=2
```

#### 2. 自定义收集配置

```python
# settings.py

# 静态文件收集配置
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.StaticFilesStorage'

# 自定义静态文件存储
from django.contrib.staticfiles.storage import ManifestStaticFilesStorage

STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.ManifestStaticFilesStorage'

# 静态文件版本控制
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.CachedStaticFilesStorage'
```

#### 3. 收集脚本示例

```python
# collect_static.py
import os
import subprocess
from pathlib import Path

def collect_static_files():
    """收集静态文件的脚本"""
    
    # 项目根目录
    project_root = Path(__file__).parent
    
    # 检查STATIC_ROOT目录是否存在
    static_root = project_root / 'staticfiles'
    if not static_root.exists():
        static_root.mkdir()
    
    # 执行收集命令
    try:
        result = subprocess.run([
            'python', 'manage.py', 'collectstatic', '--noinput'
        ], capture_output=True, text=True, cwd=project_root)
        
        if result.returncode == 0:
            print("静态文件收集成功！")
            print(result.stdout)
        else:
            print("静态文件收集失败！")
            print(result.stderr)
            
    except Exception as e:
        print(f"收集静态文件时出错: {e}")

if __name__ == '__main__':
    collect_static_files()
```

### 静态文件优化

#### 1. 文件压缩和合并

```python
# settings.py

# 使用压缩的静态文件存储
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.ManifestStaticFilesStorage'

# 自定义压缩配置
COMPRESS_ENABLED = True
COMPRESS_CSS_FILTERS = [
    'compressor.filters.css_default.CssAbsoluteFilter',
    'compressor.filters.cssmin.rCSSMinFilter',
]
COMPRESS_JS_FILTERS = [
    'compressor.filters.jsmin.JSMinFilter',
]
```

#### 2. 缓存配置

```python
# settings.py

# 静态文件缓存配置
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.CachedStaticFilesStorage'

# 缓存时间设置
STATICFILES_CACHE_TIMEOUT = 60 * 60 * 24 * 365  # 1年

# 自定义缓存键
STATICFILES_CACHE_KEY_PREFIX = 'static'
```

#### 3. CDN配置

```python
# settings.py

# CDN配置
STATIC_URL = 'https://cdn.example.com/static/'

# 本地回退
STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.StaticFilesStorage'

# 自定义CDN存储
from django.core.files.storage import FileSystemStorage

class CDNStorage(FileSystemStorage):
    def url(self, name):
        """返回CDN URL"""
        return f"https://cdn.example.com/static/{name}"

STATICFILES_STORAGE = 'path.to.CDNStorage'
```

### 静态文件中间件

#### 1. 开发环境中间件

```python
# settings.py

MIDDLEWARE = [
    # ... 其他中间件
    'django.contrib.staticfiles.middleware.StaticFilesMiddleware',
]

# 开发环境静态文件服务
if DEBUG:
    STATICFILES_FINDERS = [
        'django.contrib.staticfiles.finders.FileSystemFinder',
        'django.contrib.staticfiles.finders.AppDirectoriesFinder',
    ]
```

#### 2. 自定义静态文件中间件

```python
# middleware.py
from django.http import HttpResponse
from django.conf import settings
import os

class CustomStaticFilesMiddleware:
    """自定义静态文件中间件"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # 检查是否是静态文件请求
        if request.path.startswith(settings.STATIC_URL):
            return self.serve_static_file(request)
        
        response = self.get_response(request)
        return response
    
    def serve_static_file(self, request):
        """服务静态文件"""
        # 移除STATIC_URL前缀
        file_path = request.path[len(settings.STATIC_URL):]
        
        # 构建完整文件路径
        full_path = os.path.join(settings.STATIC_ROOT, file_path)
        
        # 检查文件是否存在
        if os.path.exists(full_path) and os.path.isfile(full_path):
            # 读取文件内容
            with open(full_path, 'rb') as f:
                content = f.read()
            
            # 确定MIME类型
            content_type = self.get_content_type(file_path)
            
            # 创建响应
            response = HttpResponse(content, content_type=content_type)
            response['Cache-Control'] = 'public, max-age=31536000'  # 1年缓存
            
            return response
        
        return HttpResponse('File not found', status=404)
    
    def get_content_type(self, file_path):
        """根据文件扩展名确定MIME类型"""
        ext = os.path.splitext(file_path)[1].lower()
        
        mime_types = {
            '.css': 'text/css',
            '.js': 'application/javascript',
            '.png': 'image/png',
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.gif': 'image/gif',
            '.svg': 'image/svg+xml',
            '.woff': 'font/woff',
            '.woff2': 'font/woff2',
            '.ttf': 'font/ttf',
        }
        
        return mime_types.get(ext, 'application/octet-stream')
```

### 静态文件工具函数

#### 1. 静态文件URL生成

```python
# utils.py
from django.templatetags.static import static
from django.conf import settings

def get_static_url(path):
    """获取静态文件URL"""
    return static(path)

def get_static_path(file_name):
    """获取静态文件完整路径"""
    return os.path.join(settings.STATIC_ROOT, file_name)

def is_static_file(path):
    """检查是否是静态文件"""
    return path.startswith(settings.STATIC_URL)

def get_static_file_size(file_path):
    """获取静态文件大小"""
    full_path = get_static_path(file_path)
    if os.path.exists(full_path):
        return os.path.getsize(full_path)
    return 0
```

#### 2. 静态文件管理

```python
# static_manager.py
import os
import hashlib
from pathlib import Path
from django.conf import settings

class StaticFileManager:
    """静态文件管理器"""
    
    def __init__(self):
        self.static_root = Path(settings.STATIC_ROOT)
    
    def get_file_hash(self, file_path):
        """获取文件哈希值"""
        full_path = self.static_root / file_path
        
        if not full_path.exists():
            return None
        
        with open(full_path, 'rb') as f:
            content = f.read()
            return hashlib.md5(content).hexdigest()
    
    def get_file_info(self, file_path):
        """获取文件信息"""
        full_path = self.static_root / file_path
        
        if not full_path.exists():
            return None
        
        stat = full_path.stat()
        
        return {
            'path': file_path,
            'size': stat.st_size,
            'modified': stat.st_mtime,
            'hash': self.get_file_hash(file_path)
        }
    
    def list_static_files(self, directory=''):
        """列出静态文件"""
        target_dir = self.static_root / directory
        
        if not target_dir.exists():
            return []
        
        files = []
        for item in target_dir.rglob('*'):
            if item.is_file():
                relative_path = item.relative_to(self.static_root)
                files.append(str(relative_path))
        
        return files
    
    def cleanup_unused_files(self, used_files):
        """清理未使用的静态文件"""
        all_files = set(self.list_static_files())
        used_files = set(used_files)
        unused_files = all_files - used_files
        
        for file_path in unused_files:
            full_path = self.static_root / file_path
            try:
                full_path.unlink()
                print(f"删除未使用的文件: {file_path}")
            except Exception as e:
                print(f"删除文件失败 {file_path}: {e}")
```

### 生产环境部署

#### 1. Nginx配置

```nginx
# nginx.conf
server {
    listen 80;
    server_name example.com;
    
    # 静态文件处理
    location /static/ {
        alias /path/to/your/project/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 媒体文件处理
    location /media/ {
        alias /path/to/your/project/media/;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # Django应用
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 2. Apache配置

```apache
# apache.conf
<VirtualHost *:80>
    ServerName example.com
    
    # 静态文件别名
    Alias /static/ /path/to/your/project/staticfiles/
    <Directory /path/to/your/project/staticfiles/>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </Directory>
    
    # Django应用
    WSGIDaemonProcess myproject python-path=/path/to/your/project
    WSGIProcessGroup myproject
    WSGIScriptAlias / /path/to/your/project/myproject/wsgi.py
</VirtualHost>
```

#### 3. 部署脚本

```python
# deploy.py
import os
import subprocess
from pathlib import Path

def deploy_static_files():
    """部署静态文件"""
    
    project_root = Path(__file__).parent
    
    # 1. 收集静态文件
    print("收集静态文件...")
    subprocess.run([
        'python', 'manage.py', 'collectstatic', '--noinput'
    ], cwd=project_root, check=True)
    
    # 2. 压缩静态文件（可选）
    print("压缩静态文件...")
    # 这里可以添加压缩逻辑
    
    # 3. 上传到CDN（可选）
    print("上传到CDN...")
    # 这里可以添加CDN上传逻辑
    
    print("静态文件部署完成！")

if __name__ == '__main__':
    deploy_static_files()
```

## 小结

- **静态文件基础**：理解静态文件的概念和特点
- **配置管理**：掌握Django静态文件的配置方法
- **目录结构**：了解推荐的静态文件目录结构
- **模板使用**：学会在模板中正确使用静态文件
- **文件收集**：掌握静态文件收集和部署流程
- **性能优化**：了解静态文件压缩、缓存和CDN配置
- **生产部署**：掌握生产环境中的静态文件部署方法

合理使用Django的静态文件处理机制可以构建出性能优良、易于维护的Web应用。
