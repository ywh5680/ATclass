## 模型定义

Django模型是Python类，继承自`django.db.models.Model`，用于定义数据库表的结构。每个模型类对应数据库中的一个表，模型的属性对应表中的字段。

### 模型类的基本结构

```python
from django.db import models

class ModelName(models.Model):
    # 字段定义
    field1 = models.FieldType(options)
    field2 = models.FieldType(options)
    
    # 元数据
    class Meta:
        # 元数据选项
        
    # 方法
    def __str__(self):
        return self.field1
    
    def custom_method(self):
        # 自定义方法
        pass
```

### 字段类型

Django提供了丰富的字段类型，用于定义不同类型的数据：

#### 字符串字段

1. **CharField**：固定长度的字符串
   ```python
   title = models.CharField(max_length=100)
   ```
   必须指定`max_length`参数，表示最大字符数。

2. **TextField**：不限长度的文本
   ```python
   content = models.TextField()
   ```
   适用于博客文章、评论等大文本内容。

3. **EmailField**：电子邮件地址
   ```python
   email = models.EmailField()
   ```
   会自动验证是否是有效的电子邮件格式。

4. **URLField**：URL地址
   ```python
   website = models.URLField()
   ```
   会自动验证是否是有效的URL格式。

5. **SlugField**：只包含字母、数字、下划线和连字符的短标签
   ```python
   slug = models.SlugField()
   ```
   通常用于URL中的一部分。

#### 数值字段

1. **IntegerField**：整数
   ```python
   count = models.IntegerField()
   ```

2. **FloatField**：浮点数
   ```python
   price = models.FloatField()
   ```

3. **DecimalField**：固定精度的十进制数
   ```python
   price = models.DecimalField(max_digits=5, decimal_places=2)
   ```
   必须指定`max_digits`（总位数）和`decimal_places`（小数位数）。

4. **PositiveIntegerField**：正整数（包括0）
   ```python
   age = models.PositiveIntegerField()
   ```

#### 布尔字段

1. **BooleanField**：布尔值（True/False）
   ```python
   is_active = models.BooleanField(default=True)
   ```

2. **NullBooleanField**：允许为NULL的布尔值
   ```python
   is_published = models.NullBooleanField()
   ```

#### 日期和时间字段

1. **DateField**：日期
   ```python
   birth_date = models.DateField()
   ```

2. **TimeField**：时间
   ```python
   meeting_time = models.TimeField()
   ```

3. **DateTimeField**：日期和时间
   ```python
   created_at = models.DateTimeField(auto_now_add=True)
   updated_at = models.DateTimeField(auto_now=True)
   ```
   - `auto_now_add=True`：创建时自动设置为当前时间
   - `auto_now=True`：每次保存时自动更新为当前时间

#### 文件字段

1. **FileField**：上传文件
   ```python
   document = models.FileField(upload_to='documents/')
   ```

2. **ImageField**：上传图片
   ```python
   image = models.ImageField(upload_to='images/')
   ```
   需要安装Pillow库：`pip install Pillow`

### 关系字段

Django提供了三种关系字段，用于定义模型之间的关系：

#### 1. ForeignKey（多对一）

用于定义多对一关系，如一篇文章可以有多个评论，但每个评论只属于一篇文章：

```python
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()

class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    text = models.TextField()
```

`on_delete`参数指定当关联的对象被删除时的行为：
- `CASCADE`：级联删除（删除文章时删除所有相关评论）
- `PROTECT`：阻止删除（如果有相关评论，不允许删除文章）
- `SET_NULL`：设置为NULL（删除文章时将评论的文章字段设为NULL，需要设置`null=True`）
- `SET_DEFAULT`：设置为默认值（需要设置`default`参数）
- `DO_NOTHING`：不做任何操作

#### 2. ManyToManyField（多对多）

用于定义多对多关系，如一篇文章可以有多个标签，一个标签也可以应用于多篇文章：

```python
class Tag(models.Model):
    name = models.CharField(max_length=50)

class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    tags = models.ManyToManyField(Tag)
```

#### 3. OneToOneField（一对一）

用于定义一对一关系，如一个用户只能有一个个人资料：

```python
from django.contrib.auth.models import User

class Profile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    bio = models.TextField()
    birth_date = models.DateField(null=True, blank=True)
```

### 字段选项

字段可以接受多种选项参数，用于自定义字段的行为：

1. **null**：是否允许在数据库中存储NULL值
   ```python
   middle_name = models.CharField(max_length=100, null=True)
   ```

2. **blank**：是否允许在表单中留空
   ```python
   bio = models.TextField(blank=True)
   ```

3. **default**：默认值
   ```python
   is_active = models.BooleanField(default=True)
   ```

4. **choices**：预定义的选项列表
   ```python
   GENDER_CHOICES = [
       ('M', '男'),
       ('F', '女'),
       ('O', '其他'),
   ]
   gender = models.CharField(max_length=1, choices=GENDER_CHOICES)
   ```

5. **unique**：是否要求唯一
   ```python
   email = models.EmailField(unique=True)
   ```

6. **verbose_name**：人类可读的字段名称
   ```python
   first_name = models.CharField("名", max_length=30)
   ```

7. **help_text**：表单帮助文本
   ```python
   username = models.CharField(max_length=30, help_text="请输入用户名")
   ```

8. **db_index**：是否为字段创建数据库索引
   ```python
   last_name = models.CharField(max_length=30, db_index=True)
   ```

### 模型元数据

模型的`Meta`内部类用于定义模型的元数据，如排序、表名、权限等：

```python
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-created_at']  # 按创建时间降序排序
        verbose_name = '文章'       # 单数形式的名称
        verbose_name_plural = '文章'  # 复数形式的名称
        db_table = 'blog_article'   # 自定义数据库表名
        unique_together = ['title', 'created_at']  # 组合唯一约束
        indexes = [
            models.Index(fields=['created_at']),  # 创建索引
        ]
        permissions = [
            ('publish_article', '可以发布文章'),  # 自定义权限
        ]
```

### 模型方法

模型可以定义自定义方法，用于封装业务逻辑：

```python
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.title
    
    def is_recent(self):
        from django.utils import timezone
        return self.created_at >= timezone.now() - timezone.timedelta(days=7)
    
    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('article-detail', args=[str(self.id)])
```

### 模型继承

Django支持三种类型的模型继承：

#### 1. 抽象基类

创建一个不会生成数据库表的基类，用于共享字段：

```python
class BaseModel(models.Model):
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        abstract = True  # 标记为抽象类

class Article(BaseModel):
    title = models.CharField(max_length=100)
    content = models.TextField()
    # 自动继承created_at和updated_at字段
```

#### 2. 多表继承

每个模型都有自己的数据库表，并通过外键关联：

```python
class Place(models.Model):
    name = models.CharField(max_length=50)
    address = models.CharField(max_length=80)

class Restaurant(Place):
    serves_hot_dogs = models.BooleanField(default=False)
    serves_pizza = models.BooleanField(default=False)
```

#### 3. 代理模型

不创建新的数据库表，只修改模型行为：

```python
class Person(models.Model):
    name = models.CharField(max_length=50)
    birth_date = models.DateField()

class OrderedPerson(Person):
    class Meta:
        proxy = True
        ordering = ['name']
```

## 实例：博客应用模型

下面是一个博客应用的模型示例：

```python
from django.db import models
from django.contrib.auth.models import User

class Category(models.Model):
    name = models.CharField('分类名', max_length=100)
    description = models.TextField('描述', blank=True)
    
    class Meta:
        verbose_name = '分类'
        verbose_name_plural = '分类'
    
    def __str__(self):
        return self.name

class Tag(models.Model):
    name = models.CharField('标签名', max_length=100)
    
    class Meta:
        verbose_name = '标签'
        verbose_name_plural = '标签'
    
    def __str__(self):
        return self.name

class Post(models.Model):
    STATUS_CHOICES = (
        ('draft', '草稿'),
        ('published', '已发布'),
    )
    
    title = models.CharField('标题', max_length=200)
    slug = models.SlugField('URL', max_length=200, unique_for_date='publish')
    author = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name='作者')
    body = models.TextField('正文')
    publish = models.DateTimeField('发布时间', auto_now_add=True)
    created = models.DateTimeField('创建时间', auto_now_add=True)
    updated = models.DateTimeField('更新时间', auto_now=True)
    status = models.CharField('状态', max_length=10, choices=STATUS_CHOICES, default='draft')
    category = models.ForeignKey(Category, on_delete=models.CASCADE, verbose_name='分类')
    tags = models.ManyToManyField(Tag, blank=True, verbose_name='标签')
    
    class Meta:
        ordering = ('-publish',)
        verbose_name = '文章'
        verbose_name_plural = '文章'
    
    def __str__(self):
        return self.title
    
    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('blog:post_detail', args=[self.publish.year,
                                                self.publish.month,
                                                self.publish.day,
                                                self.slug])

class Comment(models.Model):
    post = models.ForeignKey(Post, on_delete=models.CASCADE, related_name='comments', verbose_name='文章')
    name = models.CharField('姓名', max_length=80)
    email = models.EmailField('邮箱')
    body = models.TextField('评论内容')
    created = models.DateTimeField('创建时间', auto_now_add=True)
    updated = models.DateTimeField('更新时间', auto_now=True)
    active = models.BooleanField('是否可见', default=True)
    
    class Meta:
        ordering = ('created',)
        verbose_name = '评论'
        verbose_name_plural = '评论'
    
    def __str__(self):
        return f'Comment by {self.name} on {self.post}'
```

## 小结

- Django模型是Python类，继承自`django.db.models.Model`
- 模型字段定义了数据库表的结构，Django提供了丰富的字段类型
- 关系字段（ForeignKey、ManyToManyField、OneToOneField）用于定义模型之间的关系
- 字段选项和模型元数据用于自定义模型的行为
- 模型方法用于封装业务逻辑
- Django支持三种类型的模型继承：抽象基类、多表继承和代理模型