## 添加 SSH 账户

SSH（Secure Shell）是一种网络协议，用于在不安全的网络中安全地传输数据。在 Git 中使用 SSH 可以安全地访问远程仓库，无需每次都输入用户名和密码。

### SSH 简介

#### 1. 什么是 SSH

SSH 是一种加密的网络协议，提供以下功能：

- **安全连接**：所有数据传输都经过加密
- **身份验证**：使用密钥对进行身份验证
- **端口转发**：支持端口转发和隧道
- **文件传输**：支持安全的文件传输

#### 2. SSH 在 Git 中的作用

- **安全访问**：无需在 URL 中包含密码
- **自动化**：支持脚本和自动化工具
- **多账户**：可以配置多个 SSH 密钥
- **密钥管理**：集中管理访问权限

### 生成 SSH 密钥

#### 1. 检查现有密钥

```bash
# 查看现有 SSH 密钥
ls -la ~/.ssh

# 常见的密钥文件
# id_rsa          - RSA 私钥
# id_rsa.pub      - RSA 公钥
# id_ed25519      - Ed25519 私钥
# id_ed25519.pub  - Ed25519 公钥
```

#### 2. 生成新的 SSH 密钥

```bash
# 生成 RSA 密钥（推荐用于兼容性）
ssh-keygen -t rsa -b 4096 -C "your.email@example.com"

# 生成 Ed25519 密钥（推荐用于安全性）
ssh-keygen -t ed25519 -C "your.email@example.com"

# 生成 ECDSA 密钥
ssh-keygen -t ecdsa -b 521 -C "your.email@example.com"
```

#### 3. 密钥生成过程

```bash
# 执行生成命令后，会提示以下信息：

# 1. 选择密钥保存位置（默认：~/.ssh/id_rsa）
Enter file in which to save the key (/home/user/.ssh/id_rsa):

# 2. 设置密码（可选，推荐设置）
Enter passphrase (empty for no passphrase):
Enter same passphrase again:

# 3. 生成成功提示
Your identification has been saved in /home/user/.ssh/id_rsa
Your public key has been saved in /home/user/.ssh/id_rsa.pub
```

### 配置 SSH 密钥

#### 1. 启动 SSH 代理

```bash
# 启动 SSH 代理
eval "$(ssh-agent -s)"

# 或者使用以下命令
ssh-agent bash

# 查看 SSH 代理状态
ssh-add -l
```

#### 2. 添加密钥到 SSH 代理

```bash
# 添加默认密钥
ssh-add ~/.ssh/id_rsa

# 添加特定密钥
ssh-add ~/.ssh/id_ed25519

# 添加所有密钥
ssh-add ~/.ssh/id_*

# 查看已添加的密钥
ssh-add -l
```

#### 3. 配置 SSH 配置文件

```bash
# 创建或编辑 SSH 配置文件
nano ~/.ssh/config

# 添加以下配置
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_rsa
    IdentitiesOnly yes

Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile ~/.ssh/id_ed25519
    IdentitiesOnly yes
```

### 添加公钥到远程服务

#### 1. 复制公钥

```bash
# 显示公钥内容
cat ~/.ssh/id_rsa.pub

# 复制公钥到剪贴板（Linux）
cat ~/.ssh/id_rsa.pub | xclip -selection clipboard

# 复制公钥到剪贴板（macOS）
cat ~/.ssh/id_rsa.pub | pbcopy

# 复制公钥到剪贴板（Windows Git Bash）
cat ~/.ssh/id_rsa.pub | clip
```

#### 2. 添加到 GitHub

1. **登录 GitHub**：访问 https://github.com 并登录

2. **进入设置**：
   - 点击右上角头像
   - 选择 "Settings"

3. **添加 SSH 密钥**：
   - 点击左侧菜单 "SSH and GPG keys"
   - 点击 "New SSH key"

4. **填写信息**：
   - Title：给密钥起个名字（如：My Laptop）
   - Key：粘贴公钥内容
   - 点击 "Add SSH key"

#### 3. 添加到 GitLab

1. **登录 GitLab**：访问你的 GitLab 实例

2. **进入设置**：
   - 点击右上角头像
   - 选择 "Preferences"

3. **添加 SSH 密钥**：
   - 点击左侧菜单 "SSH Keys"
   - 粘贴公钥内容
   - 点击 "Add key"

#### 4. 添加到其他服务

```bash
# 添加到 Bitbucket
# 访问：https://bitbucket.org/account/user/ssh-keys/

# 添加到 Gitee
# 访问：https://gitee.com/profile/sshkeys

# 添加到自建 Git 服务器
# 联系服务器管理员添加公钥
```

### 测试 SSH 连接

#### 1. 测试 GitHub 连接

```bash
# 测试 SSH 连接
ssh -T git@github.com

# 成功提示
Hi username! You've successfully authenticated, but GitHub does not provide shell access.

# 如果失败，检查以下内容：
# 1. 公钥是否正确添加到 GitHub
# 2. SSH 代理是否启动
# 3. 密钥是否正确添加到代理
```

#### 2. 测试 GitLab 连接

```bash
# 测试 GitLab 连接
ssh -T git@gitlab.com

# 成功提示
Welcome to GitLab, @username!
```

#### 3. 调试 SSH 连接

```bash
# 详细模式测试
ssh -vT git@github.com

# 更详细的调试信息
ssh -vvT git@github.com

# 最详细的调试信息
ssh -vvvT git@github.com
```

### 多账户配置

#### 1. 生成多个密钥

```bash
# 为不同账户生成不同密钥
ssh-keygen -t rsa -b 4096 -C "personal@example.com" -f ~/.ssh/id_rsa_personal
ssh-keygen -t rsa -b 4096 -C "work@example.com" -f ~/.ssh/id_rsa_work
```

#### 2. 配置多账户

```bash
# 编辑 SSH 配置文件
nano ~/.ssh/config

# 添加多账户配置
Host github-personal
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_rsa_personal
    IdentitiesOnly yes

Host github-work
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_rsa_work
    IdentitiesOnly yes
```

#### 3. 使用多账户

```bash
# 克隆个人项目
git clone git@github-personal:username/personal-project.git

# 克隆工作项目
git clone git@github-work:company/work-project.git

# 或者修改现有仓库的远程地址
git remote set-url origin git@github-personal:username/project.git
```

### SSH 密钥管理

#### 1. 查看密钥信息

```bash
# 查看密钥指纹
ssh-keygen -lf ~/.ssh/id_rsa.pub

# 查看密钥类型和长度
ssh-keygen -l -E md5 -f ~/.ssh/id_rsa.pub

# 查看密钥注释
ssh-keygen -l -f ~/.ssh/id_rsa.pub
```

#### 2. 更改密钥密码

```bash
# 更改私钥密码
ssh-keygen -p -f ~/.ssh/id_rsa

# 系统会提示输入旧密码和新密码
Enter old passphrase:
Enter new passphrase (empty for no passphrase):
Enter same passphrase again:
```

#### 3. 删除密钥

```bash
# 从 SSH 代理中删除密钥
ssh-add -d ~/.ssh/id_rsa

# 删除所有密钥
ssh-add -D

# 删除密钥文件（谨慎操作）
rm ~/.ssh/id_rsa
rm ~/.ssh/id_rsa.pub
```

### 安全最佳实践

#### 1. 密钥安全

- **设置密码**：为私钥设置强密码
- **权限控制**：确保私钥文件权限为 600
- **定期更换**：定期更换 SSH 密钥
- **备份密钥**：安全备份私钥和公钥

#### 2. 权限设置

```bash
# 设置正确的文件权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
chmod 600 ~/.ssh/config
```

#### 3. 密钥轮换

```bash
# 生成新密钥
ssh-keygen -t ed25519 -C "new-key@example.com"

# 添加新密钥到远程服务
cat ~/.ssh/id_ed25519.pub

# 测试新密钥
ssh -T git@github.com

# 删除旧密钥（确认新密钥工作正常后）
```

### 常见问题解决

#### 1. 连接被拒绝

```bash
# 检查 SSH 代理
ssh-add -l

# 重启 SSH 代理
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa

# 检查防火墙设置
sudo ufw status
```

#### 2. 权限被拒绝

```bash
# 检查文件权限
ls -la ~/.ssh/

# 修复权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
```

#### 3. 密钥不被识别

```bash
# 检查密钥是否添加到代理
ssh-add -l

# 重新添加密钥
ssh-add ~/.ssh/id_rsa

# 检查 SSH 配置
cat ~/.ssh/config
```

### 总结

通过本章的学习，你应该掌握了：

1. **SSH 基础**：理解 SSH 的工作原理和作用
2. **密钥生成**：生成不同类型的 SSH 密钥
3. **密钥配置**：配置 SSH 代理和配置文件
4. **远程服务**：将公钥添加到各种 Git 服务
5. **连接测试**：测试和调试 SSH 连接
6. **多账户管理**：配置和管理多个 SSH 账户
7. **安全实践**：确保 SSH 密钥的安全性

SSH 密钥是安全访问 Git 仓库的基础，掌握这些技能将大大提高你的开发效率。