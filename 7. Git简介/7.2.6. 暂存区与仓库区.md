## 暂存区与仓库区

暂存区和仓库区是 Git 版本控制系统的两个重要区域，理解它们之间的关系和操作对于有效管理代码版本至关重要。本章将详细介绍暂存区和仓库区的概念、操作和管理。

### Git 区域关系

#### 1. 三个区域的关系

Git 使用三个主要区域来管理文件：

```
工作区 ←→ 暂存区 ←→ 仓库区
   ↓         ↓         ↓
 已修改    已暂存    已提交
```

- **工作区**：实际编辑文件的地方
- **暂存区**：准备提交的文件快照
- **仓库区**：已提交的版本历史

#### 2. 数据流转

```bash
# 数据流转过程
# 1. 工作区修改文件
echo "new content" > file.txt

# 2. 添加到暂存区
git add file.txt

# 3. 提交到仓库区
git commit -m "Update file.txt"

# 4. 查看状态
git status
```

### 暂存区（Staging Area）

#### 1. 暂存区的作用

暂存区是 Git 中的一个中间区域，具有以下作用：

- **准备区域**：将要提交的文件
- **快照区域**：提交时的文件状态
- **选择区域**：可以选择性地添加文件
- **分离关注点**：将工作区和提交分离

#### 2. 暂存区操作

```bash
# 添加文件到暂存区
git add filename.txt

# 添加多个文件
git add file1.txt file2.txt

# 添加所有文件
git add .

# 添加特定类型文件
git add *.js
git add src/

# 交互式添加
git add -i

# 部分添加
git add -p filename.txt
```

#### 3. 暂存区状态

```bash
# 查看暂存区状态
git status

# 查看暂存区中的文件
git diff --cached --name-only

# 查看暂存区中的更改
git diff --cached

# 查看暂存区中的文件统计
git diff --cached --stat

# 查看暂存区中的文件列表
git ls-files --stage
```

### 仓库区（Repository）

#### 1. 仓库区的作用

仓库区存储已提交的版本历史：

- **版本历史**：所有提交的记录
- **快照存储**：每次提交的文件快照
- **分支管理**：分支和标签信息
- **元数据**：提交信息、作者、时间等

#### 2. 仓库区操作

```bash
# 提交到仓库区
git commit -m "Add new feature"

# 查看提交历史
git log

# 查看提交详情
git show <commit-hash>

# 查看文件历史
git log --follow filename.txt

# 查看分支历史
git log --graph --oneline
```

#### 3. 仓库区状态

```bash
# 查看仓库区状态
git status

# 查看当前分支
git branch

# 查看所有分支
git branch -a

# 查看标签
git tag

# 查看远程仓库
git remote -v
```

### 暂存区与仓库区的交互

#### 1. 提交操作

```bash
# 基本提交流程
# 1. 添加文件到暂存区
git add filename.txt

# 2. 查看暂存区状态
git diff --cached

# 3. 提交到仓库区
git commit -m "Add new feature"

# 4. 查看提交结果
git log --oneline -1
```

#### 2. 状态检查

```bash
# 查看暂存区与仓库区的差异
git diff --cached

# 查看工作区与暂存区的差异
git diff

# 查看工作区与仓库区的差异
git diff HEAD

# 查看暂存区中的文件
git diff --cached --name-only

# 查看仓库区中的文件
git ls-tree HEAD
```

#### 3. 重置操作

```bash
# 重置暂存区到仓库区
git reset HEAD

# 重置特定文件
git reset HEAD filename.txt

# 重置到特定提交
git reset HEAD~1

# 使用新语法
git restore --staged filename.txt
git restore --staged .
```

### 高级操作

#### 1. 选择性提交

```bash
# 1. 修改多个文件
echo "content1" > file1.txt
echo "content2" > file2.txt
echo "content3" > file3.txt

# 2. 选择性添加到暂存区
git add file1.txt file2.txt

# 3. 查看暂存区状态
git diff --cached

# 4. 提交部分更改
git commit -m "Add file1 and file2"

# 5. 处理剩余文件
git add file3.txt
git commit -m "Add file3"
```

#### 2. 交互式暂存

```bash
# 交互式添加
git add -i

# 交互式部分添加
git add -p filename.txt

# 交互式添加所有文件
git add -p .

# 在交互式模式中选择操作
# 1: status - 查看状态
# 2: update - 更新文件
# 3: revert - 撤销暂存
# 4: add untracked - 添加未跟踪文件
# 5: patch - 部分添加
# 6: diff - 查看差异
# 7: quit - 退出
# 8: help - 帮助
```

#### 3. 暂存区管理

```bash
# 查看暂存区内容
git ls-files --stage

# 查看暂存区中的文件权限
git ls-files --stage | awk '{print $1, $2, $3, $4}'

# 查看暂存区中的文件大小
git ls-files --stage | xargs ls -la

# 清空暂存区
git reset HEAD

# 重置暂存区到特定提交
git reset HEAD~1
```

### 提交管理

#### 1. 提交操作

```bash
# 基本提交
git commit -m "Add new feature"

# 添加所有更改并提交
git commit -am "Update files"

# 修改最后一次提交
git commit --amend -m "Updated commit message"

# 空提交
git commit --allow-empty -m "Empty commit"

# 签名提交
git commit -S -m "Signed commit"
```

#### 2. 提交信息规范

```bash
# 提交信息格式
# <type>(<scope>): <subject>
#
# <body>
#
# <footer>

# 类型说明
# feat: 新功能
# fix: 修复
# docs: 文档
# style: 格式
# refactor: 重构
# test: 测试
# chore: 构建

# 示例
git commit -m "feat(user): add user authentication

- Add login/logout functionality
- Add user registration
- Add password reset

Closes #123"
```

#### 3. 提交历史管理

```bash
# 查看提交历史
git log

# 查看简洁历史
git log --oneline

# 查看图形历史
git log --graph --oneline

# 查看特定文件的历史
git log --follow filename.txt

# 查看特定作者的提交
git log --author="username"

# 查看特定时间段的提交
git log --since="2024-01-01" --until="2024-12-31"
```

### 实际应用场景

#### 1. 日常开发流程

```bash
# 1. 修改文件
echo "new content" > file.txt

# 2. 查看更改
git diff

# 3. 添加到暂存区
git add file.txt

# 4. 查看暂存区状态
git diff --cached

# 5. 提交到仓库区
git commit -m "Update file.txt"

# 6. 查看提交结果
git log --oneline -1
```

#### 2. 功能开发

```bash
# 1. 创建功能分支
git checkout -b feature/new-feature

# 2. 开发功能
# 编辑文件...

# 3. 阶段性提交
git add .
git commit -m "Add initial implementation"

# 4. 继续开发
# 编辑文件...

# 5. 最终提交
git add .
git commit -m "Complete feature implementation"

# 6. 推送到远程
git push -u origin feature/new-feature
```

#### 3. 错误修正

```bash
# 1. 发现错误
# 编辑文件...

# 2. 添加到暂存区
git add filename.txt

# 3. 发现还有错误
# 继续编辑...

# 4. 重新添加到暂存区
git add filename.txt

# 5. 提交
git commit -m "Fix bug in filename.txt"
```

### 最佳实践

#### 1. 暂存区使用

```bash
# 1. 使用暂存区进行选择性提交
git add -p filename.txt

# 2. 提交前检查暂存区
git diff --cached

# 3. 使用暂存区分离关注点
# 将相关更改分组提交

# 4. 避免提交不完整的更改
# 确保每个提交都是完整的功能
```

#### 2. 提交管理

```bash
# 1. 编写清晰的提交信息
git commit -m "feat(user): add user authentication"

# 2. 保持提交原子性
# 每个提交只做一件事

# 3. 经常提交
# 避免大量更改一次性提交

# 4. 使用分支进行功能开发
git checkout -b feature/new-feature
```

#### 3. 状态检查

```bash
# 1. 提交前检查状态
git status
git diff --cached

# 2. 使用简短状态
git status -s

# 3. 检查特定文件
git diff filename.txt
git diff --cached filename.txt

# 4. 检查工作区是否干净
git status --porcelain
```

### 常见问题解决

#### 1. 意外提交

```bash
# 修改最后一次提交
git commit --amend -m "Corrected commit message"

# 撤销最后一次提交
git reset HEAD~1

# 撤销提交但保留更改
git reset --soft HEAD~1

# 撤销提交并丢弃更改
git reset --hard HEAD~1
```

#### 2. 暂存区错误

```bash
# 从暂存区移除文件
git reset HEAD filename.txt

# 清空暂存区
git reset HEAD

# 使用新语法
git restore --staged filename.txt
git restore --staged .
```

#### 3. 状态混乱

```bash
# 查看详细状态
git status

# 查看所有更改
git diff
git diff --cached
git diff HEAD

# 重置到干净状态
git reset --hard HEAD
git clean -fd
```

### 总结

通过本章的学习，你应该掌握了：

1. **区域关系**：理解暂存区和仓库区的关系
2. **暂存区操作**：管理暂存区中的文件
3. **仓库区管理**：管理已提交的版本历史
4. **交互操作**：暂存区和仓库区之间的交互
5. **高级操作**：选择性提交和交互式操作
6. **提交管理**：管理提交和提交历史
7. **实际应用**：在日常开发中的应用场景
8. **最佳实践**：暂存区和仓库区的最佳使用方式
9. **问题解决**：解决常见的问题和错误

暂存区和仓库区是 Git 版本控制的核心，掌握这些知识将大大提高你的代码管理效率。