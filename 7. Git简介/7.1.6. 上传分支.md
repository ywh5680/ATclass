## 上传分支

上传分支是将本地分支推送到远程仓库的过程，这是团队协作开发中的重要步骤。本章将详细介绍如何上传分支以及相关的操作。

### 上传基础

#### 1. 什么是上传分支

上传分支（Push）是将本地分支的提交推送到远程仓库的过程：

- **同步代码**：将本地更改同步到远程仓库
- **团队协作**：让其他开发者看到你的更改
- **备份代码**：在远程仓库保存代码副本
- **代码审查**：为 Pull Request 做准备

#### 2. 上传的优势

- **代码共享**：团队成员可以访问你的代码
- **版本控制**：远程仓库保存完整的版本历史
- **协作开发**：支持多人同时开发
- **代码备份**：防止本地代码丢失

### 基本上传操作

#### 1. 推送到远程仓库

```bash
# 推送当前分支到远程仓库
git push origin main

# 推送指定分支
git push origin feature/user-login

# 推送所有分支
git push --all

# 推送标签
git push --tags

# 推送所有分支和标签
git push --all --tags
```

#### 2. 设置上游分支

```bash
# 推送并设置上游分支
git push -u origin feature/user-login

# 或者使用 --set-upstream
git push --set-upstream origin feature/user-login

# 查看上游分支
git branch -vv

# 更改上游分支
git branch --set-upstream-to=origin/develop feature/user-login
```

#### 3. 查看推送状态

```bash
# 查看远程分支信息
git remote -v

# 查看本地和远程分支的差异
git status

# 查看提交历史
git log --oneline -5

# 查看分支关系
git branch -vv
```

### 上传前准备

#### 1. 检查工作区状态

```bash
# 查看工作区状态
git status

# 查看未提交的更改
git diff

# 查看暂存区的更改
git diff --cached

# 查看所有更改
git diff HEAD
```

#### 2. 提交本地更改

```bash
# 添加所有更改到暂存区
git add .

# 或者添加特定文件
git add src/components/UserLogin.js
git add tests/user-login.test.js

# 提交更改
git commit -m "Add user login functionality

- Add login form component
- Add authentication service
- Add unit tests for login
- Update documentation"

# 查看提交历史
git log --oneline -3
```

#### 3. 获取远程更新

```bash
# 获取远程仓库的最新信息
git fetch origin

# 查看远程分支
git branch -r

# 查看本地和远程的差异
git log HEAD..origin/main --oneline

# 合并远程更改
git pull origin main
```

### 分支上传策略

#### 1. 功能分支上传

```bash
# 创建功能分支
git checkout -b feature/user-login

# 开发功能
# 编辑文件...
git add .
git commit -m "Add user login form"

# 继续开发
git add .
git commit -m "Add form validation"

# 推送到远程
git push -u origin feature/user-login

# 后续更新
git add .
git commit -m "Fix login validation bug"
git push origin feature/user-login
```

#### 2. 主分支上传

```bash
# 切换到主分支
git checkout main

# 拉取最新更改
git pull origin main

# 合并功能分支
git merge feature/user-login

# 推送到远程
git push origin main

# 删除本地功能分支
git branch -d feature/user-login

# 删除远程功能分支
git push origin --delete feature/user-login
```

#### 3. 发布分支上传

```bash
# 创建发布分支
git checkout -b release/v1.2.0

# 更新版本号
# 编辑 package.json 或其他版本文件
git add .
git commit -m "Bump version to 1.2.0"

# 推送到远程
git push -u origin release/v1.2.0

# 创建发布标签
git tag v1.2.0
git push origin v1.2.0
```

### 上传选项

#### 1. 强制推送

```bash
# 强制推送（谨慎使用）
git push --force origin feature/user-login

# 更安全的强制推送
git push --force-with-lease origin feature/user-login

# 强制推送所有分支
git push --force --all
```

#### 2. 推送选项

```bash
# 推送时显示详细信息
git push -v origin feature/user-login

# 推送时显示进度
git push --progress origin feature/user-login

# 推送时显示统计信息
git push --verbose origin feature/user-login

# 推送时显示差异
git push --dry-run origin feature/user-login
```

#### 3. 批量推送

```bash
# 推送所有分支
git push --all origin

# 推送所有标签
git push --tags origin

# 推送所有分支和标签
git push --all --tags origin

# 推送匹配的分支
git push origin 'refs/heads/feature/*'
```

### 冲突处理

#### 1. 推送冲突

```bash
# 推送时遇到冲突
git push origin feature/user-login
# 错误：远程分支包含本地没有的提交

# 解决方案1：拉取并合并
git pull origin feature/user-login
git push origin feature/user-login

# 解决方案2：变基
git pull --rebase origin feature/user-login
git push origin feature/user-login

# 解决方案3：强制推送（谨慎使用）
git push --force-with-lease origin feature/user-login
```

#### 2. 合并冲突

```bash
# 拉取时遇到合并冲突
git pull origin main
# 显示冲突文件

# 手动解决冲突
# 编辑冲突文件...
git add .
git commit -m "Resolve merge conflicts"

# 推送到远程
git push origin feature/user-login
```

#### 3. 变基冲突

```bash
# 变基时遇到冲突
git pull --rebase origin main
# 显示冲突文件

# 解决冲突
# 编辑冲突文件...
git add .
git rebase --continue

# 或者中止变基
git rebase --abort

# 推送变基后的分支
git push --force-with-lease origin feature/user-login
```

### 安全上传

#### 1. 推送前检查

```bash
# 检查工作区状态
git status

# 检查未提交的更改
git diff

# 检查提交历史
git log --oneline -5

# 检查分支关系
git branch -vv

# 运行测试
npm test

# 运行代码检查
npm run lint
```

#### 2. 使用安全推送

```bash
# 使用 force-with-lease 而不是 force
git push --force-with-lease origin feature/user-login

# 推送前先拉取
git pull origin feature/user-login
git push origin feature/user-login

# 使用 dry-run 预览
git push --dry-run origin feature/user-login
```

#### 3. 分支保护

```bash
# 在远程仓库设置分支保护规则
# 1. 禁止直接推送到主分支
# 2. 要求 Pull Request 审查
# 3. 要求状态检查通过
# 4. 禁止强制推送

# 本地检查
git log origin/main..HEAD --oneline
```

### 团队协作上传

#### 1. 代码审查流程

```bash
# 1. 推送功能分支
git push -u origin feature/user-login

# 2. 创建 Pull Request
# 在 GitHub/GitLab 中创建 PR

# 3. 等待代码审查
# 团队成员审查代码

# 4. 根据反馈更新代码
git add .
git commit -m "Address review comments"
git push origin feature/user-login

# 5. 合并到主分支
# 通过 PR 合并
```

#### 2. 协作分支管理

```bash
# 查看团队成员的更改
git fetch origin
git log origin/develop..HEAD --oneline

# 同步团队更改
git pull origin develop

# 解决冲突
# 编辑冲突文件...
git add .
git commit -m "Resolve conflicts with team changes"

# 推送更新
git push origin feature/user-login
```

#### 3. 分支命名规范

```bash
# 功能分支
feature/user-authentication
feature/payment-integration
feature/admin-dashboard

# 修复分支
bugfix/login-validation
bugfix/database-connection

# 发布分支
release/v1.2.0
release/v2.0.0

# 热修复分支
hotfix/security-patch
hotfix/critical-bug
```

### 高级上传技巧

#### 1. 部分推送

```bash
# 推送特定提交
git push origin <commit-hash>:feature/user-login

# 推送特定文件
git push origin HEAD:feature/user-login -- path/to/file

# 推送特定范围
git push origin HEAD~3:feature/user-login
```

#### 2. 推送历史

```bash
# 查看推送历史
git reflog show origin/feature/user-login

# 查看远程分支历史
git log origin/feature/user-login --oneline

# 比较本地和远程
git log HEAD..origin/feature/user-login --oneline
git log origin/feature/user-login..HEAD --oneline
```

#### 3. 推送配置

```bash
# 设置推送策略
git config push.default simple
git config push.default current
git config push.default upstream
git config push.default matching

# 设置推送选项
git config push.autoSetupRemote true
git config push.followTags true
```

### 常见问题解决

#### 1. 推送被拒绝

```bash
# 错误：推送被拒绝，远程分支包含本地没有的提交

# 解决方案1：拉取并合并
git pull origin feature/user-login
git push origin feature/user-login

# 解决方案2：变基
git pull --rebase origin feature/user-login
git push origin feature/user-login

# 解决方案3：强制推送（谨慎使用）
git push --force-with-lease origin feature/user-login
```

#### 2. 权限问题

```bash
# 检查 SSH 连接
ssh -T git@github.com

# 检查远程仓库权限
git remote -v

# 重新配置远程仓库
git remote set-url origin git@github.com:username/repository.git
```

#### 3. 网络问题

```bash
# 设置代理
git config --global http.proxy http://proxy.example.com:8080

# 增加缓冲区大小
git config --global http.postBuffer 524288000

# 设置超时时间
git config --global http.lowSpeedLimit 0
git config --global http.lowSpeedTime 999999
```

### 最佳实践

#### 1. 推送前检查清单

```bash
# 1. 检查工作区状态
git status

# 2. 运行测试
npm test

# 3. 运行代码检查
npm run lint

# 4. 检查提交信息
git log --oneline -3

# 5. 拉取最新更改
git pull origin main

# 6. 推送分支
git push origin feature/user-login
```

#### 2. 提交信息规范

```bash
# 使用清晰的提交信息
git commit -m "feat(user): add user login functionality

- Add login form component with validation
- Add authentication service
- Add unit tests for login flow
- Update API documentation

Closes #123"
```

#### 3. 分支管理

```bash
# 定期清理分支
git branch --merged | grep -v "\*" | xargs -n 1 git branch -d

# 同步远程分支
git fetch --prune

# 更新本地分支
git pull origin main
```

### 总结

通过本章的学习，你应该掌握了：

1. **上传基础**：理解分支上传的概念和优势
2. **基本操作**：推送分支到远程仓库
3. **上传策略**：不同类型分支的上传策略
4. **冲突处理**：处理推送和合并冲突
5. **安全上传**：安全的上传实践
6. **团队协作**：在团队中协作上传
7. **问题解决**：解决常见的上传问题

分支上传是 Git 协作开发的核心，掌握这些技能将大大提高你的团队协作效率。