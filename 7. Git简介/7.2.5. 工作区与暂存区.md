## 工作区与暂存区

工作区和暂存区是 Git 版本控制系统的核心概念，理解这两个区域的工作原理对于有效使用 Git 至关重要。本章将详细介绍工作区和暂存区的概念、操作和管理。

### Git 的三个区域

#### 1. Git 的基本架构

Git 使用三个主要区域来管理文件：

- **工作区（Working Directory）**：实际编辑文件的地方
- **暂存区（Staging Area）**：准备提交的文件
- **仓库区（Repository）**：已提交的版本历史

#### 2. 文件状态流转

```
工作区 ←→ 暂存区 ←→ 仓库区
   ↓         ↓         ↓
 已修改    已暂存    已提交
```

### 工作区（Working Directory）

#### 1. 什么是工作区

工作区是你在本地计算机上实际编辑文件的地方：

- **实际文件**：你直接编辑的源代码文件
- **文件系统**：操作系统文件系统中的实际文件
- **可见文件**：你可以用编辑器直接查看和修改的文件

#### 2. 工作区的特点

```bash
# 工作区中的文件状态
# 1. 已跟踪文件（Tracked）
#    - 已修改（Modified）
#    - 未修改（Unmodified）

# 2. 未跟踪文件（Untracked）
#    - 新创建的文件
#    - 不在版本控制中的文件

# 查看工作区状态
git status

# 查看工作区中的文件
ls -la

# 查看工作区中的更改
git diff
```

#### 3. 工作区操作

```bash
# 查看工作区状态
git status

# 查看工作区中的更改
git diff

# 查看特定文件的更改
git diff filename.txt

# 查看工作区中的未跟踪文件
git status --porcelain | grep '^??'

# 查看工作区中的已修改文件
git status --porcelain | grep '^ M'
```

### 暂存区（Staging Area）

#### 1. 什么是暂存区

暂存区是 Git 中的一个中间区域，用于准备下一次提交：

- **准备区域**：将要提交的文件
- **快照区域**：提交时的文件状态
- **选择区域**：可以选择性地添加文件

#### 2. 暂存区的特点

```bash
# 暂存区的作用
# 1. 选择要提交的文件
# 2. 准备提交的快照
# 3. 分离工作区和提交

# 查看暂存区状态
git status

# 查看暂存区中的更改
git diff --cached

# 查看暂存区中的文件
git ls-files --stage
```

#### 3. 暂存区操作

```bash
# 添加文件到暂存区
git add filename.txt

# 添加多个文件到暂存区
git add file1.txt file2.txt

# 添加所有文件到暂存区
git add .

# 添加特定类型的文件
git add *.js
git add src/

# 交互式添加
git add -i

# 从暂存区移除文件
git reset HEAD filename.txt

# 查看暂存区中的更改
git diff --cached
```

### 工作区与暂存区的交互

#### 1. 文件状态变化

```bash
# 文件状态变化流程
# 1. 工作区修改文件
echo "new content" > file.txt

# 2. 查看状态
git status
# 显示：modified: file.txt

# 3. 添加到暂存区
git add file.txt

# 4. 查看状态
git status
# 显示：staged: file.txt

# 5. 提交
git commit -m "Update file.txt"
```

#### 2. 状态检查

```bash
# 查看详细状态
git status

# 查看简短状态
git status -s

# 查看忽略的文件
git status --ignored

# 查看未跟踪的文件
git status --porcelain | grep '^??'

# 查看已修改的文件
git status --porcelain | grep '^ M'

# 查看已暂存的文件
git status --porcelain | grep '^M '
```

#### 3. 差异比较

```bash
# 比较工作区和暂存区
git diff

# 比较暂存区和仓库区
git diff --cached

# 比较工作区和仓库区
git diff HEAD

# 比较特定文件
git diff filename.txt
git diff --cached filename.txt
git diff HEAD filename.txt
```

### 高级操作

#### 1. 交互式暂存

```bash
# 交互式添加文件
git add -i

# 或者使用新的交互式命令
git add -p

# 交互式添加特定文件
git add -p filename.txt

# 交互式添加所有文件
git add -p .
```

#### 2. 部分暂存

```bash
# 暂存文件的部分更改
git add -p filename.txt

# 暂存特定行
# 在交互式模式中选择要暂存的行

# 暂存特定块
# 在交互式模式中选择要暂存的文件块
```

#### 3. 暂存区管理

```bash
# 查看暂存区内容
git ls-files --stage

# 查看暂存区中的文件
git diff --cached --name-only

# 查看暂存区中的文件统计
git diff --cached --stat

# 清空暂存区
git reset HEAD

# 重置暂存区到特定提交
git reset HEAD~1
```

### 工作区管理

#### 1. 工作区清理

```bash
# 丢弃工作区的更改
git checkout -- filename.txt

# 丢弃所有工作区更改
git checkout -- .

# 使用新语法丢弃更改
git restore filename.txt
git restore .

# 强制丢弃更改
git checkout --force filename.txt
```

#### 2. 工作区状态

```bash
# 查看工作区是否干净
git status --porcelain

# 检查是否有未提交的更改
if [ -n "$(git status --porcelain)" ]; then
    echo "工作区有未提交的更改"
else
    echo "工作区是干净的"
fi

# 查看工作区中的文件数量
git status --porcelain | wc -l
```

#### 3. 工作区备份

```bash
# 创建临时分支保存工作区状态
git stash

# 创建带消息的 stash
git stash push -m "WIP: working on feature"

# 查看 stash 列表
git stash list

# 应用 stash
git stash pop
git stash apply

# 删除 stash
git stash drop
git stash clear
```

### 暂存区管理

#### 1. 暂存区操作

```bash
# 查看暂存区状态
git status

# 查看暂存区中的文件
git diff --cached --name-only

# 查看暂存区中的更改
git diff --cached

# 查看暂存区中的文件统计
git diff --cached --stat
```

#### 2. 暂存区重置

```bash
# 重置暂存区到 HEAD
git reset HEAD

# 重置特定文件
git reset HEAD filename.txt

# 重置到特定提交
git reset HEAD~1

# 使用新语法
git restore --staged filename.txt
git restore --staged .
```

#### 3. 暂存区比较

```bash
# 比较暂存区和工作区
git diff

# 比较暂存区和仓库区
git diff --cached

# 比较工作区和仓库区
git diff HEAD

# 比较特定文件
git diff filename.txt
git diff --cached filename.txt
git diff HEAD filename.txt
```

### 实际应用场景

#### 1. 日常开发流程

```bash
# 1. 修改文件
echo "new content" > file.txt

# 2. 查看更改
git diff

# 3. 添加到暂存区
git add file.txt

# 4. 查看暂存区状态
git diff --cached

# 5. 提交
git commit -m "Update file.txt"
```

#### 2. 选择性提交

```bash
# 1. 修改多个文件
echo "content1" > file1.txt
echo "content2" > file2.txt
echo "content3" > file3.txt

# 2. 查看所有更改
git diff

# 3. 选择性添加到暂存区
git add file1.txt file2.txt

# 4. 查看暂存区状态
git diff --cached

# 5. 提交部分更改
git commit -m "Update file1 and file2"

# 6. 处理剩余文件
git add file3.txt
git commit -m "Update file3"
```

#### 3. 错误修正

```bash
# 1. 意外添加到暂存区
git add wrong-file.txt

# 2. 从暂存区移除
git reset HEAD wrong-file.txt

# 3. 添加正确的文件
git add correct-file.txt

# 4. 提交
git commit -m "Add correct file"
```

### 最佳实践

#### 1. 工作区管理

```bash
# 1. 经常检查工作区状态
git status

# 2. 及时提交更改
git add .
git commit -m "Meaningful commit message"

# 3. 使用 stash 保存临时更改
git stash push -m "WIP: working on feature"

# 4. 保持工作区整洁
git clean -fd  # 删除未跟踪的文件和目录
```

#### 2. 暂存区管理

```bash
# 1. 使用暂存区进行选择性提交
git add -p filename.txt

# 2. 提交前检查暂存区
git diff --cached

# 3. 使用暂存区分离关注点
# 将相关更改分组提交

# 4. 避免提交不完整的更改
# 确保每个提交都是完整的功能
```

#### 3. 状态检查

```bash
# 1. 提交前检查状态
git status
git diff --cached

# 2. 使用简短状态
git status -s

# 3. 检查特定文件
git diff filename.txt
git diff --cached filename.txt

# 4. 检查工作区是否干净
git status --porcelain
```

### 常见问题解决

#### 1. 意外更改

```bash
# 丢弃工作区更改
git checkout -- filename.txt

# 丢弃所有更改
git checkout -- .

# 使用新语法
git restore filename.txt
git restore .
```

#### 2. 暂存区错误

```bash
# 从暂存区移除文件
git reset HEAD filename.txt

# 清空暂存区
git reset HEAD

# 使用新语法
git restore --staged filename.txt
git restore --staged .
```

#### 3. 状态混乱

```bash
# 查看详细状态
git status

# 查看所有更改
git diff
git diff --cached
git diff HEAD

# 重置到干净状态
git reset --hard HEAD
git clean -fd
```

### 总结

通过本章的学习，你应该掌握了：

1. **Git 架构**：理解工作区、暂存区和仓库区的关系
2. **工作区管理**：管理实际编辑的文件
3. **暂存区操作**：使用暂存区准备提交
4. **状态检查**：查看文件在不同区域的状态
5. **差异比较**：比较不同区域之间的差异
6. **高级操作**：交互式暂存和部分暂存
7. **实际应用**：在日常开发中的应用场景
8. **最佳实践**：工作区和暂存区的最佳使用方式
9. **问题解决**：解决常见的问题和错误

工作区和暂存区是 Git 的核心概念，掌握这些知识将大大提高你的 Git 使用效率。