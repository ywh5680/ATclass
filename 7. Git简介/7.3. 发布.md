## 发布

发布是将开发完成的代码部署到生产环境的过程，包括版本管理、发布准备、部署和发布后管理。本章将详细介绍如何使用 Git 进行发布管理。

### 发布基础

#### 1. 什么是发布

发布是将软件从开发环境部署到生产环境的过程：

- **版本管理**：管理软件的不同版本
- **质量保证**：确保发布版本的质量
- **部署管理**：将代码部署到生产环境
- **回滚机制**：在出现问题时快速回滚

#### 2. 发布的重要性

- **用户交付**：向用户交付新功能
- **质量保证**：确保生产环境的稳定性
- **版本控制**：管理软件版本的生命周期
- **团队协作**：协调开发、测试、运维团队

### 版本管理

#### 1. 语义化版本

```bash
# 语义化版本格式：主版本.次版本.修订版本
# 例如：1.2.3

# 主版本：不兼容的 API 修改
# 次版本：向下兼容的功能性新增
# 修订版本：向下兼容的问题修正

# 更新版本号
npm version patch  # 1.2.3 -> 1.2.4
npm version minor  # 1.2.3 -> 1.3.0
npm version major  # 1.2.3 -> 2.0.0

# 手动更新版本号
echo '{"version": "1.2.4"}' > package.json
git add package.json
git commit -m "Bump version to 1.2.4"
```

#### 2. 版本标签

```bash
# 创建版本标签
git tag v1.2.3

# 创建带注释的标签
git tag -a v1.2.3 -m "Release version 1.2.3"

# 推送标签
git push origin v1.2.3

# 推送所有标签
git push origin --tags

# 查看标签
git tag

# 查看标签详细信息
git show v1.2.3

# 删除标签
git tag -d v1.2.3
git push origin --delete v1.2.3
```

#### 3. 版本分支

```bash
# 创建发布分支
git checkout -b release/v1.2.0

# 更新版本号
# 编辑 package.json 或其他版本文件
git add .
git commit -m "Bump version to 1.2.0"

# 合并到主分支
git checkout main
git merge release/v1.2.0

# 创建标签
git tag v1.2.0

# 推送
git push origin main
git push origin v1.2.0

# 删除发布分支
git branch -d release/v1.2.0
```

### 发布准备

#### 1. 发布检查清单

```bash
# 创建发布检查脚本
cat > scripts/pre-release-check.sh << 'EOF'
#!/bin/bash

echo "开始发布前检查..."

# 1. 检查工作区状态
if [ -n "$(git status --porcelain)" ]; then
    echo "错误：工作区有未提交的更改"
    exit 1
fi

# 2. 运行测试
echo "运行测试..."
npm test
if [ $? -ne 0 ]; then
    echo "错误：测试失败"
    exit 1
fi

# 3. 运行代码检查
echo "运行代码检查..."
npm run lint
if [ $? -ne 0 ]; then
    echo "错误：代码检查失败"
    exit 1
fi

# 4. 构建项目
echo "构建项目..."
npm run build
if [ $? -ne 0 ]; then
    echo "错误：构建失败"
    exit 1
fi

# 5. 检查依赖
echo "检查依赖..."
npm audit
if [ $? -ne 0 ]; then
    echo "警告：发现安全漏洞"
fi

echo "发布前检查完成！"
EOF

chmod +x scripts/pre-release-check.sh
```

#### 2. 发布分支准备

```bash
# 创建发布分支
git checkout main
git pull origin main
git checkout -b release/v1.2.0

# 更新版本号
npm version patch --no-git-tag-version
VERSION=$(node -p "require('./package.json').version")

# 更新 CHANGELOG
cat >> CHANGELOG.md << EOF

## [${VERSION}] - $(date +%Y-%m-%d)

### 新增
- 新功能1
- 新功能2

### 变更
- 功能改进1
- 功能改进2

### 修复
- 修复问题1
- 修复问题2
EOF

# 提交更改
git add .
git commit -m "Prepare release ${VERSION}"
```

#### 3. 发布文档

```bash
# 创建发布说明
cat > RELEASE_NOTES.md << 'EOF'
# Release Notes v1.2.0

## 概述
本次发布包含新功能和问题修复。

## 新功能
- 用户认证系统
- 数据导出功能
- 性能监控

## 改进
- 界面响应速度提升
- 数据库查询优化
- 错误处理改进

## 修复
- 修复登录验证问题
- 修复数据导出错误
- 修复内存泄漏问题

## 已知问题
- 在某些浏览器中可能存在兼容性问题

## 升级指南
1. 备份当前数据
2. 停止服务
3. 部署新版本
4. 运行数据库迁移
5. 启动服务
6. 验证功能

## 回滚指南
如果出现问题，可以回滚到 v1.1.0：
1. 停止服务
2. 恢复备份
3. 部署 v1.1.0
4. 启动服务
EOF

git add RELEASE_NOTES.md
git commit -m "Add release notes for v1.2.0"
```

### 发布流程

#### 1. 自动化发布

```bash
# 创建发布脚本
cat > scripts/release.sh << 'EOF'
#!/bin/bash

VERSION=$1
if [ -z "$VERSION" ]; then
    echo "用法: ./scripts/release.sh <version>"
    exit 1
fi

echo "开始发布版本 ${VERSION}..."

# 1. 运行发布前检查
./scripts/pre-release-check.sh

# 2. 创建发布分支
git checkout main
git pull origin main
git checkout -b release/v${VERSION}

# 3. 更新版本号
npm version ${VERSION} --no-git-tag-version

# 4. 更新 CHANGELOG
# 这里可以添加自动更新 CHANGELOG 的逻辑

# 5. 提交更改
git add .
git commit -m "Prepare release v${VERSION}"

# 6. 合并到主分支
git checkout main
git merge release/v${VERSION}

# 7. 创建标签
git tag v${VERSION}

# 8. 推送到远程
git push origin main
git push origin v${VERSION}

# 9. 删除发布分支
git branch -d release/v${VERSION}

echo "发布完成！"
EOF

chmod +x scripts/release.sh
```

#### 2. 手动发布

```bash
# 1. 创建发布分支
git checkout main
git pull origin main
git checkout -b release/v1.2.0

# 2. 更新版本号
npm version patch --no-git-tag-version

# 3. 更新文档
# 编辑 CHANGELOG.md, README.md 等

# 4. 提交更改
git add .
git commit -m "Prepare release v1.2.0"

# 5. 测试发布版本
npm test
npm run build

# 6. 合并到主分支
git checkout main
git merge release/v1.2.0

# 7. 创建标签
git tag v1.2.0

# 8. 推送到远程
git push origin main
git push origin v1.2.0

# 9. 删除发布分支
git branch -d release/v1.2.0
```

#### 3. 持续集成发布

```bash
# GitHub Actions 发布配置
cat > .github/workflows/release.yml << 'EOF'
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build project
      run: npm run build
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          Release ${{ github.ref }}
          
          See CHANGELOG.md for details.
        draft: false
        prerelease: false
    
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/app.zip
        asset_name: app.zip
        asset_content_type: application/zip
EOF
```

### 部署管理

#### 1. 部署脚本

```bash
# 创建部署脚本
cat > scripts/deploy.sh << 'EOF'
#!/bin/bash

VERSION=$1
ENVIRONMENT=$2

if [ -z "$VERSION" ] || [ -z "$ENVIRONMENT" ]; then
    echo "用法: ./scripts/deploy.sh <version> <environment>"
    echo "环境: staging, production"
    exit 1
fi

echo "开始部署版本 ${VERSION} 到 ${ENVIRONMENT}..."

# 1. 检查版本是否存在
if ! git tag -l | grep -q "v${VERSION}"; then
    echo "错误：版本 v${VERSION} 不存在"
    exit 1
fi

# 2. 检出版本
git checkout v${VERSION}

# 3. 安装依赖
npm ci --production

# 4. 构建项目
npm run build

# 5. 部署到环境
case $ENVIRONMENT in
    staging)
        echo "部署到测试环境..."
        # 这里添加测试环境部署命令
        ;;
    production)
        echo "部署到生产环境..."
        # 这里添加生产环境部署命令
        ;;
    *)
        echo "错误：未知环境 ${ENVIRONMENT}"
        exit 1
        ;;
esac

echo "部署完成！"
EOF

chmod +x scripts/deploy.sh
```

#### 2. 环境管理

```bash
# 创建环境配置
cat > config/environments.js << 'EOF'
module.exports = {
  development: {
    apiUrl: 'http://localhost:3000',
    debug: true,
    logLevel: 'debug'
  },
  staging: {
    apiUrl: 'https://staging-api.example.com',
    debug: false,
    logLevel: 'info'
  },
  production: {
    apiUrl: 'https://api.example.com',
    debug: false,
    logLevel: 'error'
  }
};
EOF

# 创建环境切换脚本
cat > scripts/switch-env.sh << 'EOF'
#!/bin/bash

ENVIRONMENT=$1

if [ -z "$ENVIRONMENT" ]; then
    echo "用法: ./scripts/switch-env.sh <environment>"
    echo "环境: development, staging, production"
    exit 1
fi

echo "切换到环境: ${ENVIRONMENT}"

# 更新环境变量
export NODE_ENV=${ENVIRONMENT}

# 重启服务
npm run restart

echo "环境切换完成！"
EOF

chmod +x scripts/switch-env.sh
```

#### 3. 回滚机制

```bash
# 创建回滚脚本
cat > scripts/rollback.sh << 'EOF'
#!/bin/bash

VERSION=$1

if [ -z "$VERSION" ]; then
    echo "用法: ./scripts/rollback.sh <version>"
    exit 1
fi

echo "开始回滚到版本 ${VERSION}..."

# 1. 检查版本是否存在
if ! git tag -l | grep -q "v${VERSION}"; then
    echo "错误：版本 v${VERSION} 不存在"
    exit 1
fi

# 2. 停止服务
echo "停止服务..."
# 这里添加停止服务的命令

# 3. 备份当前版本
echo "备份当前版本..."
# 这里添加备份命令

# 4. 检出目标版本
git checkout v${VERSION}

# 5. 重新部署
./scripts/deploy.sh ${VERSION} production

# 6. 启动服务
echo "启动服务..."
# 这里添加启动服务的命令

echo "回滚完成！"
EOF

chmod +x scripts/rollback.sh
```

### 发布后管理

#### 1. 监控和日志

```bash
# 创建监控脚本
cat > scripts/monitor.sh << 'EOF'
#!/bin/bash

echo "开始监控服务状态..."

# 检查服务状态
if curl -f http://localhost:3000/health; then
    echo "服务运行正常"
else
    echo "服务异常，发送告警"
    # 这里添加告警逻辑
fi

# 检查日志
tail -n 100 /var/log/app.log | grep -i error

# 检查资源使用
df -h
free -h
top -bn1 | head -20

echo "监控完成！"
EOF

chmod +x scripts/monitor.sh
```

#### 2. 性能监控

```bash
# 创建性能监控脚本
cat > scripts/performance.sh << 'EOF'
#!/bin/bash

echo "开始性能监控..."

# 检查响应时间
response_time=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:3000/api/health)
echo "响应时间: ${response_time}s"

# 检查内存使用
memory_usage=$(ps aux | grep node | awk '{sum+=$6} END {print sum/1024 " MB"}')
echo "内存使用: ${memory_usage}"

# 检查 CPU 使用
cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
echo "CPU 使用: ${cpu_usage}%"

# 检查磁盘使用
disk_usage=$(df -h / | awk 'NR==2 {print $5}' | cut -d'%' -f1)
echo "磁盘使用: ${disk_usage}%"

echo "性能监控完成！"
EOF

chmod +x scripts/performance.sh
```

#### 3. 用户反馈

```bash
# 创建反馈收集脚本
cat > scripts/feedback.sh << 'EOF'
#!/bin/bash

echo "收集用户反馈..."

# 检查错误日志
error_count=$(grep -c "ERROR" /var/log/app.log)
echo "错误数量: ${error_count}"

# 检查用户访问
access_count=$(grep -c "GET" /var/log/access.log)
echo "访问数量: ${access_count}"

# 检查性能指标
slow_queries=$(grep -c "slow query" /var/log/app.log)
echo "慢查询数量: ${slow_queries}"

# 生成报告
cat > feedback-report.md << EOL
# 用户反馈报告

## 错误统计
- 错误数量: ${error_count}

## 访问统计
- 访问数量: ${access_count}

## 性能统计
- 慢查询数量: ${slow_queries}

## 建议
- 根据错误日志优化代码
- 根据访问统计优化性能
- 根据慢查询优化数据库
EOL

echo "反馈收集完成！"
EOF

chmod +x scripts/feedback.sh
```

### 最佳实践

#### 1. 发布流程

```bash
# 1. 准备发布
./scripts/pre-release-check.sh

# 2. 创建发布分支
git checkout -b release/v1.2.0

# 3. 更新版本和文档
npm version patch --no-git-tag-version
# 编辑 CHANGELOG.md

# 4. 测试发布版本
npm test
npm run build

# 5. 合并和标签
git checkout main
git merge release/v1.2.0
git tag v1.2.0

# 6. 推送
git push origin main
git push origin v1.2.0

# 7. 部署
./scripts/deploy.sh 1.2.0 production

# 8. 监控
./scripts/monitor.sh
```

#### 2. 版本管理

```bash
# 1. 使用语义化版本
# 主版本.次版本.修订版本

# 2. 创建有意义的标签
git tag -a v1.2.3 -m "Release version 1.2.3"

# 3. 维护 CHANGELOG
# 记录每个版本的变更

# 4. 使用发布分支
# 隔离发布准备工作
```

#### 3. 部署策略

```bash
# 1. 蓝绿部署
# 维护两个相同的生产环境

# 2. 滚动部署
# 逐步更新服务实例

# 3. 金丝雀部署
# 先向小部分用户发布

# 4. 回滚准备
# 随时准备回滚到上一个版本
```

### 总结

通过本章的学习，你应该掌握了：

1. **发布基础**：理解发布的概念和重要性
2. **版本管理**：管理软件版本和标签
3. **发布准备**：准备发布前的检查和文档
4. **发布流程**：自动化和手动发布流程
5. **部署管理**：管理不同环境的部署
6. **发布后管理**：监控和维护发布后的系统
7. **最佳实践**：发布管理的最佳方式

发布管理是软件开发生命周期的重要环节，掌握这些知识将帮助你更好地管理软件发布。