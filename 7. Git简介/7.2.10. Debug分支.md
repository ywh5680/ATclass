## Debug 分支

Debug 分支是用于调试和问题排查的专用分支，它允许开发者在不影响主代码的情况下进行调试工作。本章将详细介绍如何创建、使用和管理 Debug 分支。

### Debug 分支基础

#### 1. 什么是 Debug 分支

Debug 分支是专门用于调试和问题排查的分支：

- **隔离环境**：在不影响主代码的环境中进行调试
- **实验性更改**：可以安全地进行实验性修改
- **问题定位**：专门用于定位和修复问题
- **临时工作**：用于临时的调试工作

#### 2. Debug 分支的优势

- **安全调试**：不会影响主分支的稳定性
- **灵活实验**：可以自由地进行各种调试尝试
- **问题隔离**：将调试工作与正常开发分离
- **快速回滚**：可以快速回滚调试更改

### 创建 Debug 分支

#### 1. 基本创建

```bash
# 从主分支创建 Debug 分支
git checkout main
git pull origin main
git checkout -b debug/issue-123

# 从开发分支创建 Debug 分支
git checkout develop
git pull origin develop
git checkout -b debug/feature-bug

# 从特定提交创建 Debug 分支
git checkout -b debug/old-version <commit-hash>

# 从标签创建 Debug 分支
git checkout -b debug/v1.0-issue v1.0.0
```

#### 2. 命名规范

```bash
# Debug 分支命名规范
debug/issue-123              # 特定问题调试
debug/feature-bug            # 功能调试
debug/performance-issue      # 性能问题调试
debug/security-vulnerability # 安全问题调试
debug/regression-test        # 回归测试调试
debug/user-reported-bug      # 用户报告的问题调试

# 时间相关的命名
debug/2024-01-15-issue       # 日期相关
debug/urgent-fix             # 紧急修复
debug/temp-debug             # 临时调试
```

#### 3. 创建策略

```bash
# 1. 确保基础分支是最新的
git checkout main
git pull origin main

# 2. 创建 Debug 分支
git checkout -b debug/issue-123

# 3. 设置上游分支（可选）
git push -u origin debug/issue-123

# 4. 添加调试信息
echo "# Debug branch for issue #123" >> DEBUG.md
git add DEBUG.md
git commit -m "Add debug documentation"
```

### Debug 分支使用

#### 1. 调试工作流程

```bash
# 1. 切换到 Debug 分支
git checkout debug/issue-123

# 2. 添加调试代码
echo "console.log('Debug info');" >> src/debug.js
git add src/debug.js
git commit -m "Add debug logging"

# 3. 运行调试
npm run debug

# 4. 分析问题
# 查看日志、错误信息等

# 5. 修复问题
# 编辑文件...
git add .
git commit -m "Fix issue #123"

# 6. 测试修复
npm test

# 7. 清理调试代码
git reset --soft HEAD~2  # 撤销调试提交
git add .
git commit -m "Fix issue #123 (clean version)"
```

#### 2. 调试工具集成

```bash
# 添加调试配置文件
cat > debug.config.js << 'EOF'
module.exports = {
  debug: true,
  logLevel: 'debug',
  enableProfiling: true,
  enableTracing: true
};
EOF

# 添加调试脚本
cat > scripts/debug.sh << 'EOF'
#!/bin/bash
echo "Starting debug mode..."
export NODE_ENV=debug
export DEBUG=*
npm run start
EOF

chmod +x scripts/debug.sh

# 提交调试配置
git add debug.config.js scripts/debug.sh
git commit -m "Add debug configuration and scripts"
```

#### 3. 调试信息管理

```bash
# 创建调试文档
cat > DEBUG.md << 'EOF'
# Debug Branch: issue-123

## Problem Description
[描述问题]

## Debug Steps
1. [调试步骤1]
2. [调试步骤2]
3. [调试步骤3]

## Findings
[发现的问题]

## Solution
[解决方案]

## Notes
[注意事项]
EOF

git add DEBUG.md
git commit -m "Add debug documentation"
```

### 调试技巧

#### 1. 二分查找调试

```bash
# 使用 git bisect 进行二分查找
git bisect start
git bisect bad HEAD
git bisect good v1.0.0

# 测试当前版本
# 运行测试...

# 标记结果
git bisect good  # 或 git bisect bad

# 重复直到找到问题提交
git bisect reset
```

#### 2. 临时调试

```bash
# 临时添加调试信息
echo "// DEBUG: " $(date) >> src/file.js
echo "console.log('Debug point 1');" >> src/file.js

# 运行调试
npm run debug

# 查看结果后删除调试代码
git checkout -- src/file.js

# 或者使用 stash
git stash push -m "Temporary debug changes"
# 调试完成后
git stash pop
```

#### 3. 条件调试

```bash
# 添加条件调试代码
cat >> src/debug.js << 'EOF'
if (process.env.DEBUG) {
  console.log('Debug info:', {
    timestamp: new Date(),
    user: currentUser,
    action: currentAction
  });
}
EOF

# 运行条件调试
DEBUG=true npm run start
```

### 问题定位

#### 1. 日志分析

```bash
# 添加详细日志
cat >> src/logger.js << 'EOF'
const debug = require('debug')('app:debug');

function logDebug(message, data) {
  if (process.env.DEBUG) {
    debug(message, data);
  }
}

module.exports = { logDebug };
EOF

# 运行带日志的调试
DEBUG=app:* npm run start
```

#### 2. 性能分析

```bash
# 添加性能监控
cat >> src/performance.js << 'EOF'
const startTime = Date.now();

function logPerformance(operation) {
  const duration = Date.now() - startTime;
  console.log(`Performance: ${operation} took ${duration}ms`);
}

module.exports = { logPerformance };
EOF

# 运行性能分析
npm run profile
```

#### 3. 内存分析

```bash
# 添加内存监控
cat >> src/memory.js << 'EOF'
const used = process.memoryUsage();

function logMemory() {
  console.log('Memory usage:');
  console.log(`  RSS: ${Math.round(used.rss / 1024 / 1024 * 100) / 100} MB`);
  console.log(`  Heap Total: ${Math.round(used.heapTotal / 1024 / 1024 * 100) / 100} MB`);
  console.log(`  Heap Used: ${Math.round(used.heapUsed / 1024 / 1024 * 100) / 100} MB`);
}

module.exports = { logMemory };
EOF
```

### 修复和测试

#### 1. 问题修复

```bash
# 1. 定位问题
# 通过调试找到问题根源

# 2. 实施修复
# 编辑相关文件...

# 3. 提交修复
git add .
git commit -m "Fix issue #123: [具体修复内容]"

# 4. 测试修复
npm test
npm run integration-test

# 5. 验证修复
# 手动测试相关功能
```

#### 2. 回归测试

```bash
# 运行完整测试套件
npm test

# 运行集成测试
npm run integration-test

# 运行性能测试
npm run performance-test

# 运行安全测试
npm run security-test

# 运行用户验收测试
npm run uat
```

#### 3. 修复验证

```bash
# 1. 验证修复是否有效
# 重现原始问题场景

# 2. 验证没有引入新问题
# 运行相关测试

# 3. 验证性能影响
# 运行性能基准测试

# 4. 验证兼容性
# 测试不同环境下的兼容性
```

### 分支管理

#### 1. 分支同步

```bash
# 同步主分支的更新
git checkout main
git pull origin main
git checkout debug/issue-123
git merge main

# 或者使用变基
git checkout debug/issue-123
git rebase main

# 解决冲突（如果有）
# 编辑冲突文件...
git add .
git rebase --continue
```

#### 2. 分支清理

```bash
# 删除已修复的 Debug 分支
git checkout main
git branch -d debug/issue-123

# 删除远程 Debug 分支
git push origin --delete debug/issue-123

# 清理过期的 Debug 分支
git branch | grep "debug/" | xargs git branch -D

# 清理远程过期的 Debug 分支
git branch -r | grep "origin/debug/" | sed 's/origin\///' | xargs -I {} git push origin --delete {}
```

#### 3. 分支归档

```bash
# 创建修复记录
git checkout debug/issue-123
git log --oneline > fix-record.txt

# 创建修复补丁
git format-patch main..debug/issue-123

# 创建修复总结
cat > FIX_SUMMARY.md << 'EOF'
# Fix Summary: issue-123

## Problem
[问题描述]

## Root Cause
[根本原因]

## Solution
[解决方案]

## Testing
[测试结果]

## Files Changed
[修改的文件列表]
EOF

git add FIX_SUMMARY.md
git commit -m "Add fix summary"
```

### 最佳实践

#### 1. Debug 分支创建

```bash
# 1. 从稳定的基础分支创建
git checkout main
git pull origin main
git checkout -b debug/issue-123

# 2. 使用清晰的命名
debug/issue-123
debug/feature-bug
debug/performance-issue

# 3. 添加调试文档
echo "# Debug: issue-123" > DEBUG.md
git add DEBUG.md
git commit -m "Add debug documentation"
```

#### 2. 调试过程

```bash
# 1. 记录调试步骤
# 在 DEBUG.md 中记录每个步骤

# 2. 使用版本控制
# 每个调试尝试都提交

# 3. 保持分支整洁
# 定期清理调试代码

# 4. 及时同步主分支
# 避免与主分支差异过大
```

#### 3. 修复流程

```bash
# 1. 确认问题根源
# 通过调试确认问题原因

# 2. 实施最小修复
# 只修复必要的问题

# 3. 充分测试
# 运行相关测试套件

# 4. 记录修复过程
# 在文档中记录修复过程

# 5. 清理调试代码
# 移除调试相关的代码
```

### 常见问题解决

#### 1. 调试分支冲突

```bash
# 解决合并冲突
git checkout debug/issue-123
git merge main
# 解决冲突...
git add .
git commit -m "Resolve merge conflicts"

# 或者使用变基
git rebase main
# 解决冲突...
git add .
git rebase --continue
```

#### 2. 调试分支过期

```bash
# 更新调试分支
git checkout debug/issue-123
git rebase main

# 或者重新创建
git checkout main
git pull origin main
git checkout -b debug/issue-123-v2
```

#### 3. 调试信息丢失

```bash
# 查看调试历史
git log --oneline debug/issue-123

# 恢复调试信息
git checkout debug/issue-123 -- DEBUG.md

# 查看调试提交
git show <debug-commit-hash>
```

### 总结

通过本章的学习，你应该掌握了：

1. **Debug 分支基础**：理解 Debug 分支的概念和优势
2. **分支创建**：创建和管理 Debug 分支
3. **调试工作流程**：在 Debug 分支中进行调试工作
4. **调试技巧**：使用各种调试技巧和工具
5. **问题定位**：定位和诊断问题
6. **修复和测试**：修复问题并进行测试
7. **分支管理**：管理 Debug 分支的生命周期
8. **最佳实践**：Debug 分支的最佳使用方式
9. **问题解决**：解决 Debug 分支中的常见问题

Debug 分支是问题排查和修复的重要工具，掌握这些知识将大大提高你的调试效率。