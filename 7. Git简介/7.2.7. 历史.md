## 历史

Git 历史是指项目中所有提交的记录，包括每次提交的详细信息、文件更改、作者、时间等。本章将详细介绍如何查看、管理和操作 Git 历史。

### Git 历史基础

#### 1. 什么是 Git 历史

Git 历史是项目中所有提交的完整记录：

- **提交记录**：每次提交的详细信息
- **文件更改**：每次提交中的文件变化
- **作者信息**：提交者的姓名和邮箱
- **时间戳**：提交的时间
- **提交信息**：描述提交内容的文本

#### 2. 历史的重要性

- **版本追踪**：追踪代码的演变过程
- **问题定位**：找到引入问题的提交
- **代码审查**：审查代码更改历史
- **回滚操作**：回滚到之前的版本
- **团队协作**：了解团队成员的贡献

### 查看历史

#### 1. 基本历史查看

```bash
# 查看提交历史
git log

# 查看简洁历史
git log --oneline

# 查看图形历史
git log --graph --oneline

# 查看详细历史
git log --stat

# 查看完整差异
git log -p

# 查看最近 N 次提交
git log -n 5
```

#### 2. 格式化输出

```bash
# 自定义格式
git log --pretty=format:"%h - %an, %ar : %s"

# 常用格式选项
# %h - 提交哈希
# %an - 作者姓名
# %ae - 作者邮箱
# %ar - 相对时间
# %s - 提交信息
# %d - 分支和标签

# 表格格式
git log --pretty=format:"%h | %an | %ar | %s"

# JSON 格式
git log --pretty=format:'{"hash":"%h","author":"%an","date":"%ar","message":"%s"}'
```

#### 3. 过滤历史

```bash
# 按作者过滤
git log --author="username"

# 按时间过滤
git log --since="2024-01-01"
git log --until="2024-12-31"
git log --since="2 weeks ago"

# 按文件过滤
git log -- filename.txt
git log --follow filename.txt

# 按提交信息过滤
git log --grep="bug fix"

# 按提交哈希过滤
git log <commit-hash>..HEAD
```

### 历史详细信息

#### 1. 提交详情

```bash
# 查看特定提交的详情
git show <commit-hash>

# 查看提交的统计信息
git show --stat <commit-hash>

# 查看提交的完整差异
git show -p <commit-hash>

# 查看提交的文件列表
git show --name-only <commit-hash>

# 查看提交的简短信息
git show --oneline <commit-hash>
```

#### 2. 文件历史

```bash
# 查看文件的历史
git log -- filename.txt

# 查看文件的详细历史
git log -p -- filename.txt

# 查看文件的统计历史
git log --stat -- filename.txt

# 跟踪文件重命名
git log --follow -- filename.txt

# 查看文件的每一行历史
git blame filename.txt
```

#### 3. 分支历史

```bash
# 查看分支历史
git log --graph --oneline --all

# 查看特定分支的历史
git log --oneline branch-name

# 查看分支合并历史
git log --merges

# 查看分支分叉点
git merge-base branch1 branch2

# 查看分支差异
git log branch1..branch2
```

### 历史操作

#### 1. 历史搜索

```bash
# 搜索提交信息
git log --grep="bug fix"

# 搜索作者
git log --author="username"

# 搜索文件内容
git log -S "function name"

# 搜索正则表达式
git log -G "regex pattern"

# 组合搜索
git log --author="username" --grep="bug fix" --since="1 week ago"
```

#### 2. 历史比较

```bash
# 比较两个提交
git diff commit1 commit2

# 比较提交范围
git diff commit1..commit2

# 比较分支
git diff branch1..branch2

# 比较工作区和提交
git diff HEAD

# 比较暂存区和提交
git diff --cached
```

#### 3. 历史统计

```bash
# 统计提交数量
git rev-list --count HEAD

# 统计文件更改
git log --stat

# 统计作者贡献
git shortlog

# 统计作者贡献（按数量排序）
git shortlog -sn

# 统计文件大小变化
git log --stat --summary
```

### 高级历史操作

#### 1. 历史重写

```bash
# 修改最后一次提交
git commit --amend -m "Updated commit message"

# 交互式重写历史
git rebase -i HEAD~3

# 在交互式模式中的操作
# pick - 保留提交
# reword - 修改提交信息
# edit - 修改提交内容
# squash - 合并到前一个提交
# fixup - 合并到前一个提交（丢弃信息）
# drop - 删除提交

# 重写特定范围的历史
git rebase -i <start-commit>..<end-commit>
```

#### 2. 历史清理

```bash
# 删除未引用的提交
git gc

# 清理过期的引用
git reflog expire --expire=now --all

# 压缩历史
git gc --aggressive

# 删除远程分支的本地引用
git remote prune origin

# 清理本地分支
git branch --merged | grep -v "\*" | xargs -n 1 git branch -d
```

#### 3. 历史恢复

```bash
# 查看操作历史
git reflog

# 恢复删除的提交
git reflog
git checkout <commit-hash>

# 恢复删除的分支
git reflog
git checkout -b branch-name <commit-hash>

# 恢复重置的提交
git reflog
git reset --hard <commit-hash>
```

### 历史可视化

#### 1. 图形化显示

```bash
# 显示分支图
git log --graph --oneline --all

# 显示详细分支图
git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit

# 显示文件历史图
git log --graph --oneline -- filename.txt

# 显示合并历史
git log --graph --oneline --merges
```

#### 2. 外部工具

```bash
# 使用 gitk 查看历史
gitk

# 使用 git log 的图形选项
git log --graph --oneline --all --decorate

# 使用 git show-branch
git show-branch --all

# 使用 git log 的装饰选项
git log --decorate --oneline --all
```

#### 3. 自定义别名

```bash
# 创建历史查看别名
git config --global alias.lg "log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"

# 使用别名
git lg

# 创建简洁历史别名
git config --global alias.hist "log --oneline --graph --decorate"

# 使用别名
git hist
```

### 实际应用场景

#### 1. 问题定位

```bash
# 1. 找到引入问题的提交
git bisect start
git bisect bad HEAD
git bisect good <good-commit>

# 2. 测试当前版本
# 运行测试...

# 3. 标记结果
git bisect good  # 或 git bisect bad

# 4. 重复直到找到问题提交
git bisect reset
```

#### 2. 代码审查

```bash
# 1. 查看功能分支的更改
git log main..feature-branch

# 2. 查看具体更改
git diff main..feature-branch

# 3. 查看每个提交的更改
git log -p main..feature-branch

# 4. 查看统计信息
git log --stat main..feature-branch
```

#### 3. 版本发布

```bash
# 1. 查看发布版本的历史
git log --oneline v1.0.0..v1.1.0

# 2. 生成发布说明
git log --pretty=format:"- %s" v1.0.0..v1.1.0

# 3. 查看特定功能的提交
git log --grep="feature" v1.0.0..v1.1.0

# 4. 查看修复的 bug
git log --grep="fix" v1.0.0..v1.1.0
```

### 最佳实践

#### 1. 提交信息规范

```bash
# 使用清晰的提交信息
git commit -m "feat(user): add user authentication

- Add login/logout functionality
- Add user registration
- Add password reset

Closes #123"

# 避免使用模糊的信息
# 错误示例
git commit -m "fix stuff"
git commit -m "update"

# 正确示例
git commit -m "fix(auth): resolve login validation issue"
git commit -m "feat(ui): add responsive design for mobile"
```

#### 2. 历史管理

```bash
# 1. 保持提交原子性
# 每个提交只做一件事

# 2. 经常提交
# 避免大量更改一次性提交

# 3. 使用分支进行功能开发
git checkout -b feature/new-feature

# 4. 及时清理历史
git gc
git reflog expire --expire=now --all
```

#### 3. 历史查看

```bash
# 1. 使用合适的格式
git log --oneline -10

# 2. 使用图形显示
git log --graph --oneline --all

# 3. 使用过滤条件
git log --author="username" --since="1 week ago"

# 4. 使用别名简化操作
git config --global alias.lg "log --graph --oneline --all"
```

### 常见问题解决

#### 1. 历史丢失

```bash
# 查看 reflog
git reflog

# 恢复丢失的提交
git checkout <commit-hash>

# 创建新分支
git checkout -b recovered-branch

# 恢复分支
git branch recovered-branch <commit-hash>
```

#### 2. 历史混乱

```bash
# 查看当前状态
git status
git log --oneline -5

# 重置到干净状态
git reset --hard HEAD

# 清理未跟踪文件
git clean -fd

# 重新开始
git checkout -b clean-branch
```

#### 3. 历史过大

```bash
# 清理历史
git gc --aggressive

# 删除过期引用
git reflog expire --expire=now --all

# 压缩历史
git gc --prune=now

# 使用浅克隆
git clone --depth 1 repository-url
```

### 总结

通过本章的学习，你应该掌握了：

1. **历史基础**：理解 Git 历史的概念和重要性
2. **历史查看**：查看和格式化历史信息
3. **历史过滤**：按各种条件过滤历史
4. **历史操作**：搜索、比较和统计历史
5. **高级操作**：重写、清理和恢复历史
6. **历史可视化**：图形化显示历史信息
7. **实际应用**：在开发中的应用场景
8. **最佳实践**：历史管理的最佳方式
9. **问题解决**：解决历史相关的常见问题

Git 历史是版本控制的核心，掌握这些知识将帮助你更好地管理和追踪代码变化。