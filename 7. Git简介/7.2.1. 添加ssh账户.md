## 添加 SSH 账户

在 Git 开发过程中，SSH 账户配置是安全访问远程仓库的基础。本章将详细介绍如何在开发环境中配置和管理 SSH 账户。

### SSH 在开发中的作用

#### 1. 开发环境中的 SSH

在开发过程中，SSH 提供以下功能：

- **安全访问**：无需每次输入密码
- **自动化脚本**：支持 CI/CD 和自动化工具
- **多账户管理**：管理多个 Git 服务账户
- **密钥轮换**：定期更换密钥提高安全性

#### 2. 开发场景

- **本地开发**：从本地机器访问远程仓库
- **服务器部署**：从服务器访问代码仓库
- **CI/CD 管道**：自动化构建和部署
- **团队协作**：团队成员间的代码共享

### 开发环境配置

#### 1. 检查现有配置

```bash
# 检查现有 SSH 配置
ls -la ~/.ssh/

# 检查 SSH 代理状态
ssh-add -l

# 检查 SSH 配置
cat ~/.ssh/config

# 测试现有连接
ssh -T git@github.com
ssh -T git@gitlab.com
```

#### 2. 生成开发专用密钥

```bash
# 为开发环境生成专用密钥
ssh-keygen -t ed25519 -C "dev@example.com" -f ~/.ssh/id_ed25519_dev

# 为不同服务生成不同密钥
ssh-keygen -t ed25519 -C "github@example.com" -f ~/.ssh/id_ed25519_github
ssh-keygen -t ed25519 -C "gitlab@example.com" -f ~/.ssh/id_ed25519_gitlab
ssh-keygen -t ed25519 -C "bitbucket@example.com" -f ~/.ssh/id_ed25519_bitbucket

# 设置密钥权限
chmod 600 ~/.ssh/id_ed25519_*
chmod 644 ~/.ssh/id_ed25519_*.pub
```

#### 3. 配置 SSH 代理

```bash
# 启动 SSH 代理
eval "$(ssh-agent -s)"

# 添加密钥到代理
ssh-add ~/.ssh/id_ed25519_github
ssh-add ~/.ssh/id_ed25519_gitlab
ssh-add ~/.ssh/id_ed25519_bitbucket

# 查看已添加的密钥
ssh-add -l

# 设置密钥自动加载
cat >> ~/.bashrc << 'EOF'
# 启动 SSH 代理
if [ -z "$SSH_AUTH_SOCK" ]; then
    eval "$(ssh-agent -s)" > /dev/null
    ssh-add ~/.ssh/id_ed25519_github 2>/dev/null
    ssh-add ~/.ssh/id_ed25519_gitlab 2>/dev/null
    ssh-add ~/.ssh/id_ed25519_bitbucket 2>/dev/null
fi
EOF
```

### 多服务配置

#### 1. 配置 SSH 配置文件

```bash
# 创建或编辑 SSH 配置文件
nano ~/.ssh/config

# 添加以下配置
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_ed25519_github
    IdentitiesOnly yes
    AddKeysToAgent yes

Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile ~/.ssh/id_ed25519_gitlab
    IdentitiesOnly yes
    AddKeysToAgent yes

Host bitbucket.org
    HostName bitbucket.org
    User git
    IdentityFile ~/.ssh/id_ed25519_bitbucket
    IdentitiesOnly yes
    AddKeysToAgent yes

Host gitee.com
    HostName gitee.com
    User git
    IdentityFile ~/.ssh/id_ed25519_gitee
    IdentitiesOnly yes
    AddKeysToAgent yes

# 开发服务器配置
Host dev-server
    HostName dev.example.com
    User developer
    IdentityFile ~/.ssh/id_ed25519_dev
    Port 22
    ForwardAgent yes
```

#### 2. 测试多服务连接

```bash
# 测试 GitHub 连接
ssh -T git@github.com

# 测试 GitLab 连接
ssh -T git@gitlab.com

# 测试 Bitbucket 连接
ssh -T git@bitbucket.org

# 测试 Gitee 连接
ssh -T git@gitee.com

# 测试开发服务器连接
ssh -T dev-server
```

### 开发工具集成

#### 1. IDE 配置

```bash
# VS Code 配置
# 在 settings.json 中添加
{
    "git.path": "/usr/bin/git",
    "git.sshPath": "/usr/bin/ssh",
    "git.confirmSync": false,
    "git.autofetch": true
}

# IntelliJ IDEA 配置
# File -> Settings -> Version Control -> Git
# 设置 SSH executable 为 Native
```

#### 2. 命令行工具配置

```bash
# 配置 Git 使用 SSH
git config --global url."git@github.com:".insteadOf "https://github.com/"
git config --global url."git@gitlab.com:".insteadOf "https://gitlab.com/"

# 配置 Git 凭据助手
git config --global credential.helper cache
git config --global credential.helper 'cache --timeout=3600'
```

#### 3. 自动化脚本配置

```bash
# 创建 SSH 配置脚本
cat > scripts/setup-ssh.sh << 'EOF'
#!/bin/bash

echo "配置 SSH 密钥..."

# 检查 SSH 目录
if [ ! -d ~/.ssh ]; then
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
fi

# 启动 SSH 代理
eval "$(ssh-agent -s)"

# 添加密钥
for key in ~/.ssh/id_ed25519_*; do
    if [ -f "$key" ] && [ ! -f "${key}.pub" ]; then
        ssh-add "$key"
        echo "已添加密钥: $key"
    fi
done

# 测试连接
echo "测试连接..."
ssh -T git@github.com
ssh -T git@gitlab.com

echo "SSH 配置完成！"
EOF

chmod +x scripts/setup-ssh.sh
```

### 团队开发配置

#### 1. 团队密钥管理

```bash
# 创建团队密钥目录
mkdir -p ~/.ssh/team-keys

# 配置团队密钥
cat >> ~/.ssh/config << 'EOF'

# 团队项目配置
Host github-team
    HostName github.com
    User git
    IdentityFile ~/.ssh/team-keys/id_ed25519_team
    IdentitiesOnly yes

Host gitlab-team
    HostName gitlab.com
    User git
    IdentityFile ~/.ssh/team-keys/id_ed25519_team
    IdentitiesOnly yes
EOF
```

#### 2. 项目特定配置

```bash
# 为特定项目配置 SSH
cd /path/to/project

# 配置项目特定的远程仓库
git remote set-url origin git@github-team:team/project.git

# 或者使用项目特定的 SSH 配置
cat > .git/ssh_config << 'EOF'
Host github.com
    IdentityFile ~/.ssh/team-keys/id_ed25519_team
EOF

# 使用项目特定的 SSH 配置
GIT_SSH_COMMAND="ssh -F .git/ssh_config" git push origin main
```

### 安全最佳实践

#### 1. 密钥安全

```bash
# 设置正确的文件权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519_*
chmod 644 ~/.ssh/id_ed25519_*.pub
chmod 600 ~/.ssh/config

# 定期更换密钥
# 生成新密钥
ssh-keygen -t ed25519 -C "new-dev-key@example.com" -f ~/.ssh/id_ed25519_new

# 添加到远程服务
cat ~/.ssh/id_ed25519_new.pub

# 测试新密钥
ssh -i ~/.ssh/id_ed25519_new -T git@github.com

# 删除旧密钥
rm ~/.ssh/id_ed25519_old*
```

#### 2. 访问控制

```bash
# 限制 SSH 访问
cat >> ~/.ssh/config << 'EOF'

# 限制特定主机的访问
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_ed25519_github
    IdentitiesOnly yes
    # 只允许 Git 操作
    RemoteCommand git-shell
    RequestTTY no
EOF
```

#### 3. 监控和日志

```bash
# 启用 SSH 详细日志
ssh -vT git@github.com

# 配置 SSH 日志
cat >> ~/.ssh/config << 'EOF'

# 启用详细日志
Host *
    LogLevel DEBUG3
    UserKnownHostsFile ~/.ssh/known_hosts
    StrictHostKeyChecking yes
EOF
```

### 故障排除

#### 1. 连接问题

```bash
# 检查 SSH 连接
ssh -vT git@github.com

# 检查密钥是否正确加载
ssh-add -l

# 检查 SSH 配置
ssh -T -F ~/.ssh/config git@github.com

# 检查网络连接
ping github.com
telnet github.com 22
```

#### 2. 权限问题

```bash
# 检查文件权限
ls -la ~/.ssh/

# 修复权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519_*
chmod 644 ~/.ssh/id_ed25519_*.pub
chmod 600 ~/.ssh/config

# 检查 SSH 代理
ps aux | grep ssh-agent
```

#### 3. 配置问题

```bash
# 检查 SSH 配置语法
ssh -T -F ~/.ssh/config git@github.com

# 重新加载 SSH 配置
ssh-add -D
ssh-add ~/.ssh/id_ed25519_github

# 重启 SSH 代理
pkill ssh-agent
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_github
```

### 开发环境自动化

#### 1. 自动化配置脚本

```bash
# 创建完整的 SSH 配置脚本
cat > scripts/configure-ssh.sh << 'EOF'
#!/bin/bash

set -e

echo "配置开发环境 SSH..."

# 创建 SSH 目录
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# 生成密钥（如果不存在）
if [ ! -f ~/.ssh/id_ed25519_github ]; then
    echo "生成 GitHub 密钥..."
    ssh-keygen -t ed25519 -C "github@example.com" -f ~/.ssh/id_ed25519_github -N ""
fi

if [ ! -f ~/.ssh/id_ed25519_gitlab ]; then
    echo "生成 GitLab 密钥..."
    ssh-keygen -t ed25519 -C "gitlab@example.com" -f ~/.ssh/id_ed25519_gitlab -N ""
fi

# 设置权限
chmod 600 ~/.ssh/id_ed25519_*
chmod 644 ~/.ssh/id_ed25519_*.pub

# 配置 SSH 代理
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_github
ssh-add ~/.ssh/id_ed25519_gitlab

# 创建 SSH 配置
cat > ~/.ssh/config << 'SSH_CONFIG'
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_ed25519_github
    IdentitiesOnly yes
    AddKeysToAgent yes

Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile ~/.ssh/id_ed25519_gitlab
    IdentitiesOnly yes
    AddKeysToAgent yes
SSH_CONFIG

chmod 600 ~/.ssh/config

# 显示公钥
echo "GitHub 公钥:"
cat ~/.ssh/id_ed25519_github.pub
echo ""
echo "GitLab 公钥:"
cat ~/.ssh/id_ed25519_gitlab.pub

echo "SSH 配置完成！"
echo "请将上述公钥添加到相应的 Git 服务中。"
EOF

chmod +x scripts/configure-ssh.sh
```

#### 2. 环境检查脚本

```bash
# 创建环境检查脚本
cat > scripts/check-ssh.sh << 'EOF'
#!/bin/bash

echo "检查 SSH 配置..."

# 检查 SSH 目录
if [ -d ~/.ssh ]; then
    echo "✓ SSH 目录存在"
else
    echo "✗ SSH 目录不存在"
fi

# 检查密钥文件
for service in github gitlab bitbucket; do
    if [ -f ~/.ssh/id_ed25519_$service ]; then
        echo "✓ $service 密钥存在"
    else
        echo "✗ $service 密钥不存在"
    fi
done

# 检查 SSH 代理
if [ -n "$SSH_AUTH_SOCK" ]; then
    echo "✓ SSH 代理运行中"
    ssh-add -l
else
    echo "✗ SSH 代理未运行"
fi

# 测试连接
echo "测试连接..."
ssh -T git@github.com 2>&1 | grep -q "successfully authenticated" && echo "✓ GitHub 连接正常" || echo "✗ GitHub 连接失败"
ssh -T git@gitlab.com 2>&1 | grep -q "Welcome to GitLab" && echo "✓ GitLab 连接正常" || echo "✗ GitLab 连接失败"

echo "检查完成！"
EOF

chmod +x scripts/check-ssh.sh
```

### 总结

通过本章的学习，你应该掌握了：

1. **SSH 基础**：理解 SSH 在开发中的作用
2. **环境配置**：配置开发环境的 SSH
3. **多服务管理**：管理多个 Git 服务的 SSH 密钥
4. **工具集成**：将 SSH 集成到开发工具中
5. **团队协作**：在团队环境中配置 SSH
6. **安全实践**：确保 SSH 配置的安全性
7. **故障排除**：解决 SSH 配置中的常见问题
8. **自动化**：自动化 SSH 配置过程

SSH 配置是 Git 开发环境的基础，良好的 SSH 配置将大大提高开发效率和安全性。