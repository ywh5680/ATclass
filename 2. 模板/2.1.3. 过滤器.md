## 模板过滤器

Django模板过滤器用于修改变量的显示。使用管道符号(`|`)应用过滤器，可以链式使用多个过滤器。

### 过滤器语法

```html
{{ variable|filter }}
{{ variable|filter:"argument" }}
{{ variable|filter1|filter2:"arg" }}
```

### 字符串过滤器

#### 大小写转换

1. **lower**：转换为小写
```html
{{ name|lower }}
<!-- "Hello World" -> "hello world" -->
```

2. **upper**：转换为大写
```html
{{ name|upper }}
<!-- "hello world" -> "HELLO WORLD" -->
```

3. **title**：首字母大写
```html
{{ "hello world"|title }}
<!-- 输出: "Hello World" -->
```

4. **capfirst**：第一个字母大写
```html
{{ "hello world"|capfirst }}
<!-- 输出: "Hello world" -->
```

#### 文本处理

1. **truncatewords**：截断单词
```html
{{ content|truncatewords:30 }}
<!-- 保留前30个单词，后面用"..." -->
```

2. **truncatechars**：截断字符
```html
{{ content|truncatechars:100 }}
<!-- 保留前100个字符，后面用"..." -->
```

3. **truncatechars_html**：截断HTML字符
```html
{{ html_content|truncatechars_html:100 }}
<!-- 保留前100个字符，保持HTML标签完整 -->
```

4. **linebreaks**：将换行符转换为HTML标签
```html
{{ text|linebreaks }}
<!-- 将\n转换为<p>和<br>标签 -->
```

5. **linebreaksbr**：将换行符转换为`<br>`标签
```html
{{ text|linebreaksbr }}
<!-- 将\n转换为<br>标签 -->
```

6. **wordwrap**：按指定长度换行
```html
{{ text|wordwrap:30 }}
<!-- 每30个字符换行 -->
```

#### 文本清理

1. **striptags**：移除HTML标签
```html
{{ html_content|striptags }}
<!-- 移除所有HTML标签 -->
```

2. **escape**：转义HTML
```html
{{ user_input|escape }}
<!-- 转义HTML特殊字符 -->
```

3. **safe**：标记为安全HTML
```html
{{ html_content|safe }}
<!-- 注意：这可能有安全风险 -->
```

4. **force_escape**：强制转义
```html
{{ content|force_escape }}
<!-- 强制转义，即使内容被标记为safe -->
```

### 数字过滤器

#### 格式化

1. **floatformat**：格式化浮点数
```html
{{ price|floatformat:2 }}
<!-- 3.14159 -> 3.14 -->
{{ price|floatformat:0 }}
<!-- 3.14159 -> 3 -->
{{ price|floatformat:-2 }}
<!-- 3.14159 -> 3.14 -->
```

2. **intcomma**：添加千位分隔符
```html
{{ population|intcomma }}
<!-- 1234567 -> 1,234,567 -->
```

#### 数学运算

1. **add**：加法运算
```html
{{ value|add:"5" }}
{{ value|add:5 }}
```

2. **multiply**：乘法运算
```html
{{ value|multiply:"2" }}
{{ value|multiply:2 }}
```

3. **divisibleby**：检查是否可整除
```html
{% if value|divisibleby:"3" %}
    <p>Value is divisible by 3</p>
{% endif %}
```

### 日期和时间过滤器

#### 格式化

1. **date**：格式化日期
```html
{{ pub_date|date:"F j, Y" }}
<!-- 输出: January 1, 2023 -->
{{ pub_date|date:"Y-m-d" }}
<!-- 输出: 2023-01-01 -->
```

常用日期格式：
- `Y`：四位数年份
- `y`：两位数年份
- `m`：月份（01-12）
- `n`：月份（1-12）
- `d`：日期（01-31）
- `j`：日期（1-31）
- `F`：完整月份名
- `M`：缩写月份名
- `l`：完整星期名
- `D`：缩写星期名

2. **time**：格式化时间
```html
{{ pub_date|time:"H:i" }}
<!-- 输出: 14:30 -->
{{ pub_date|time:"g:i A" }}
<!-- 输出: 2:30 PM -->
```

3. **timesince**：距离现在的时间
```html
{{ pub_date|timesince }}
<!-- 输出: 2 days, 3 hours -->
{{ pub_date|timesince:"2023-01-01" }}
<!-- 输出: 2 days, 3 hours -->
```

4. **timeuntil**：距离指定时间的时间
```html
{{ deadline|timeuntil }}
<!-- 输出: 5 days, 2 hours -->
```

### 列表过滤器

#### 基本操作

1. **length**：获取长度
```html
{{ items|length }}
<!-- 输出列表长度 -->
```

2. **first**：获取第一个元素
```html
{{ items|first }}
<!-- 输出第一个元素 -->
```

3. **last**：获取最后一个元素
```html
{{ items|last }}
<!-- 输出最后一个元素 -->
```

4. **join**：连接列表元素
```html
{{ tags|join:", " }}
<!-- 用逗号和空格连接标签 -->
{{ tags|join:" | " }}
<!-- 用竖线连接标签 -->
```

5. **slice**：切片
```html
{{ items|slice:":3" }}
<!-- 获取前3个元素 -->
{{ items|slice:"1:4" }}
<!-- 获取索引1到3的元素 -->
{{ items|slice:"-3:" }}
<!-- 获取最后3个元素 -->
```

#### 排序和去重

1. **dictsort**：按字典键排序
```html
{{ users|dictsort:"name" }}
<!-- 按name字段排序 -->
```

2. **dictsortreversed**：按字典键倒序排序
```html
{{ users|dictsortreversed:"age" }}
<!-- 按age字段倒序排序 -->
```

3. **unordered_list**：生成无序列表
```html
{{ items|unordered_list }}
<!-- 生成HTML无序列表 -->
```

### 其他过滤器

#### 默认值

1. **default**：设置默认值
```html
{{ value|default:"nothing" }}
{{ value|default:"nothing" }}
<!-- 如果value为False或空，显示"nothing" -->
{{ value|default:"nothing" }}
<!-- 如果value为None，显示"nothing" -->
```

#### 布尔值转换

1. **yesno**：布尔值转换
```html
{{ is_active|yesno:"Yes,No" }}
<!-- True -> "Yes", False -> "No" -->
{{ is_active|yesno:"Yes,No,Maybe" }}
<!-- True -> "Yes", False -> "No", None -> "Maybe" -->
```

#### 复数形式

1. **pluralize**：复数形式
```html
{{ count }} item{{ count|pluralize }}
<!-- 1 item, 2 items -->
{{ count }} box{{ count|pluralize:"es" }}
<!-- 1 box, 2 boxes -->
```

#### 文件大小

1. **filesizeformat**：格式化文件大小
```html
{{ file_size|filesizeformat }}
<!-- 1024 -> "1.0 KB" -->
```

#### 随机选择

1. **random**：随机选择
```html
{{ items|random }}
<!-- 随机选择一个元素 -->
```

### 链式过滤器

可以链式使用多个过滤器：

```html
{{ content|truncatewords:30|linebreaks|safe }}
<!-- 先截断30个单词，再转换换行符，最后标记为安全HTML -->
```

### 过滤器参数

过滤器可以接受参数：

```html
{{ value|default:"nothing" }}
{{ content|truncatewords:30 }}
{{ price|floatformat:2 }}
{{ tags|join:", " }}
```

### 自定义过滤器

#### 创建自定义过滤器

在应用的`templatetags`目录下创建Python文件：

```python
# myapp/templatetags/custom_filters.py
from django import template

register = template.Library()

@register.filter
def cut(value, arg):
    """移除字符串中所有的arg"""
    return value.replace(arg, '')

@register.filter(name='lower')
def lower(value):
    """转换为小写"""
    return value.lower()

@register.filter
def add_class(field, css):
    """为表单字段添加CSS类"""
    return field.as_widget(attrs={"class": css})
```

#### 使用自定义过滤器

```html
{% load custom_filters %}

{{ "Hello World"|cut:"o" }}
<!-- 输出: "Hell Wrld" -->

{{ "HELLO"|lower }}
<!-- 输出: "hello" -->

{{ form.title|add_class:"form-control" }}
<!-- 为标题字段添加form-control类 -->
```

### 过滤器性能考虑

1. **避免重复计算**：将复杂计算放在视图中
2. **合理使用safe**：只在确定内容安全时使用
3. **缓存结果**：对于昂贵的操作考虑缓存

### 最佳实践

1. **选择合适的过滤器**：使用最合适的过滤器来完成特定任务
2. **链式使用**：合理链式使用多个过滤器
3. **安全性**：谨慎使用`safe`过滤器
4. **性能**：避免在过滤器中执行复杂操作
5. **可读性**：保持过滤器链的可读性

## 小结

- Django模板过滤器使用`|`语法
- 提供丰富的内置过滤器用于各种数据转换
- 支持链式使用和参数传递
- 可以创建自定义过滤器扩展功能
- 应该注意安全性和性能考虑
