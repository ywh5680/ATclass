## 验证码

验证码（CAPTCHA）是一种用于区分人类用户和自动化程序的安全机制。Django提供了多种方式来实现验证码功能，包括图片验证码、短信验证码、邮箱验证码等。

### 图片验证码

#### 1. 使用django-simple-captcha

首先安装django-simple-captcha：

```bash
pip install django-simple-captcha
```

#### 2. 配置设置

```python
# settings.py
INSTALLED_APPS = [
    # ... 其他应用
    'captcha',
]

# 验证码配置
CAPTCHA_LENGTH = 4  # 验证码长度
CAPTCHA_TIMEOUT = 1  # 验证码超时时间（分钟）
CAPTCHA_IMAGE_SIZE = (160, 50)  # 图片尺寸
CAPTCHA_FONT_SIZE = 28  # 字体大小
CAPTCHA_BACKGROUND_COLOR = '#ffffff'  # 背景色
CAPTCHA_FOREGROUND_COLOR = '#001a33'  # 前景色
CAPTCHA_NOISE_FUNCTIONS = ('captcha.helpers.noise_dots',)  # 噪声函数
```

#### 3. 配置URL

```python
# urls.py
from django.urls import path, include

urlpatterns = [
    # ... 其他URL
    path('captcha/', include('captcha.urls')),
]
```

#### 4. 在表单中使用

```python
# forms.py
from django import forms
from captcha.fields import CaptchaField

class ContactForm(forms.Form):
    name = forms.CharField(max_length=100, label='姓名')
    email = forms.EmailField(label='邮箱')
    message = forms.CharField(widget=forms.Textarea, label='消息')
    captcha = CaptchaField(label='验证码')
```

#### 5. 在模板中显示

```html
<!-- contact.html -->
{% extends "base.html" %}

{% block content %}
<div class="contact-form">
    <h2>联系我们</h2>
    
    <form method="post" novalidate>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="form-group">
            <label for="{{ form.name.id_for_label }}">{{ form.name.label }}:</label>
            {{ form.name }}
            {% if form.name.errors %}
                <div class="error-message">
                    {% for error in form.name.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.email.id_for_label }}">{{ form.email.label }}:</label>
            {{ form.email }}
            {% if form.email.errors %}
                <div class="error-message">
                    {% for error in form.email.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.message.id_for_label }}">{{ form.message.label }}:</label>
            {{ form.message }}
            {% if form.message.errors %}
                <div class="error-message">
                    {% for error in form.message.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.captcha.id_for_label }}">{{ form.captcha.label }}:</label>
            {{ form.captcha }}
            {% if form.captcha.errors %}
                <div class="error-message">
                    {% for error in form.captcha.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <button type="submit" class="btn btn-primary">发送消息</button>
    </form>
</div>
{% endblock %}
```

#### 6. 自定义验证码样式

```python
# forms.py
from captcha.fields import CaptchaField

class CustomCaptchaField(CaptchaField):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.widget.attrs.update({
            'class': 'form-control',
            'placeholder': '请输入验证码'
        })

class ContactForm(forms.Form):
    # ... 其他字段
    captcha = CustomCaptchaField(
        label='验证码',
        help_text='点击图片刷新验证码'
    )
```

### 短信验证码

#### 1. 创建短信验证码模型

```python
# models.py
from django.db import models
from django.utils import timezone
from datetime import timedelta
import random

class SMSVerification(models.Model):
    phone = models.CharField(max_length=11, verbose_name='手机号')
    code = models.CharField(max_length=6, verbose_name='验证码')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    is_used = models.BooleanField(default=False, verbose_name='是否已使用')
    
    class Meta:
        verbose_name = '短信验证码'
        verbose_name_plural = '短信验证码'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.phone}: {self.code}"
    
    def is_expired(self):
        """检查验证码是否过期（5分钟）"""
        return timezone.now() > self.created_at + timedelta(minutes=5)
    
    def is_valid(self):
        """检查验证码是否有效"""
        return not self.is_used and not self.is_expired()
    
    @classmethod
    def generate_code(cls):
        """生成6位数字验证码"""
        return ''.join([str(random.randint(0, 9)) for _ in range(6)])
    
    @classmethod
    def create_verification(cls, phone):
        """创建新的验证码"""
        # 删除旧的验证码
        cls.objects.filter(phone=phone).delete()
        
        # 创建新验证码
        code = cls.generate_code()
        return cls.objects.create(phone=phone, code=code)
```

#### 2. 创建短信发送服务

```python
# services.py
import requests
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class SMSService:
    """短信服务类"""
    
    def __init__(self):
        self.api_url = settings.SMS_API_URL
        self.api_key = settings.SMS_API_KEY
        self.api_secret = settings.SMS_API_SECRET
    
    def send_verification_code(self, phone, code):
        """发送验证码短信"""
        try:
            # 这里使用示例API，实际使用时需要替换为真实的短信服务商API
            data = {
                'phone': phone,
                'code': code,
                'template': 'verification',
                'api_key': self.api_key,
                'api_secret': self.api_secret
            }
            
            response = requests.post(self.api_url, json=data, timeout=10)
            
            if response.status_code == 200:
                result = response.json()
                if result.get('success'):
                    logger.info(f"短信发送成功: {phone}")
                    return True
                else:
                    logger.error(f"短信发送失败: {phone}, 错误: {result.get('message')}")
                    return False
            else:
                logger.error(f"短信API请求失败: {phone}, 状态码: {response.status_code}")
                return False
                
        except Exception as e:
            logger.error(f"短信发送异常: {phone}, 错误: {str(e)}")
            return False
    
    def send_success_message(self, phone, message):
        """发送成功通知短信"""
        # 实现发送通知短信的逻辑
        pass
```

#### 3. 创建验证码视图

```python
# views.py
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from django.views import View
from .models import SMSVerification
from .services import SMSService
import json

@method_decorator(csrf_exempt, name='dispatch')
class SendSMSView(View):
    """发送短信验证码"""
    
    def post(self, request):
        try:
            data = json.loads(request.body)
            phone = data.get('phone')
            
            if not phone:
                return JsonResponse({
                    'success': False,
                    'message': '手机号不能为空'
                }, status=400)
            
            # 验证手机号格式
            if not self.is_valid_phone(phone):
                return JsonResponse({
                    'success': False,
                    'message': '手机号格式不正确'
                }, status=400)
            
            # 检查发送频率限制
            if self.is_rate_limited(phone):
                return JsonResponse({
                    'success': False,
                    'message': '发送过于频繁，请稍后再试'
                }, status=429)
            
            # 创建验证码
            verification = SMSVerification.create_verification(phone)
            
            # 发送短信
            sms_service = SMSService()
            if sms_service.send_verification_code(phone, verification.code):
                return JsonResponse({
                    'success': True,
                    'message': '验证码发送成功'
                })
            else:
                return JsonResponse({
                    'success': False,
                    'message': '验证码发送失败，请重试'
                }, status=500)
                
        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'message': '请求数据格式错误'
            }, status=400)
        except Exception as e:
            return JsonResponse({
                'success': False,
                'message': '服务器内部错误'
            }, status=500)
    
    def is_valid_phone(self, phone):
        """验证手机号格式"""
        import re
        pattern = r'^1[3-9]\d{9}$'
        return re.match(pattern, phone) is not None
    
    def is_rate_limited(self, phone):
        """检查发送频率限制"""
        from django.utils import timezone
        from datetime import timedelta
        
        # 检查1分钟内是否已经发送过
        recent_verification = SMSVerification.objects.filter(
            phone=phone,
            created_at__gte=timezone.now() - timedelta(minutes=1)
        ).first()
        
        return recent_verification is not None

@method_decorator(csrf_exempt, name='dispatch')
class VerifySMSView(View):
    """验证短信验证码"""
    
    def post(self, request):
        try:
            data = json.loads(request.body)
            phone = data.get('phone')
            code = data.get('code')
            
            if not phone or not code:
                return JsonResponse({
                    'success': False,
                    'message': '手机号和验证码不能为空'
                }, status=400)
            
            # 查找验证码
            verification = SMSVerification.objects.filter(
                phone=phone,
                code=code
            ).first()
            
            if not verification:
                return JsonResponse({
                    'success': False,
                    'message': '验证码不存在'
                }, status=400)
            
            if not verification.is_valid():
                return JsonResponse({
                    'success': False,
                    'message': '验证码已过期或已使用'
                }, status=400)
            
            # 标记验证码为已使用
            verification.is_used = True
            verification.save()
            
            return JsonResponse({
                'success': True,
                'message': '验证码验证成功'
            })
            
        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'message': '请求数据格式错误'
            }, status=400)
        except Exception as e:
            return JsonResponse({
                'success': False,
                'message': '服务器内部错误'
            }, status=500)
```

#### 4. 在模板中使用短信验证码

```html
<!-- sms_verification.html -->
{% extends "base.html" %}

{% block content %}
<div class="sms-verification">
    <h2>手机号验证</h2>
    
    <form id="smsForm" novalidate>
        {% csrf_token %}
        
        <div class="form-group">
            <label for="phone">手机号:</label>
            <input type="tel" id="phone" name="phone" class="form-control" required>
            <div class="error-message" id="phoneError"></div>
        </div>
        
        <div class="form-group">
            <label for="smsCode">验证码:</label>
            <div class="input-group">
                <input type="text" id="smsCode" name="smsCode" class="form-control" required>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" id="sendSMSBtn">
                        发送验证码
                    </button>
                </div>
            </div>
            <div class="error-message" id="smsCodeError"></div>
        </div>
        
        <button type="submit" class="btn btn-primary">验证</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    const smsCodeInput = document.getElementById('smsCode');
    const sendSMSBtn = document.getElementById('sendSMSBtn');
    const smsForm = document.getElementById('smsForm');
    
    let countdown = 0;
    let countdownTimer = null;
    
    // 发送验证码
    sendSMSBtn.addEventListener('click', function() {
        const phone = phoneInput.value.trim();
        
        if (!phone) {
            showError('phoneError', '请输入手机号');
            return;
        }
        
        if (!isValidPhone(phone)) {
            showError('phoneError', '手机号格式不正确');
            return;
        }
        
        // 发送验证码请求
        fetch('/api/send-sms/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ phone: phone })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('验证码发送成功');
                startCountdown();
            } else {
                showError('phoneError', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('phoneError', '发送失败，请重试');
        });
    });
    
    // 表单提交
    smsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const phone = phoneInput.value.trim();
        const code = smsCodeInput.value.trim();
        
        // 清除之前的错误
        clearErrors();
        
        // 验证输入
        if (!phone) {
            showError('phoneError', '请输入手机号');
            return;
        }
        
        if (!code) {
            showError('smsCodeError', '请输入验证码');
            return;
        }
        
        // 验证验证码
        fetch('/api/verify-sms/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                phone: phone, 
                code: code 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('验证成功！');
                // 可以重定向到下一个页面
                setTimeout(() => {
                    window.location.href = '/next-page/';
                }, 1500);
            } else {
                showError('smsCodeError', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('smsCodeError', '验证失败，请重试');
        });
    });
    
    // 倒计时功能
    function startCountdown() {
        countdown = 60;
        sendSMSBtn.disabled = true;
        
        countdownTimer = setInterval(() => {
            countdown--;
            sendSMSBtn.textContent = `${countdown}秒后重试`;
            
            if (countdown <= 0) {
                clearInterval(countdownTimer);
                sendSMSBtn.disabled = false;
                sendSMSBtn.textContent = '发送验证码';
            }
        }, 1000);
    }
    
    // 验证手机号格式
    function isValidPhone(phone) {
        const pattern = /^1[3-9]\d{9}$/;
        return pattern.test(phone);
    }
    
    // 显示错误信息
    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
    
    // 显示成功信息
    function showSuccess(message) {
        // 可以使用toast或其他方式显示成功信息
        alert(message);
    }
    
    // 清除错误信息
    function clearErrors() {
        document.querySelectorAll('.error-message').forEach(element => {
            element.style.display = 'none';
        });
    }
    
    // 获取CSRF令牌
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
```

### 邮箱验证码

#### 1. 创建邮箱验证码模型

```python
# models.py
class EmailVerification(models.Model):
    email = models.EmailField(verbose_name='邮箱')
    code = models.CharField(max_length=6, verbose_name='验证码')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    is_used = models.BooleanField(default=False, verbose_name='是否已使用')
    
    class Meta:
        verbose_name = '邮箱验证码'
        verbose_name_plural = '邮箱验证码'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.email}: {self.code}"
    
    def is_expired(self):
        """检查验证码是否过期（10分钟）"""
        return timezone.now() > self.created_at + timedelta(minutes=10)
    
    def is_valid(self):
        """检查验证码是否有效"""
        return not self.is_used and not self.is_expired()
    
    @classmethod
    def generate_code(cls):
        """生成6位数字验证码"""
        return ''.join([str(random.randint(0, 9)) for _ in range(6)])
    
    @classmethod
    def create_verification(cls, email):
        """创建新的验证码"""
        # 删除旧的验证码
        cls.objects.filter(email=email).delete()
        
        # 创建新验证码
        code = cls.generate_code()
        return cls.objects.create(email=email, code=code)
```

#### 2. 创建邮件发送服务

```python
# services.py
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings

class EmailService:
    """邮件服务类"""
    
    def send_verification_code(self, email, code):
        """发送验证码邮件"""
        try:
            subject = '邮箱验证码'
            message = f'您的验证码是: {code}，有效期10分钟。'
            from_email = settings.DEFAULT_FROM_EMAIL
            recipient_list = [email]
            
            # 发送纯文本邮件
            send_mail(
                subject=subject,
                message=message,
                from_email=from_email,
                recipient_list=recipient_list,
                fail_silently=False,
            )
            
            return True
            
        except Exception as e:
            logger.error(f"邮件发送失败: {email}, 错误: {str(e)}")
            return False
    
    def send_verification_email_template(self, email, code):
        """使用模板发送验证码邮件"""
        try:
            subject = '邮箱验证码'
            from_email = settings.DEFAULT_FROM_EMAIL
            recipient_list = [email]
            
            # 渲染邮件模板
            html_message = render_to_string('emails/verification_code.html', {
                'code': code,
                'expire_minutes': 10
            })
            
            # 发送HTML邮件
            send_mail(
                subject=subject,
                message=f'您的验证码是: {code}，有效期10分钟。',
                from_email=from_email,
                recipient_list=recipient_list,
                html_message=html_message,
                fail_silently=False,
            )
            
            return True
            
        except Exception as e:
            logger.error(f"邮件发送失败: {email}, 错误: {str(e)}")
            return False
```

#### 3. 邮件模板

```html
<!-- templates/emails/verification_code.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>邮箱验证码</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .content {
            background-color: #f8f9fa;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .verification-code {
            background-color: #007bff;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            letter-spacing: 5px;
        }
        .footer {
            background-color: #6c757d;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 0 0 5px 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>邮箱验证码</h1>
    </div>
    
    <div class="content">
        <p>您好！</p>
        
        <p>您正在验证邮箱，请输入以下验证码：</p>
        
        <div class="verification-code">
            {{ code }}
        </div>
        
        <p><strong>注意事项：</strong></p>
        <ul>
            <li>验证码有效期为 {{ expire_minutes }} 分钟</li>
            <li>请勿将验证码泄露给他人</li>
            <li>如非本人操作，请忽略此邮件</li>
        </ul>
        
        <p>如果验证码无法使用，请重新获取。</p>
    </div>
    
    <div class="footer">
        <p>此邮件由系统自动发送，请勿回复</p>
        <p>&copy; 2023 我的网站. 保留所有权利.</p>
    </div>
</body>
</html>
```

### 自定义验证码

#### 1. 创建自定义验证码字段

```python
# fields.py
from django import forms
from django.core.exceptions import ValidationError
from .models import SMSVerification, EmailVerification

class SMSVerificationField(forms.CharField):
    """短信验证码字段"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.widget.attrs.update({
            'class': 'form-control',
            'placeholder': '请输入短信验证码'
        })
    
    def clean(self, value):
        value = super().clean(value)
        if not value:
            raise ValidationError('请输入短信验证码')
        
        # 这里可以添加额外的验证逻辑
        return value

class EmailVerificationField(forms.CharField):
    """邮箱验证码字段"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.widget.attrs.update({
            'class': 'form-control',
            'placeholder': '请输入邮箱验证码'
        })
    
    def clean(self, value):
        value = super().clean(value)
        if not value:
            raise ValidationError('请输入邮箱验证码')
        
        return value
```

#### 2. 在表单中使用

```python
# forms.py
from .fields import SMSVerificationField, EmailVerificationField

class UserRegistrationForm(forms.Form):
    username = forms.CharField(max_length=150, label='用户名')
    email = forms.EmailField(label='邮箱')
    password1 = forms.CharField(widget=forms.PasswordInput, label='密码')
    password2 = forms.CharField(widget=forms.PasswordInput, label='确认密码')
    
    # 验证码字段
    sms_code = SMSVerificationField(label='短信验证码')
    email_code = EmailVerificationField(label='邮箱验证码')
    
    def clean(self):
        cleaned_data = super().clean()
        password1 = cleaned_data.get('password1')
        password2 = cleaned_data.get('password2')
        
        if password1 and password2 and password1 != password2:
            raise ValidationError('两次输入的密码不一致')
        
        return cleaned_data
```

### 验证码管理

#### 1. 管理界面

```python
# admin.py
from django.contrib import admin
from .models import SMSVerification, EmailVerification

@admin.register(SMSVerification)
class SMSVerificationAdmin(admin.ModelAdmin):
    list_display = ['phone', 'code', 'created_at', 'is_used', 'is_expired']
    list_filter = ['is_used', 'created_at']
    search_fields = ['phone']
    readonly_fields = ['created_at']
    
    def is_expired(self, obj):
        return obj.is_expired()
    is_expired.boolean = True
    is_expired.short_description = '是否过期'

@admin.register(EmailVerification)
class EmailVerificationAdmin(admin.ModelAdmin):
    list_display = ['email', 'code', 'created_at', 'is_used', 'is_expired']
    list_filter = ['is_used', 'created_at']
    search_fields = ['email']
    readonly_fields = ['created_at']
    
    def is_expired(self, obj):
        return obj.is_expired()
    is_expired.boolean = True
    is_expired.short_description = '是否过期'
```

#### 2. 清理过期验证码

```python
# management/commands/cleanup_expired_codes.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
from verification.models import SMSVerification, EmailVerification

class Command(BaseCommand):
    help = '清理过期的验证码'
    
    def handle(self, *args, **options):
        # 清理短信验证码（5分钟过期）
        sms_count = SMSVerification.objects.filter(
            created_at__lt=timezone.now() - timedelta(minutes=5)
        ).delete()[0]
        
        # 清理邮箱验证码（10分钟过期）
        email_count = EmailVerification.objects.filter(
            created_at__lt=timezone.now() - timedelta(minutes=10)
        ).delete()[0]
        
        self.stdout.write(
            self.style.SUCCESS(
                f'成功清理 {sms_count} 个过期短信验证码和 {email_count} 个过期邮箱验证码'
            )
        )
```

### 最佳实践

#### 1. 安全性考虑

- 验证码长度至少6位
- 设置合理的过期时间
- 限制发送频率
- 记录验证码使用日志

#### 2. 用户体验

- 提供倒计时功能
- 清晰的错误提示
- 响应式设计
- 无障碍访问支持

#### 3. 性能优化

- 使用缓存存储验证码
- 异步发送验证码
- 定期清理过期数据
- 监控验证码服务状态

## 小结

- Django提供了多种验证码实现方式
- 图片验证码适合防止机器人攻击
- 短信和邮箱验证码适合用户身份验证
- 合理设置验证码参数和过期时间
- 注意验证码的安全性和用户体验
- 定期清理过期验证码数据