## CSRF保护

CSRF（Cross-Site Request Forgery，跨站请求伪造）是一种常见的Web安全攻击。Django内置了强大的CSRF保护机制，通过CSRF令牌来防止恶意网站利用用户的身份执行未授权的操作。

### 什么是CSRF攻击

CSRF攻击是指攻击者诱导已认证的用户在不知情的情况下执行恶意操作。例如：

1. 用户登录了银行网站
2. 用户访问了恶意网站
3. 恶意网站向银行网站发送请求（如转账）
4. 银行网站认为这是用户的合法请求

### Django的CSRF保护机制

#### 1. 中间件保护

Django通过`django.middleware.csrf.CsrfViewMiddleware`中间件提供CSRF保护：

```python
# settings.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',  # CSRF保护中间件
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
```

#### 2. CSRF令牌

每个表单都会包含一个唯一的CSRF令牌，服务器验证这个令牌来确保请求的合法性。

### 在模板中使用CSRF保护

#### 1. 基本表单保护

```html
<!-- 使用csrf_token标签保护表单 -->
<form method="post" action="{% url 'contact' %}">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="name">姓名:</label>
        <input type="text" id="name" name="name" required>
    </div>
    
    <div class="form-group">
        <label for="email">邮箱:</label>
        <input type="email" id="email" name="email" required>
    </div>
    
    <div class="form-group">
        <label for="message">消息:</label>
        <textarea id="message" name="message" rows="5" required></textarea>
    </div>
    
    <button type="submit">发送消息</button>
</form>
```

#### 2. 渲染后的HTML

`{% csrf_token %}`标签会渲染为一个隐藏的input字段：

```html
<form method="post" action="/contact/">
    <input type="hidden" name="csrfmiddlewaretoken" value="abc123...">
    
    <div class="form-group">
        <label for="name">姓名:</label>
        <input type="text" id="name" name="name" required>
    </div>
    
    <!-- 其他表单字段 -->
    
    <button type="submit">发送消息</button>
</form>
```

#### 3. 多种HTTP方法

```html
<!-- POST请求 -->
<form method="post">
    {% csrf_token %}
    <!-- 表单内容 -->
</form>

<!-- PUT请求 -->
<form method="post">
    {% csrf_token %}
    <input type="hidden" name="_method" value="PUT">
    <!-- 表单内容 -->
</form>

<!-- DELETE请求 -->
<form method="post">
    {% csrf_token %}
    <input type="hidden" name="_method" value="DELETE">
    <!-- 表单内容 -->
</form>
```

### AJAX请求的CSRF保护

#### 1. 获取CSRF令牌

```javascript
// 从cookie中获取CSRF令牌
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 获取CSRF令牌
const csrftoken = getCookie('csrftoken');
```

#### 2. 设置AJAX请求头

```javascript
// 使用fetch API
fetch('/api/submit/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
    },
    body: JSON.stringify({
        name: 'John Doe',
        email: 'john@example.com',
        message: 'Hello World'
    })
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error:', error));

// 使用jQuery
$.ajax({
    url: '/api/submit/',
    type: 'POST',
    data: {
        name: 'John Doe',
        email: 'john@example.com',
        message: 'Hello World'
    },
    headers: {
        'X-CSRFToken': csrftoken
    },
    success: function(data) {
        console.log('Success:', data);
    },
    error: function(xhr, status, error) {
        console.error('Error:', error);
    }
});
```

#### 3. 全局AJAX设置

```javascript
// 为所有AJAX请求自动添加CSRF令牌
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});
```

#### 4. 使用Django的CSRF视图

```python
# views.py
from django.views.decorators.csrf import ensure_csrf_cookie
from django.http import JsonResponse

@ensure_csrf_cookie
def get_csrf_token(request):
    """返回CSRF令牌的视图"""
    return JsonResponse({'csrfToken': get_token(request)})
```

```javascript
// 从API获取CSRF令牌
fetch('/api/csrf-token/')
.then(response => response.json())
.then(data => {
    const csrftoken = data.csrfToken;
    // 使用令牌进行后续请求
});
```

### 视图中的CSRF处理

#### 1. 基本视图

```python
# views.py
from django.shortcuts import render, redirect
from django.contrib import messages
from .forms import ContactForm

def contact_view(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            # 处理表单数据
            form.save()
            messages.success(request, '消息发送成功！')
            return redirect('contact_success')
    else:
        form = ContactForm()
    
    return render(request, 'contact.html', {'form': form})
```

#### 2. 类视图

```python
# views.py
from django.views.generic import CreateView
from django.urls import reverse_lazy
from .models import Contact
from .forms import ContactForm

class ContactView(CreateView):
    model = Contact
    form_class = ContactForm
    template_name = 'contact.html'
    success_url = reverse_lazy('contact_success')
    
    def form_valid(self, form):
        messages.success(self.request, '消息发送成功！')
        return super().form_valid(form)
```

#### 3. API视图

```python
# views.py
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from django.views import View
from django.http import JsonResponse
import json

# 注意：通常不建议豁免CSRF保护
@method_decorator(csrf_exempt, name='dispatch')
class ContactAPIView(View):
    def post(self, request):
        try:
            data = json.loads(request.body)
            # 处理数据
            return JsonResponse({'status': 'success'})
        except json.JSONDecodeError:
            return JsonResponse({'status': 'error', 'message': 'Invalid JSON'}, status=400)
```

### CSRF豁免

#### 1. 视图级别豁免

```python
# views.py
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from django.views import View

# 函数视图豁免
@csrf_exempt
def api_view(request):
    # 这个视图不需要CSRF保护
    pass

# 类视图豁免
@method_decorator(csrf_exempt, name='dispatch')
class APIView(View):
    def post(self, request):
        # 这个视图不需要CSRF保护
        pass
```

#### 2. 何时豁免CSRF

**可以豁免的情况：**
- 公开的API接口
- 第三方服务回调
- 不需要用户认证的接口

**不应该豁免的情况：**
- 用户登录/注册表单
- 用户数据修改操作
- 需要用户认证的操作

### 自定义CSRF处理

#### 1. 自定义CSRF失败视图

```python
# views.py
from django.views.decorators.csrf import csrf_failure
from django.http import HttpResponse

@csrf_failure
def custom_csrf_failure(request, reason=""):
    """自定义CSRF失败处理"""
    return HttpResponse(
        f'<h1>CSRF验证失败</h1><p>原因: {reason}</p>',
        status=403
    )
```

```python
# settings.py
CSRF_FAILURE_VIEW = 'myapp.views.custom_csrf_failure'
```

#### 2. 自定义CSRF令牌生成

```python
# utils.py
from django.middleware.csrf import get_token
from django.utils.crypto import constant_time_compare

def generate_custom_csrf_token(request):
    """生成自定义CSRF令牌"""
    token = get_token(request)
    # 可以添加额外的验证逻辑
    return token

def verify_custom_csrf_token(request, token):
    """验证自定义CSRF令牌"""
    csrf_token = request.META.get('CSRF_COOKIE')
    return constant_time_compare(token, csrf_token)
```

### 实际应用示例

#### 1. 用户注册表单

```html
<!-- registration/register.html -->
{% extends "base.html" %}

{% block content %}
<div class="registration-form">
    <h2>用户注册</h2>
    
    <form method="post" novalidate>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="form-group">
            <label for="{{ form.username.id_for_label }}">用户名:</label>
            {{ form.username }}
            {% if form.username.errors %}
                <div class="error-message">
                    {% for error in form.username.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.email.id_for_label }}">邮箱:</label>
            {{ form.email }}
            {% if form.email.errors %}
                <div class="error-message">
                    {% for error in form.email.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.password1.id_for_label }}">密码:</label>
            {{ form.password1 }}
            {% if form.password1.errors %}
                <div class="error-message">
                    {% for error in form.password1.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.password2.id_for_label }}">确认密码:</label>
            {{ form.password2 }}
            {% if form.password2.errors %}
                <div class="error-message">
                    {% for error in form.password2.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <button type="submit" class="btn btn-primary">注册</button>
    </form>
</div>
{% endblock %}
```

#### 2. 评论提交表单

```html
<!-- blog/post_detail.html -->
{% extends "base.html" %}

{% block content %}
<article class="post">
    <h1>{{ post.title }}</h1>
    <div class="content">{{ post.content|safe }}</div>
</article>

<!-- 评论表单 -->
<section class="comments">
    <h3>发表评论</h3>
    
    {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' post.id %}" class="comment-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="comment_text">评论内容:</label>
                <textarea name="text" id="comment_text" rows="4" required></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">提交评论</button>
        </form>
    {% else %}
        <p>请<a href="{% url 'login' %}">登录</a>后发表评论。</p>
    {% endif %}
    
    <!-- 评论列表 -->
    <div class="comment-list">
        {% for comment in post.comments.all %}
            <div class="comment">
                <div class="comment-meta">
                    <span class="author">{{ comment.author.username }}</span>
                    <span class="date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="comment-content">{{ comment.text }}</div>
            </div>
        {% empty %}
            <p>暂无评论。</p>
        {% endfor %}
    </div>
</section>
{% endblock %}
```

#### 3. AJAX评论提交

```javascript
// 评论提交的JavaScript代码
document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.querySelector('.comment-form');
    const commentList = document.querySelector('.comment-list');
    
    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const commentText = formData.get('text');
        
        // 获取CSRF令牌
        const csrftoken = getCookie('csrftoken');
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: commentText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 添加新评论到列表
                const commentHtml = `
                    <div class="comment">
                        <div class="comment-meta">
                            <span class="author">${data.comment.author}</span>
                            <span class="date">${data.comment.created_at}</span>
                        </div>
                        <div class="comment-content">${data.comment.text}</div>
                    </div>
                `;
                commentList.insertAdjacentHTML('afterbegin', commentHtml);
                
                // 清空表单
                this.reset();
                
                // 显示成功消息
                showMessage('评论提交成功！', 'success');
            } else {
                showMessage('评论提交失败：' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('评论提交失败，请重试。', 'error');
        });
    });
});

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.textContent = message;
    
    document.querySelector('.comments').insertBefore(messageDiv, document.querySelector('.comment-form'));
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}
```

### 测试CSRF保护

#### 1. 测试CSRF令牌验证

```python
# tests.py
from django.test import TestCase, Client
from django.urls import reverse

class CSRFTestCase(TestCase):
    def setUp(self):
        self.client = Client()
    
    def test_csrf_token_in_form(self):
        """测试表单是否包含CSRF令牌"""
        response = self.client.get(reverse('contact'))
        self.assertContains(response, 'csrfmiddlewaretoken')
    
    def test_csrf_protection(self):
        """测试CSRF保护是否工作"""
        # 不带CSRF令牌的POST请求应该被拒绝
        response = self.client.post(reverse('contact'), {
            'name': 'Test User',
            'email': 'test@example.com',
            'message': 'Test message'
        })
        self.assertEqual(response.status_code, 403)
    
    def test_valid_csrf_token(self):
        """测试有效的CSRF令牌"""
        # 获取CSRF令牌
        response = self.client.get(reverse('contact'))
        csrf_token = response.context['csrf_token']
        
        # 使用有效令牌的POST请求
        response = self.client.post(reverse('contact'), {
            'csrfmiddlewaretoken': csrf_token,
            'name': 'Test User',
            'email': 'test@example.com',
            'message': 'Test message'
        })
        self.assertNotEqual(response.status_code, 403)
```

### 最佳实践

#### 1. 始终使用CSRF保护

- 对所有修改数据的请求使用CSRF保护
- 不要轻易豁免CSRF保护
- 定期检查CSRF配置

#### 2. 正确处理AJAX请求

- 为AJAX请求添加CSRF令牌
- 使用全局AJAX设置
- 测试AJAX请求的CSRF保护

#### 3. 安全配置

```python
# settings.py
# CSRF配置
CSRF_COOKIE_SECURE = True  # 在生产环境中使用HTTPS
CSRF_COOKIE_HTTPONLY = False  # 允许JavaScript访问
CSRF_COOKIE_AGE = 31449600  # 1年
CSRF_COOKIE_NAME = 'csrftoken'
CSRF_HEADER_NAME = 'HTTP_X_CSRFTOKEN'
```

#### 4. 错误处理

```python
# views.py
from django.views.decorators.csrf import csrf_failure
from django.http import JsonResponse

@csrf_failure
def api_csrf_failure(request, reason=""):
    """API的CSRF失败处理"""
    return JsonResponse({
        'error': 'CSRF verification failed',
        'reason': reason
    }, status=403)
```

## 小结

- Django的CSRF保护是防止跨站请求伪造攻击的重要机制
- 使用`{% csrf_token %}`标签保护所有表单
- AJAX请求需要手动添加CSRF令牌到请求头
- 不要轻易豁免CSRF保护，只在必要时使用
- 定期测试CSRF保护是否正常工作
- 遵循安全最佳实践，确保Web应用的安全性
